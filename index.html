
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RONDOLOG - SISTEMA DE GEST√ÉO DE FROTAS</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- Chart.js para gr√°ficos do dashboard -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- üî• SCRIPTS DO FIREBASE - VERS√ÉO 8.10.1 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* üé® VARI√ÅVEIS DE CORES - MODO CLARO (PADR√ÉO) */
    :root {
      /* Cores Corporativas */
      --primary-black: #000000;
      --primary-red: #ff0000;
      --red-light: #ff6b6b;
      --green: #00c853;
      --green-dark: #009624;
      --yellow: #ffc107;
      --yellow-dark: #ff8f00;
      --orange: #ff9800;
      --orange-dark: #f57c00;
      --blue: #2196f3;
      --blue-dark: #1976d2;
      --purple: #9c27b0;
      --purple-dark: #7b1fa2;
      
      /* Sistema de Cores */
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --text-primary: #2d3748;
      --text-secondary: #718096;
      --border-color: #e2e8f0;
      --gray-light: #f8f9fa;
      --gray-text: #718096;
      --gray-dark: #2d3748;
      
      /* Layout */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 20px;
      --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
      --shadow-medium: 0 8px 25px rgba(0,0,0,0.15);
      --shadow-heavy: 0 20px 60px rgba(0, 0, 0, 0.3);
      --transition: all 0.3s ease;
    }

    /* üé® MODO ESCURO */
    .dark-mode {
      --bg-primary: #1a1d23;
      --bg-secondary: #252a33;
      --text-primary: #e2e8f0;
      --text-secondary: #a0aec0;
      --border-color: #3a4556;
      
      /* Cores adaptadas para modo escuro */
      --green: #48bb78;
      --green-dark: #38a169;
      --yellow: #ecc94b;
      --yellow-dark: #d69e2e;
      --orange: #ed8936;
      --orange-dark: #dd6b20;
      --red-light: #fc8181;
      --blue: #63b3ed;
      --blue-dark: #4299e1;
      --purple: #b794f4;
      --purple-dark: #9f7aea;
      --gray-light: #2d3748;
      --gray-text: #a0aec0;
      --gray-dark: #1a202c;
      
      --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.3);
      --shadow-medium: 0 8px 25px rgba(0,0,0,0.4);
      --shadow-heavy: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    /* üî§ TIPOGRAFIA */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* üìê LAYOUT ESTRUTURAL */
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--text-primary);
      transition: var(--transition);
    }

    .container {
      max-width: 95%;
      margin: 0 auto;
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-heavy);
      overflow: hidden;
      border: 1px solid var(--border-color);
      min-height: 90vh;
      transition: var(--transition);
    }

    /* üé≠ HEADER */
    .header {
      background: linear-gradient(135deg, var(--primary-black) 0%, #2d2d2d 100%);
      color: white;
      padding: 25px 30px;
      position: relative;
      border-bottom: 4px solid var(--primary-red);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-titles h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .header-subtitle {
      font-size: 16px;
      opacity: 0.9;
      font-weight: 400;
    }

    /* ============================================ */
    /* üé™ MENU DE ABAS - NOVO (AP√ìS O HEADER) */
    /* ============================================ */
    .tab-menu {
      display: flex;
      background: var(--bg-secondary);
      border-bottom: 2px solid var(--primary-red);
      padding: 0;
      overflow-x: auto;
    }

    .tab-btn {
      padding: 15px 25px;
      background: transparent;
      border: none;
      border-right: 1px solid var(--border-color);
      color: var(--text-primary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab-btn:hover {
      background: rgba(255, 0, 0, 0.1);
    }

    .tab-btn.active {
      background: var(--primary-red);
      color: white;
      border-bottom: 3px solid white;
    }

    /* üì¶ CONTE√öDO DAS ABAS */
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    /* ============================================ */

    /* üé≠ CONTROLES */
    .controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* üé≠ BOT√ïES */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn-primary {
      background: var(--primary-red);
      color: white;
    }

    .btn-primary:hover {
      background: #cc0000;
      box-shadow: 0 4px 12px rgba(255, 0, 0, 0.3);
    }

    .btn-success {
      background: var(--green);
      color: white;
    }

    .btn-success:hover {
      background: var(--green-dark);
      box-shadow: 0 4px 12px rgba(0, 200, 83, 0.3);
    }

    .btn-warning {
      background: var(--yellow);
      color: black;
    }

    .btn-warning:hover {
      background: var(--yellow-dark);
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
    }

    .btn-info {
      background: var(--blue);
      color: white;
    }

    .btn-info:hover {
      background: var(--blue-dark);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    }

    .btn-danger {
      background: var(--primary-red);
      color: white;
    }

    .btn-danger:hover {
      background: #cc0000;
      box-shadow: 0 4px 12px rgba(255, 0, 0, 0.3);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid white;
      color: white;
    }

    .btn-outline:hover {
      background: white;
      color: var(--primary-black);
    }

    .btn-dark-mode {
      background: transparent;
      border: 2px solid white;
      color: white;
      padding: 10px 15px;
    }

    .btn-dark-mode:hover {
      background: white;
      color: var(--primary-black);
    }

    /* üìä CARDS DE RESUMO */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      padding: 20px 30px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    .summary-card {
      background: var(--bg-primary);
      padding: 20px;
      border-radius: var(--radius-md);
      text-align: center;
      box-shadow: var(--shadow-light);
      border-left: 4px solid var(--primary-red);
      transition: var(--transition);
    }

    .summary-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .summary-card.valid {
      border-left-color: var(--green);
    }

    .summary-card.warning {
      border-left-color: var(--yellow);
    }

    .summary-card.expired {
      border-left-color: var(--primary-red);
    }

    .summary-card.total {
      border-left-color: var(--gray-dark);
    }

    .summary-card.blue {
      border-left-color: var(--blue);
    }

    .summary-card.purple {
      border-left-color: var(--purple);
    }

    .summary-card.orange {
      border-left-color: var(--orange);
    }

    .card-number {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
      color: var(--text-primary);
    }

    .card-label {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card-subtitle {
      font-size: 10px;
      color: var(--gray-text);
      margin-top: 4px;
    }

    /* üîç FILTROS */
    .filters {
      padding: 20px 30px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .filter-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .filter-select, .filter-input {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background: var(--bg-primary);
      color: var(--text-primary);
      min-width: 150px;
      cursor: pointer;
      transition: var(--transition);
    }

    .filter-select:focus, .filter-input:focus {
      outline: none;
      border-color: var(--primary-red);
    }

    /* üìä DROPDOWN DE EXPORTA√á√ÉO */
    .export-dropdown {
      position: relative;
      display: inline-block;
      z-index: 1001;
    }

    .export-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--bg-primary);
      min-width: 220px;
      box-shadow: var(--shadow-medium);
      border-radius: var(--radius-sm);
      z-index: 1000;
      margin-top: 5px;
      border: 1px solid var(--border-color);
    }

    .export-dropdown.active .export-menu {
      display: block;
    }

    .export-option {
      padding: 12px 16px;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      transition: background 0.2s;
      color: var(--text-primary);
    }

    .export-option:hover {
      background: var(--bg-secondary);
    }

    /* üíæ STATUS DE SALVAMENTO */
    .save-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--green);
      color: white;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      animation: pulse 2s infinite;
    }

    .save-status.saving {
      background: var(--yellow);
      color: black;
    }

    .save-status.error {
      background: var(--primary-red);
      color: white;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    /* üìã TABELA */
    .table-container {
      overflow-x: auto;
      padding: 20px;
      max-height: 50vh;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--bg-primary);
      min-width: 800px;
    }

    thead th {
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 12px 8px;
      border-bottom: 3px solid var(--border-color);
      text-align: left;
      position: sticky;
      top: 0;
      z-index: 10;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s ease;
    }

    thead th:hover {
      background: var(--border-color);
    }

    thead th.sorted-asc::after {
      content: " ‚Üë";
      font-weight: bold;
    }

    thead th.sorted-desc::after {
      content: " ‚Üì";
      font-weight: bold;
    }

    tbody td {
      padding: 12px 8px;
      border-bottom: 1px solid var(--border-color);
      font-size: 13px;
      color: var(--text-primary);
      transition: background 0.2s ease;
      vertical-align: middle;
    }

    tbody tr {
      border-left: 3px solid transparent;
      transition: var(--transition);
    }

    tbody tr:hover {
      background: var(--bg-secondary);
    }

    /* üéØ ESTADOS VISUAIS - LINHAS - CORRIGIDO ‚úÖ */
    tbody tr.pending {
      background: #fff3cd !important;
      border-left: 3px solid var(--yellow);
    }

    tbody tr.pending:hover {
      background: #ffeaa7 !important;
    }

    tbody tr.expired {
      background: #f8d7da !important;
      border-left: 3px solid var(--primary-red);
    }

    tbody tr.expired:hover {
      background: #f1b0b7 !important;
    }

    /* üé≠ STATUS BADGES */
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
      display: inline-block;
      min-width: 80px;
    }

    .status-valid {
      background: var(--green);
      color: white;
    }

    .status-invalid {
      background: var(--primary-red);
      color: white;
    }

    .status-expired {
      background: var(--yellow);
      color: black;
    }

    /* üé™ PLACAS DE VE√çCULO */
    .vehicle-plate {
      font-family: 'Courier New', monospace;
      font-weight: 700;
      font-size: 14px;
      color: var(--text-primary);
    }

    /* üé≠ BOT√ïES DE A√á√ÉO */
    .action-buttons {
      display: flex;
      gap: 5px;
    }

    .btn-edit {
      padding: 6px 12px;
      background: var(--yellow);
      color: black;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: var(--transition);
    }

    .btn-edit:hover {
      background: var(--yellow-dark);
      transform: translateY(-1px);
    }

    .btn-delete {
      padding: 6px 12px;
      background: var(--primary-red);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: var(--transition);
    }

    .btn-delete:hover {
      background: #cc0000;
      transform: translateY(-1px);
    }

    /* üé≠ MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: var(--bg-primary);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid var(--border-color);
    }

    .modal h3 {
      margin-bottom: 20px;
      color: var(--text-primary);
      font-size: 20px;
      border-bottom: 2px solid var(--primary-red);
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
    }

    .form-control {
      width: 100%;
      padding: 10px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 14px;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: var(--transition);
    }

    .form-control:focus {
      border-color: var(--primary-red);
      outline: none;
    }

    .form-control.error {
      border-color: var(--primary-red);
    }

    .error-message {
      color: var(--primary-red);
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 25px;
    }

    .btn-cancel {
      background: var(--gray-text);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }

    .btn-cancel:hover {
      background: var(--gray-dark);
    }

    /* üé≠ FOOTER */
    .footer {
      background: var(--bg-secondary);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid var(--border-color);
      flex-wrap: wrap;
      gap: 15px;
    }

    .footer-info {
      color: var(--text-secondary);
      font-size: 12px;
    }

    .stats {
      display: flex;
      gap: 15px;
      font-size: 12px;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--bg-primary);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
    }

    /* üîÑ MODO ESCURO ESPEC√çFICO */
    .dark-mode tbody tr {
      border-left: 3px solid transparent;
      transition: var(--transition);
    }

    .dark-mode tbody tr:hover {
      background: #2d3748 !important;
    }

    .dark-mode tbody tr.pending {
      background: #2d2a22 !important;
      border-left-color: var(--yellow);
    }

    .dark-mode tbody tr.pending:hover {
      background: #3d382a !important;
    }

    .dark-mode tbody tr.expired {
      background: #2d2526 !important;
      border-left-color: var(--red-light);
    }

    .dark-mode tbody tr.expired:hover {
      background: #3d2c2e !important;
    }

    .dark-mode .status-badge {
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .dark-mode .status-valid {
      background: var(--green);
      color: #1a202c;
    }

    .dark-mode .status-invalid {
      background: #e53e3e;
      color: white;
    }

    .dark-mode .status-expired {
      background: var(--yellow);
      color: #1a202c;
    }

    .dark-mode thead th {
      background: #2d3748;
      color: var(--text-primary);
      border-bottom: 2px solid #4a5568;
    }

    .dark-mode .summary-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .dark-mode .filters {
      background: #252a33;
      border-bottom: 1px solid #3a4556;
    }

    .dark-mode .btn-edit {
      background: var(--orange);
      color: #1a202c;
    }

    .dark-mode .btn-edit:hover {
      background: var(--orange-dark);
    }

    .dark-mode .btn-delete {
      background: #e53e3e;
      color: white;
    }

    .dark-mode .btn-delete:hover {
      background: #c53030;
    }

    /* üîó üîÑ NOVO ESTILO PARA SINCRONIZA√á√ÉO FIREBASE - MELHORADO */
    .sync-section {
      background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
      padding: 15px 30px;
      border-bottom: 3px solid var(--primary-red);
      margin-top: -1px;
      position: relative;
      overflow: hidden;
    }

    .sync-section::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
      background-size: 20px 20px;
      opacity: 0.3;
      z-index: 0;
    }

    .sync-header {
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 1;
    }

    .sync-header h4 {
      margin: 0;
      color: white;
      font-weight: 600;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sync-controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      position: relative;
      z-index: 1;
    }

    .sync-info {
      margin-top: 10px;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-md);
      font-size: 13px;
      color: rgba(255, 255, 255, 0.9);
      border-left: 3px solid var(--primary-red);
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 1;
    }

    /* Status online/offline */
    .online-status {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      position: relative;
      z-index: 1;
      backdrop-filter: blur(5px);
    }

    .online-status.online {
      background: rgba(0, 200, 83, 0.2);
      color: #00c853;
      border: 1px solid rgba(0, 200, 83, 0.4);
    }

    .online-status.offline {
      background: rgba(255, 0, 0, 0.1);
      color: #ff6b6b;
      border: 1px solid rgba(255, 0, 0, 0.3);
    }

    .online-dot, .offline-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }

    .online-dot {
      background: #00c853;
      animation: pulse 1.5s infinite;
      box-shadow: 0 0 10px #00c853;
    }

    .offline-dot {
      background: #ff6b6b;
    }

    /* üîÑ ESTILOS PARA LOADING STATES */
    .btn.loading {
      opacity: 0.7;
      cursor: not-allowed;
      position: relative;
    }

    .btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .btn-warning.loading::after {
      border-top-color: black;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Anima√ß√µes */
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    /* Modo escuro ajustes */
    .dark-mode .sync-section {
      background: linear-gradient(135deg, #0d47a1 0%, #1565c0 100%);
    }

    .dark-mode .sync-info {
      background: rgba(255, 255, 255, 0.05);
    }

    /* ‚öôÔ∏è √çCONE SETTINGS FLUTUANTE - DESIGN MELHORADO */
    .settings-icon {
      position: fixed;
      top: 25px;
      right: 25px;
      width: 45px;
      height: 45px;
      background: linear-gradient(135deg, var(--primary-red) 0%, #cc0000 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      cursor: pointer;
      z-index: 1000;
      box-shadow: var(--shadow-heavy);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 2px solid white;
      animation: float 3s ease-in-out infinite;
    }

    .settings-icon:hover {
      transform: rotate(90deg) scale(1.1);
      box-shadow: 0 8px 25px rgba(255, 0, 0, 0.4);
      background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    /* üé™ MENU SETTINGS */
    .settings-menu {
      position: fixed;
      top: 85px;
      right: 25px;
      width: 380px;
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-heavy);
      z-index: 1001;
      display: none;
      border: 1px solid var(--border-color);
      max-height: 80vh;
      overflow-y: auto;
    }

    .settings-header {
      padding: 20px 25px;
      background: linear-gradient(135deg, var(--primary-black) 0%, #2d2d2d 100%);
      border-bottom: 3px solid var(--primary-red);
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .settings-header h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn-close {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: white;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
    }

    .btn-close:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }

    .settings-section {
      padding: 20px 25px;
      border-bottom: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .settings-section:hover {
      background: var(--bg-secondary);
    }

    .settings-section:last-child {
      border-bottom: none;
    }

    .settings-section h5 {
      margin: 0 0 15px 0;
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .btn-settings {
      padding: 12px 15px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      cursor: pointer;
      text-align: left;
      font-size: 13px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
    }

    .btn-settings:hover {
      background: var(--primary-red);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 0, 0, 0.2);
      border-color: var(--primary-red);
    }

    .btn-settings.small {
      padding: 8px 12px;
      font-size: 12px;
    }

    .drop-area-settings {
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-sm);
      padding: 25px 20px;
      text-align: center;
      margin: 15px 0;
      cursor: pointer;
      transition: var(--transition);
      background: var(--bg-secondary);
    }

    .drop-area-settings:hover {
      border-color: var(--primary-red);
      background: rgba(255, 0, 0, 0.05);
    }

    /* üìä ESTILOS PARA ESTAT√çSTICAS DETALHADAS NO SETTINGS */
    .stats-mini {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
      font-size: 12px;
    }

    .stats-mini div {
      padding: 10px 12px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid var(--border-color);
    }

    .stats-mini span {
      font-weight: 700;
      color: var(--primary-red);
      font-size: 14px;
    }

    /* Grid para estat√≠sticas detalhadas */
    .stats-grid-detailed {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 15px;
    }

    .stat-item-detailed {
      padding: 12px 15px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary-red);
    }

    .sync-info-mini {
      padding: 10px 12px;
      background: rgba(0, 200, 83, 0.1);
      border-radius: var(--radius-sm);
      font-size: 11px;
      color: var(--green);
      border: 1px solid rgba(0, 200, 83, 0.2);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sync-info-mini.offline {
      background: rgba(255, 0, 0, 0.1);
      color: var(--primary-red);
      border-color: rgba(255, 0, 0, 0.2);
    }

    /* üîÑ ANIMA√á√ÉO DE ENTRADA */
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .settings-menu.show {
      display: block;
      animation: slideInRight 0.3s ease;
    }

    /* üåô DARK MODE SETTINGS */
    .dark-mode .settings-menu {
      background: var(--bg-secondary);
      border-color: #3a4556;
    }

    .dark-mode .settings-header {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    }

    .dark-mode .btn-settings {
      background: #2d3748;
      border-color: #3a4556;
    }

    .dark-mode .btn-settings:hover {
      background: var(--primary-red);
    }

    .dark-mode .drop-area-settings {
      background: #2d3748;
      border-color: #3a4556;
    }

    .dark-mode .drop-area-settings:hover {
      background: rgba(255, 0, 0, 0.1);
    }

    .dark-mode .stats-mini div {
      background: #2d3748;
      border-color: #3a4556;
    }

    .dark-mode .stat-item-detailed {
      background: #2d3748;
      border-color: #3a4556;
    }

    /* üîê ESTILOS PARA MODAL DE LOGIN */
    .login-modal {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
    }

    .login-modal .modal-content {
      max-width: 380px;
      text-align: center;
    }

    .login-logo {
      font-size: 48px;
      margin-bottom: 15px;
      display: block;
    }

    .login-title {
      font-size: 24px;
      margin-bottom: 5px;
      color: var(--primary-black);
    }

    .login-subtitle {
      color: var(--text-secondary);
      margin-bottom: 25px;
      font-size: 14px;
    }

    .login-form {
      margin-top: 20px;
    }

    .login-btn {
      width: 100%;
      margin-top: 15px;
      padding: 12px;
      font-size: 15px;
      font-weight: 600;
    }

    .login-error {
      color: var(--primary-red);
      font-size: 12px;
      margin-top: 10px;
      display: none;
    }

    /* üîÑ BOT√ÉO DE LOGOUT NO HEADER */
    .btn-logout {
      background: transparent;
      border: 2px solid #ff6b6b;
      color: #ff6b6b;
      padding: 10px 15px;
    }

    .btn-logout:hover {
      background: #ff6b6b;
      color: white;
    }

    /* üëë ESTILOS PARA ADMIN SECTION */
    .admin-badge {
      padding: 4px 8px;
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      color: #000;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* üë• ESTILOS PARA MODAL DE GERENCIAMENTO DE USU√ÅRIOS */
    .user-manager-table {
      width: 100%;
      font-size: 12px;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    .user-manager-table th {
      background: var(--bg-secondary);
      padding: 8px;
      text-align: left;
      border-bottom: 2px solid var(--border-color);
      font-weight: 600;
      color: var(--text-secondary);
    }

    .user-manager-table td {
      padding: 8px;
      border-bottom: 1px solid var(--border-color);
      vertical-align: middle;
    }

    .user-manager-table tr:hover {
      background: var(--bg-secondary);
    }

    .role-select {
      padding: 4px 8px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 11px;
      cursor: pointer;
    }

    .role-select:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* üìä ESTILOS PARA DASHBOARD DE AN√ÅLISE */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      padding: 20px 30px;
    }

    .chart-container {
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      padding: 20px;
      box-shadow: var(--shadow-light);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .chart-container:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-color);
    }

    .chart-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chart-actions {
      display: flex;
      gap: 5px;
    }

    .chart-btn {
      padding: 4px 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 11px;
      cursor: pointer;
      color: var(--text-secondary);
      transition: var(--transition);
    }

    .chart-btn:hover {
      background: var(--primary-red);
      color: white;
      border-color: var(--primary-red);
    }

    .chart-wrapper {
      position: relative;
      height: 300px;
      width: 100%;
    }

    .metric-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      padding: 20px 30px;
    }

    .metric-card {
      background: var(--bg-primary);
      padding: 15px;
      border-radius: var(--radius-md);
      text-align: center;
      box-shadow: var(--shadow-light);
      transition: var(--transition);
      border-top: 4px solid var(--primary-red);
    }

    .metric-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-medium);
    }

    .metric-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-red);
      margin-bottom: 5px;
    }

    .metric-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-change {
      font-size: 10px;
      margin-top: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .metric-change.positive {
      color: var(--green);
    }

    .metric-change.negative {
      color: var(--primary-red);
    }

    .dashboard-filters {
      padding: 15px 30px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .time-filter {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .time-btn {
      padding: 6px 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 12px;
      cursor: pointer;
      color: var(--text-secondary);
      transition: var(--transition);
    }

    .time-btn.active {
      background: var(--primary-red);
      color: white;
      border-color: var(--primary-red);
    }

    .time-btn:hover:not(.active) {
      background: var(--border-color);
    }

    .top-list {
      margin-top: 15px;
    }

    .top-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
      font-size: 12px;
    }

    .top-name {
      font-weight: 500;
      color: var(--text-primary);
    }

    .top-count {
      font-weight: 600;
      color: var(--primary-red);
    }

    .dashboard-section-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 25px 30px 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Role badge styles */
    .role-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: inline-block;
      margin-left: 8px;
    }
    
    .role-badge.admin {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      color: #000;
    }
    
    .role-badge.manager {
      background: linear-gradient(135deg, #2196f3 0%, #64b5f6 100%);
      color: white;
    }
    
    .role-badge.operator {
      background: linear-gradient(135deg, #4caf50 0%, #81c784 100%);
      color: white;
    }
    
    .role-badge.viewer {
      background: linear-gradient(135deg, #9e9e9e 0%, #bdbdbd 100%);
      color: white;
    }

    /* üì± RESPONSIVIDADE */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        text-align: center;
      }
      
      .controls {
        justify-content: center;
      }
      
      .summary-cards {
        grid-template-columns: 1fr 1fr;
        padding: 15px 20px;
      }
      
      .filters {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filter-select, .filter-input {
        min-width: 100%;
      }
      
      .footer {
        flex-direction: column;
        text-align: center;
      }
      
      .sync-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .sync-controls .btn {
        width: 100%;
        justify-content: center;
      }
      
      .online-status {
        justify-content: center;
      }
      
      .settings-menu {
        width: 90%;
        right: 5%;
        left: 5%;
        top: 85px;
      }
      
      .settings-icon {
        top: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        font-size: 20px;
      }
      
      .settings-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid-detailed {
        grid-template-columns: 1fr;
      }
      
      .controls {
        gap: 10px;
      }
      
      .btn {
        padding: 10px 15px;
        font-size: 13px;
      }
      
      /* Responsividade para abas */
      .tab-menu {
        flex-wrap: wrap;
      }
      
      .tab-btn {
        padding: 12px 15px;
        font-size: 13px;
        flex: 1;
        min-width: 120px;
        text-align: center;
        justify-content: center;
      }
      
      /* Dashboard responsivo */
      .dashboard-grid {
        grid-template-columns: 1fr;
        padding: 15px 20px;
        gap: 15px;
      }
      
      .chart-wrapper {
        height: 250px;
      }
      
      .dashboard-filters {
        flex-direction: column;
        align-items: stretch;
      }
      
      .time-filter {
        flex-wrap: wrap;
      }
      
      .metric-grid {
        grid-template-columns: repeat(2, 1fr);
        padding: 15px 20px;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- üîê MODAL DE LOGIN (INICIALMENTE VIS√çVEL) -->
  <div class="modal login-modal" id="loginModal" style="display: flex;">
    <div class="modal-content">
      <div class="login-logo">üöõ</div>
      <h3 class="login-title">RONDOLOG - Sistema de Gest√£o</h3>
      <p class="login-subtitle">Acesso restrito √† equipe autorizada</p>
      
      <form id="loginForm" class="login-form">
        <div class="form-group">
          <label>Email</label>
          <input type="email" class="form-control" id="loginEmail" 
                 placeholder="seu@email.com" required>
        </div>
        
        <div class="form-group">
          <label>Senha</label>
          <input type="password" class="form-control" id="loginPassword" 
                 placeholder="Digite sua senha" required>
        </div>
        
        <div class="login-error" id="loginError">
          ‚ùå Email ou senha incorretos
        </div>
        
        <button type="submit" class="btn btn-primary login-btn">
          üîë Entrar no Sistema
        </button>
        
        <!-- Link para reset de senha -->
        <div style="margin-top: 15px; text-align: center;">
          <a href="#" onclick="resetPassword()" style="font-size: 12px; color: var(--blue);">
            üîê Esqueci minha senha
          </a>
        </div>
        
        <div style="margin-top: 20px; font-size: 11px; color: var(--text-secondary);">
          <p>‚ö†Ô∏è Dados sens√≠veis - Use com responsabilidade</p>
          <p>Todas as a√ß√µes s√£o monitoradas e registradas</p>
        </div>
      </form>
    </div>
  </div>

  <!-- ‚öôÔ∏è √çCONE SETTINGS FLUTUANTE - DESIGN MELHORADO -->
  <div class="settings-icon" id="settingsIcon" style="display: none;">
    ‚öôÔ∏è
  </div>

  <!-- üé™ MENU SETTINGS (inicialmente escondido) -->
  <div class="settings-menu" id="settingsMenu">
    <div class="settings-header">
      <h4>‚öôÔ∏è RONDOLOG - Configura√ß√µes Avan√ßadas</h4>
      <button class="btn-close" id="btnCloseSettings">√ó</button>
    </div>
    
    <!-- üëë SE√á√ÉO ADMINISTRATIVA (S√ì VIS√çVEL PARA ADMIN) -->
    <div class="settings-section" id="adminSection" style="display: none;">
      <h5>üëë Administra√ß√£o Avan√ßada</h5>
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
        <span class="admin-badge">ADMIN</span>
        <span style="font-size: 11px; color: var(--text-secondary);">
          Controle total do sistema
        </span>
      </div>
      
      <div class="settings-grid">
        <button class="btn-settings" onclick="openUserManager()">
          üë• Gerenciar Usu√°rios
        </button>
        <button class="btn-settings" onclick="openRoleManager()">
          üé≠ Gerenciar Perfis
        </button>
        <button class="btn-settings" onclick="viewAuditLogs()">
          üìã Logs de Auditoria
        </button>
        <button class="btn-settings" onclick="systemDiagnostics()">
          üîß Diagn√≥stico do Sistema
        </button>
      </div>
    </div>
    
    <!-- üì§ IMPORTAR DADOS -->
    <div class="settings-section">
      <h5>üì§ Importar Dados</h5>
      <div class="drop-area-settings" id="dropAreaSettings">
        <div style="font-size: 40px; margin: 10px 0;">üìÅ</div>
        <p>Arraste planilha aqui ou clique para selecionar</p>
        <p><small>.xlsx, .xls, .csv</small></p>
        <input type="file" id="fileInputSettings" accept=".xlsx,.xls,.csv" hidden>
      </div>
      <div id="importProgress" style="display:none; margin-top:10px;">
        <div style="width:0%; height:6px; background:#ff0000; border-radius:3px;" id="importProgressBar"></div>
        <small id="importProgressText">Processando...</small>
      </div>
    </div>
    
    <!-- üì• EXPORTAR DADOS -->
    <div class="settings-section">
      <h5>üì• Exportar Dados</h5>
      <div class="settings-grid">
        <button class="btn-settings" onclick="exportPDF()">
          üìã PDF - Relat√≥rio Atual
        </button>
        <button class="btn-settings" onclick="exportXLS()">
          üìä Excel - Dados Atuais
        </button>
        <button class="btn-settings" onclick="exportBackupJSON()">
          üíæ Backup Completo (JSON)
        </button>
        <button class="btn-settings" onclick="showNotification('Exporta√ß√£o em desenvolvimento', 'info')">
          üóÇÔ∏è Exportar para CSV
        </button>
      </div>
    </div>
    
    <!-- üìä ESTAT√çSTICAS DETALHADAS (MOVIDO PARA AQUI) -->
    <div class="settings-section">
      <h5>üìä Estat√≠sticas Detalhadas</h5>
      <div class="stats-grid-detailed">
        <div class="stat-item-detailed">
          <span class="stat-label">Firebase:</span>
          <span class="stat-value" id="detailedFirebase">0</span>
        </div>
        <div class="stat-item-detailed">
          <span class="stat-label">Local:</span>
          <span class="stat-value" id="detailedLocal">0</span>
        </div>
        <div class="stat-item-detailed">
          <span class="stat-label">Sincroniza√ß√µes:</span>
          <span class="stat-value" id="detailedSyncs">0</span>
        </div>
        <div class="stat-item-detailed">
          <span class="stat-label">√öltima Sinc:</span>
          <span class="stat-value" id="detailedLastSync">-</span>
        </div>
        <div class="stat-item-detailed">
          <span class="stat-label">Carregamentos:</span>
          <span class="stat-value" id="detailedLoads">0</span>
        </div>
        <div class="stat-item-detailed">
          <span class="stat-label">Logs Ativos:</span>
          <span class="stat-value" id="detailedLogs">0</span>
        </div>
      </div>
      <button class="btn-settings" onclick="showDetailedStats()">
        üìà Ver Relat√≥rio Completo
      </button>
    </div>
    
    <!-- üî• SINCRONIZA√á√ÉO FIREBASE -->
    <div class="settings-section">
      <h5>üî• Sincroniza√ß√£o Firebase</h5>
      <div id="syncStatusMini" class="sync-info-mini">
        <span class="online-dot" style="width: 8px; height: 8px;"></span>
        Online - Conectado
      </div>
      <div class="settings-grid">
        <button class="btn-settings" onclick="testFirebaseConnection()">
          üîå Testar Conex√£o
        </button>
        <button class="btn-settings" onclick="loadInitialData()">
          ‚¨áÔ∏è Carregar do Firebase
        </button>
        <button class="btn-settings" onclick="saveToFirebase()">
          üíæ Salvar no Firebase
        </button>
        <button class="btn-settings" onclick="diagnoseFirebaseData()">
          üîç Diagnosticar
        </button>
      </div>
    </div>
    
    <!-- ============================================ -->
    <!-- üîç DIAGN√ìSTICO COMPLETO DO SISTEMA (NOVA) -->
    <!-- ============================================ -->
    <div class="settings-section">
      <h5>üîç Diagn√≥stico do Sistema</h5>
      
      <div id="diagnosticoResultado" style="margin-bottom: 15px;">
        <!-- Resultados ser√£o exibidos aqui -->
      </div>
      
      <div class="settings-grid">
        <button class="btn-settings" onclick="executarDiagnosticoCompleto()">
          üîç Executar Diagn√≥stico
        </button>
        <button class="btn-settings" onclick="exportarRelatorioDiagnostico()">
          üìã Exportar Relat√≥rio
        </button>
        <button class="btn-settings" onclick="verLogsSistema()">
          üìù Ver Logs do Sistema
        </button>
        <button class="btn-settings" onclick="repararProblemasAutomaticamente()" 
                style="background:#00c853; color:white; border-color:#00c853;">
          ‚ö° Reparar Automaticamente
        </button>
      </div>
    </div>
    <!-- ============================================ -->
    
    <!-- üîß FERRAMENTAS DE MANUTEN√á√ÉO -->
    <div class="settings-section">
      <h5>üîß Ferramentas de Manuten√ß√£o</h5>
      <div class="settings-grid">
        <button class="btn-settings" onclick="checkDataIntegrity()">
          ‚úÖ Verificar Integridade
        </button>
        <button class="btn-settings" onclick="analyzeCountDiscrepancy()">
          üî¢ Analisar Contagem
        </button>
        <button class="btn-settings" onclick="recoverAllData()" style="background:#dc3545; color:white; border-color:#dc3545;">
          üîÑ Recuperar Tudo
        </button>
        <button class="btn-settings" onclick="clearAllData()" style="background:#6c757d; color:white; border-color:#6c757d;">
          üóëÔ∏è Limpar Dados
        </button>
      </div>
    </div>
    
    <!-- üóëÔ∏è REMOVER DUPLICADOS -->
    <div class="settings-section">
      <h5>üóëÔ∏è Remover Duplicados</h5>
      <div class="settings-grid">
        <button class="btn-settings" onclick="removeDuplicates()">
          üîç Encontrar Duplicados
        </button>
        <button class="btn-settings" onclick="removeDuplicatesKeepLatest()" style="background:#dc3545; color:white; border-color:#dc3545;">
          üóëÔ∏è Remover (Manter Mais Recente)
        </button>
      </div>
      <div id="duplicatesInfo" style="margin-top:10px; font-size:11px; color:var(--text-secondary);">
        <!-- Informa√ß√µes sobre duplicados ser√£o exibidas aqui -->
      </div>
    </div>

    <!-- ============================================ -->
    <!-- üö® NOVA SE√á√ÉO: N√ÉO CONFORMIDADES -->
    <!-- ============================================ -->
    <div class="settings-section">
      <h5>üö® N√£o Conformidades</h5>
      <div class="settings-grid">
        <button class="btn-settings" onclick="ncImportarPlanilha()">
          üìÅ Importar Planilha NC
        </button>
        <button class="btn-settings" onclick="ncConfigurarAlertas()">
          üîî Configurar Alertas
        </button>
        <button class="btn-settings" onclick="ncLimparHistorico()" style="background:#6c757d; color:white; border-color:#6c757d;">
          üóëÔ∏è Limpar Hist√≥rico
        </button>
        <button class="btn-settings" onclick="ncVerEstatisticas()">
          üìä Ver Estat√≠sticas
        </button>
      </div>
      <div id="ncStatus" style="margin-top:10px; font-size:11px; color:var(--text-secondary);">
        <!-- Status das NCs ser√° exibido aqui -->
      </div>
    </div>
    <!-- ============================================ -->
    
    <!-- üìä ESTAT√çSTICAS DO SISTEMA -->
    <div class="settings-section">
      <h5>üìä Estat√≠sticas do Sistema</h5>
      <div class="stats-mini">
        <div>Total Ve√≠culos: <span id="settingsVehicleCount">0</span></div>
        <div>Status OK: <span id="settingsOkCount">0</span></div>
        <div>Pendentes: <span id="settingsPendingCount">0</span></div>
        <div>Vencidos: <span id="settingsExpiredCount">0</span></div>
        <div>Firebase: <span id="settingsFirebaseCount">0</span></div>
        <div>Sincroniza√ß√µes: <span id="settingsSyncCount">0</span></div>
      </div>
    </div>
    
    <!-- ‚öôÔ∏è CONFIGURA√á√ïES DO SISTEMA -->
    <div class="settings-section">
      <h5>‚öôÔ∏è Configura√ß√µes do Sistema</h5>
      <div class="settings-grid">
        <button class="btn-settings" onclick="toggleDarkMode()">
          üåô Alternar Modo Escuro
        </button>
        <button class="btn-settings" onclick="resetFilters()">
          üîÑ Resetar Filtros
        </button>
        <button class="btn-settings" onclick="clearLogs()">
          üìù Limpar Logs
        </button>
      </div>
    </div>
    
    <!-- ‚ÑπÔ∏è INFORMA√á√ïES DO SISTEMA -->
    <div class="settings-section">
      <h5>‚ÑπÔ∏è Informa√ß√µes do Sistema</h5>
      <div style="font-size: 11px; color: var(--text-secondary); line-height: 1.4;">
        <p><strong>RONDOLOG v15.2</strong> - Sistema de Gest√£o de Frotas</p>
        <p>100% Integrado com Firebase</p>
        <p>Usu√°rio: <span id="currentUserInfo">N√£o autenticado</span></p>
        <p>√öltima atualiza√ß√£o: <span id="lastUpdateInfo">Carregando...</span></p>
        <p>Total de registros processados: <span id="totalProcessedInfo">0</span></p>
      </div>
    </div>
  </div>

  <!-- üë• MODAL DE GERENCIAMENTO DE USU√ÅRIOS -->
  <div class="modal" id="userManagerModal">
    <div class="modal-content" style="max-width: 700px;">
      <h3>üë• Gerenciamento de Usu√°rios</h3>
      
      <!-- Lista de Usu√°rios -->
      <div class="user-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
        <table class="user-manager-table">
          <thead>
            <tr>
              <th>Email</th>
              <th>Nome</th>
              <th>Perfil</th>
              <th>Status</th>
              <th>√öltimo Acesso</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="userListBody">
            <!-- Usu√°rios ser√£o carregados aqui -->
          </tbody>
        </table>
      </div>
      
      <!-- Adicionar Novo Usu√°rio -->
      <div style="border-top: 1px solid var(--border-color); padding-top: 20px;">
        <h4>‚ûï Novo Usu√°rio</h4>
        <div class="form-group">
          <label>Nome do Usu√°rio</label>
          <input type="text" class="form-control" id="newUserName" placeholder="ex: Maria Silva">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" class="form-control" id="newUserEmail" placeholder="ex: maria.silva@empresa.com">
        </div>
        <div class="form-group">
          <label>Senha Tempor√°ria</label>
          <input type="password" class="form-control" id="newPassword" placeholder="Senha inicial">
          <button type="button" class="btn btn-sm" onclick="generatePassword()" 
                  style="margin-top: 5px; font-size: 11px;">
            üîê Gerar Senha Aleat√≥ria
          </button>
        </div>
        <div class="form-group">
          <label>Perfil de Acesso</label>
          <select class="form-control" id="newUserRole">
            <option value="VIEWER">Visualizador (Somente leitura)</option>
            <option value="OPERATOR">Operador (Edi√ß√£o b√°sica)</option>
            <option value="MANAGER">Gerente (Edi√ß√£o completa)</option>
            <option value="ADMIN">Administrador (Acesso total)</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-cancel" onclick="closeUserManager()">Cancelar</button>
          <button class="btn btn-success" onclick="createNewUser()">
            ‚úÖ Criar Usu√°rio
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- üé≠ CONTAINER PRINCIPAL (INICIALMENTE ESCONDIDO) -->
  <div class="container" id="mainContainer" style="display: none;">
    <!-- üé≠ HEADER -->
    <div class="header">
      <div class="header-content">
        <div class="header-titles">
          <h1>RONDOLOG - SISTEMA DE GEST√ÉO DE FROTAS</h1>
          <div class="header-subtitle">Sincroniza√ß√£o em tempo real com Firebase</div>
        </div>
        
        <div class="controls">
          <!-- ‚úÖ BOT√ÉO "NOVO VE√çCULO" NO HEADER -->
          <button class="btn btn-success" onclick="openAddModal()" 
                  style="background: var(--green); border: 2px solid white;">
            <span>‚ûï</span> Novo Ve√≠culo
          </button>
          
          <!-- üîç BOT√ÉO DIAGN√ìSTICO R√ÅPIDO -->
          <button class="btn btn-info" onclick="executarDiagnosticoRapido()" 
                  style="background: #2196f3; border: 2px solid white; margin-left: 10px;">
            <span>üîç</span> Diagn√≥stico
          </button>
          
          <!-- Badge de Role do Usu√°rio -->
          <div id="userRoleBadge" class="role-badge viewer" style="display: none;"></div>
          
          <button class="btn btn-dark-mode" id="btnDarkMode">
            <span>üåô</span> Modo Escuro
          </button>
          
          <!-- üîê BOT√ÉO DE LOGOUT -->
          <button class="btn btn-logout" id="btnLogout">
            <span>üö™</span> Sair
          </button>
          
          <!-- üíæ STATUS DE SALVAMENTO -->
          <div class="save-status" id="saveStatus">
            <span>üíæ</span> Dados carregados
          </div>
        </div>
      </div>
    </div>
    
    <!-- ============================================ -->
    <!-- üé™ MENU DE ABAS - NOVO -->
    <!-- ============================================ -->
    <div class="tab-menu" id="tabMenu" style="display: none;">
      <button class="tab-btn active" onclick="showTab('frota')">
        <span>‚úÖ</span> Checklist Frota
      </button>
      <button class="tab-btn" onclick="showTab('naoConformidades')">
        <span>üö®</span> N√£o Conformidades
      </button>
      <button class="tab-btn" onclick="showTab('dashboard')">
        <span>üìä</span> Dashboard An√°lise
      </button>
    </div>
    <!-- ============================================ -->
    
    <!-- üîó SE√á√ÉO DE SINCRONIZA√á√ÉO FIREBASE - LAYOUT MELHORADO -->
    <div class="sync-section">
      <div class="sync-header">
        <h4>üî• Sincroniza√ß√£o Firebase</h4>
        <div class="online-status online" id="onlineStatus">
          <span class="online-dot"></span> Online
        </div>
      </div>
      
      <div class="sync-info" id="syncInfo">
        Sistema conectado ao Firebase. Use o menu de configura√ß√µes (‚öôÔ∏è) para sincronizar.
      </div>
    </div>
    
    <!-- ============================================ -->
    <!-- üì¶ ABA 1: CHECKLIST FROTA (ATUAL) -->
    <!-- ============================================ -->
    <div id="tabFrota" class="tab-content active">
      <!-- üìä CARDS DE RESUMO -->
      <div class="summary-cards" id="summaryCards">
        <div class="summary-card total">
          <div class="card-number" id="totalVehicles">0</div>
          <div class="card-label">Total de Ve√≠culos</div>
          <div class="card-subtitle">Carregados no sistema</div>
        </div>
        <div class="summary-card valid">
          <div class="card-number" id="validVehicles">0</div>
          <div class="card-label">Checklists OK</div>
          <div class="card-subtitle">Em conformidade</div>
        </div>
        <div class="summary-card warning">
          <div class="card-number" id="warningVehicles">0</div>
          <div class="card-label">Checklists Pendentes</div>
          <div class="card-subtitle">Sem informa√ß√£o completa</div>
        </div>
        <div class="summary-card expired">
          <div class="card-number" id="expiredVehicles">0</div>
          <div class="card-label">Checklists Vencidos</div>
          <div class="card-subtitle">Fora da validade</div>
        </div>
      </div>

      <!-- üîç FILTROS -->
      <div class="filters">
        <div class="filter-group">
          <div class="filter-label">Filtrar por Status</div>
          <select class="filter-select" id="statusFilter">
            <option value="all">Todos os Status</option>
            <option value="valid">OK</option>
            <option value="pending">Pendentes</option>
            <option value="expired">Vencidos</option>
          </select>
        </div>
        <div class="filter-group">
          <div class="filter-label">Data de Validade</div>
          <input type="date" class="filter-input" id="dateFilter">
        </div>
        <div class="filter-group">
          <div class="filter-label">Busca Inteligente</div>
          <input type="text" class="filter-input" id="searchInput" placeholder="Placa, status, data...">
        </div>
      </div>

      <!-- üìã TABELA -->
      <div class="table-container">
        <table id="dataTable">
          <thead>
            <tr>
              <th data-sort="placa">PLACA</th>
              <th data-sort="vigenciaChecklist">CHECKLIST VIG√äNCIA</th>
              <th data-sort="statusChecklist">CHECKLIST STATUS</th>
              <th data-sort="statusGeral">STATUS GERAL</th>
              <th>A√á√ïES</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                Fa√ßa login para carregar dados...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- üé≠ FOOTER -->
      <div class="footer">
        <div class="footer-info">
          <div>RONDOLOG - SISTEMA DE GEST√ÉO DE FROTAS</div>
          <div id="lastSaveInfo">Usu√°rio: <span id="loggedUser">N√£o autenticado</span></div>
          <div id="lastSyncSheetsInfo">Sistema 100% Firebase</div>
        </div>
        <div class="stats">
          <div class="stat-item">
            <span id="totalCount">0</span> registros carregados
          </div>
          <div class="stat-item">
            <span id="filteredCount">0</span> filtrados
          </div>
        </div>
      </div>
    </div>
    <!-- ============================================ -->
    <!-- üì¶ ABA 2: N√ÉO CONFORMIDADES (NOVA) -->
    <!-- ============================================ -->
    <div id="tabNaoConformidades" class="tab-content">
      <!-- üìä CARDS DE RESUMO NC -->
      <div class="summary-cards" id="ncSummaryCards">
        <div class="summary-card total">
          <div class="card-number" id="ncTotal">0</div>
          <div class="card-label">Total NCs</div>
          <div class="card-subtitle">N√£o conformidades</div>
        </div>
        <div class="summary-card expired">
          <div class="card-number" id="ncHoje">0</div>
          <div class="card-label">NCs Hoje</div>
          <div class="card-subtitle">Registros no dia</div>
        </div>
        <div class="summary-card warning">
          <div class="card-number" id="ncVeiculos">0</div>
          <div class="card-label">Ve√≠culos com NC</div>
          <div class="card-subtitle">Placas diferentes</div>
        </div>
        <div class="summary-card valid">
          <div class="card-number" id="ncMotoristas">0</div>
          <div class="card-label">Motoristas</div>
          <div class="card-subtitle">Envolvidos em NCs</div>
        </div>
      </div>

      <!-- üîç FILTROS NC -->
      <div class="filters">
        <div class="filter-group">
          <div class="filter-label">Tipo de NC</div>
          <select class="filter-select" id="ncTipoFilter">
            <option value="all">Todos os Tipos</option>
            <option value="inicio_sem_ok">In√≠cio sem OK GS</option>
            <option value="nao_informado">In√≠cio N√£o Informado</option>
            <option value="dados_incorretos">SM Dados Incorretos</option>
            <option value="movimento_indevido">Movimento Indevido</option>
            <option value="isca_problema">Isca com Problema</option>
            <option value="interacao_cliente">Intera√ß√£o do Cliente</option>
            <option value="fim_nao_informado">Fim N√£o Informado</option>
            <option value="sm_atrasada">SM Enviada Atrasada</option>
            <option value="outros">Outros</option>
          </select>
        </div>
        <div class="filter-group">
          <div class="filter-label">Ve√≠culo</div>
          <input type="text" class="filter-input" id="ncVeiculoFilter" placeholder="Placa do ve√≠culo...">
        </div>
        <div class="filter-group">
          <div class="filter-label">Motorista</div>
          <input type="text" class="filter-input" id="ncMotoristaFilter" placeholder="Nome do motorista...">
        </div>
        <div class="filter-group">
          <div class="filter-label">Data</div>
          <input type="date" class="filter-input" id="ncDataFilter">
        </div>
      </div>

      <!-- üìã TABELA NC -->
      <div class="table-container">
        <table id="ncDataTable">
          <thead>
            <tr>
              <th data-sort="viagem">VIAGEM</th>
              <th data-sort="veiculo">VE√çCULO</th>
              <th data-sort="motorista">MOTORISTA</th>
              <th data-sort="naoConformidade">N√ÉO CONFORMIDADE</th>
              <th data-sort="dataOcorrencia">DATA</th>
              <th>A√á√ïES</th>
            </tr>
          </thead>
          <tbody id="ncTableBody">
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                Nenhuma n√£o conformidade carregada. Use o menu ‚öôÔ∏è para importar dados.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- üé≠ FOOTER NC -->
      <div class="footer">
        <div class="footer-info">
          <div>RONDOLOG - CONTROLE DE N√ÉO CONFORMIDADES</div>
          <div id="ncLastUpdate">√öltima atualiza√ß√£o: <span id="ncLastUpdateTime">Nunca</span></div>
          <div>Per√≠odo: <span id="ncPeriodo">01/12/2025 √† 17/12/2025</span></div>
        </div>
        <div class="stats">
          <div class="stat-item">
            <span id="ncTotalCount">0</span> NCs carregadas
          </div>
          <div class="stat-item">
            <span id="ncFilteredCount">0</span> filtradas
          </div>
        </div>
      </div>
    </div>
    <!-- ============================================ -->

    <!-- ============================================ -->
    <!-- üìä ABA 3: DASHBOARD DE AN√ÅLISE (NOVA) -->
    <!-- ============================================ -->
    <div id="tabDashboard" class="tab-content">
      <!-- üìä M√âTRICAS PRINCIPAIS -->
      <div class="metric-grid">
        <div class="metric-card">
          <div class="metric-value" id="dashboardTotalNCs">0</div>
          <div class="metric-label">Total de NCs</div>
          <div class="metric-change positive" id="dashboardNCsChange">
            <span>‚Üó</span> <span>0%</span>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="dashboardMediaDiaria">0</div>
          <div class="metric-label">M√©dia Di√°ria</div>
          <div class="metric-change positive" id="dashboardMediaChange">
            <span>‚Üó</span> <span>0%</span>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="dashboardTopVeiculo">-</div>
          <div class="metric-label">Ve√≠culo com + NCs</div>
          <div class="metric-change negative" id="dashboardVeiculoChange">
            <span>‚ö†Ô∏è</span> <span>Monitorar</span>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="dashboardTopMotorista">-</div>
          <div class="metric-label">Motorista com + NCs</div>
          <div class="metric-change negative" id="dashboardMotoristaChange">
            <span>‚ö†Ô∏è</span> <span>Treinamento</span>
          </div>
        </div>
      </div>

      <!-- üîç FILTROS DASHBOARD -->
      <div class="dashboard-filters">
        <div class="filter-group">
          <div class="filter-label">Per√≠odo de An√°lise</div>
          <div class="time-filter">
            <button class="time-btn active" onclick="setDashboardPeriod('7d', this)">7 dias</button>
            <button class="time-btn" onclick="setDashboardPeriod('30d', this)">30 dias</button>
            <button class="time-btn" onclick="setDashboardPeriod('60d', this)">60 dias</button>
            <button class="time-btn" onclick="setDashboardPeriod('90d', this)">90 dias</button>
            <button class="time-btn" onclick="setDashboardPeriod('all', this)">Todo per√≠odo</button>
          </div>
        </div>
        <div class="filter-group">
          <div class="filter-label">Tipo de Gr√°fico</div>
          <select class="filter-select" id="dashboardChartType">
            <option value="bar">Barras</option>
            <option value="line">Linhas</option>
            <option value="pie">Pizza</option>
            <option value="doughnut">Rosca</option>
          </select>
        </div>
      </div>

      <!-- üìà SE√á√ÉO DE GR√ÅFICOS -->
      <div class="dashboard-section-title">
        <span>üìä</span> An√°lise por Tipo de N√£o Conformidade
      </div>
      
      <div class="dashboard-grid">
        <!-- Gr√°fico 1: Distribui√ß√£o por Tipo -->
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">üìà Distribui√ß√£o por Tipo de NC</div>
            <div class="chart-actions">
              <button class="chart-btn" onclick="exportChart('chartTipoNC', 'distribuicao_tipo_nc')">üì•</button>
              <button class="chart-btn" onclick="toggleChartType('chartTipoNC')">üîÑ</button>
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="chartTipoNC"></canvas>
          </div>
          <div class="top-list" id="topTiposNC">
            <!-- Top tipos ser√£o carregados aqui -->
          </div>
        </div>

        <!-- Gr√°fico 2: Evolu√ß√£o Temporal -->
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">üìÖ Evolu√ß√£o Temporal de NCs</div>
            <div class="chart-actions">
              <button class="chart-btn" onclick="exportChart('chartEvolucao', 'evolucao_temporal_nc')">üì•</button>
              <button class="chart-btn" onclick="toggleChartType('chartEvolucao')">üîÑ</button>
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="chartEvolucao"></canvas>
          </div>
          <div class="top-list" id="topDiasNC">
            <!-- Top dias ser√£o carregados aqui -->
          </div>
        </div>

        <!-- Gr√°fico 3: Top Ve√≠culos -->
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">üöõ Top 10 Ve√≠culos com Mais NCs</div>
            <div class="chart-actions">
              <button class="chart-btn" onclick="exportChart('chartTopVeiculos', 'top_veiculos_nc')">üì•</button>
              <button class="chart-btn" onclick="toggleChartType('chartTopVeiculos')">üîÑ</button>
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="chartTopVeiculos"></canvas>
          </div>
          <div class="top-list" id="topVeiculosList">
            <!-- Top ve√≠culos ser√£o carregados aqui -->
          </div>
        </div>

        <!-- Gr√°fico 4: Top Motoristas -->
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">üë®‚Äç‚úàÔ∏è Top 10 Motoristas com Mais NCs</div>
            <div class="chart-actions">
              <button class="chart-btn" onclick="exportChart('chartTopMotoristas', 'top_motoristas_nc')">üì•</button>
              <button class="chart-btn" onclick="toggleChartType('chartTopMotoristas')">üîÑ</button>
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="chartTopMotoristas"></canvas>
          </div>
          <div class="top-list" id="topMotoristasList">
            <!-- Top motoristas ser√£o carregados aqui -->
          </div>
        </div>
      </div>

      <!-- üìã SE√á√ÉO DE DADOS DETALHADOS -->
      <div class="dashboard-section-title">
        <span>üìã</span> Dados Detalhados para An√°lise
      </div>

      <div class="dashboard-grid">
        <!-- Card 5: Resumo por Dia da Semana -->
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">üìÖ NCs por Dia da Semana</div>
            <div class="chart-actions">
              <button class="chart-btn" onclick="exportChart('chartDiaSemana', 'ncs_dia_semana')">üì•</button>
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="chartDiaSemana"></canvas>
          </div>
          <div class="top-list" id="topDiasSemana">
            <!-- Top dias da semana ser√£o carregados aqui -->
          </div>
        </div>

        <!-- Card 6: Comparativo Per√≠odo -->
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">üìä Comparativo Per√≠odo Anterior</div>
            <div class="chart-actions">
              <button class="chart-btn" onclick="exportChart('chartComparativo', 'comparativo_periodo')">üì•</button>
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="chartComparativo"></canvas>
          </div>
          <div class="top-list" id="comparativoInfo">
            <!-- Informa√ß√µes comparativas ser√£o carregadas aqui -->
          </div>
        </div>
      </div>

      <!-- üé≠ FOOTER DASHBOARD -->
      <div class="footer">
        <div class="footer-info">
          <div>RONDOLOG - DASHBOARD DE AN√ÅLISE QUALITATIVA</div>
          <div id="dashboardLastUpdate">√öltima an√°lise: <span id="dashboardLastUpdateTime">Nunca</span></div>
          <div>Per√≠odo analisado: <span id="dashboardPeriodo">√öltimos 7 dias</span></div>
        </div>
        <div class="stats">
          <button class="btn btn-info" onclick="exportDashboardPDF()">
            üìã Exportar Relat√≥rio
          </button>
          <button class="btn btn-success" onclick="atualizarDashboard()">
            üîÑ Atualizar Dados
          </button>
        </div>
      </div>
    </div>
    <!-- ============================================ -->
  </div>

  <!-- üé≠ MODAL DE EDI√á√ÉO/ADI√á√ÉO DE VE√çCULO -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3 id="modalTitle">Adicionar Novo Ve√≠culo</h3>
      <form id="editForm">
        <div class="form-group">
          <label>Placa do Ve√≠culo *</label>
          <input type="text" class="form-control" id="editPlaca" required>
          <div class="error-message" id="placaError">Placa √© obrigat√≥ria</div>
        </div>
        <div class="form-group">
          <label>Checklist Vig√™ncia *</label>
          <input type="date" class="form-control" id="editVigenciaChecklist" required>
          <div class="error-message" id="vigenciaChecklistError">Vig√™ncia do checklist √© obrigat√≥ria</div>
        </div>
        <div class="form-group">
          <label>Checklist Status *</label>
          <select class="form-control" id="editStatusChecklist" required>
            <option value="">Selecione...</option>
            <option value="PENDENTE">PENDENTE</option>
            <option value="OK">OK</option>
            <option value="VENCIDO">VENCIDO</option>
          </select>
          <div class="error-message" id="statusChecklistError">Status do checklist √© obrigat√≥rio</div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-cancel" id="btnCancelModal">Cancelar</button>
          <button type="submit" class="btn btn-success">Salvar Ve√≠culo</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- üö® MODAL DE VISUALIZA√á√ÉO DE NC (NOVO) -->
  <!-- ============================================ -->
  <div class="modal" id="ncViewModal">
    <div class="modal-content" style="max-width: 700px;">
      <h3>üö® Detalhes da N√£o Conformidade</h3>
      <div id="ncViewContent" style="max-height: 60vh; overflow-y: auto;">
        <!-- Conte√∫do ser√° preenchido dinamicamente -->
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-cancel" onclick="closeNcViewModal()">Fechar</button>
        <button class="btn btn-warning" onclick="ncExportarPDF()">üìã Exportar PDF</button>
      </div>
    </div>
  </div>
  <!-- ============================================ -->

  <script>
    // =========================
    // UTIL: escape text to avoid XSS
    // =========================
    function escapeHtml(str){
      if(str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    // =========================
    // IndexedDB simple wrapper (promisified)
    // =========================
    const idb = (function(){
      const DB_NAME = 'rondolog_db_v1';
      const STORE = 'kv';
      let dbp = null;
      function open(){
        if(dbp) return dbp;
        dbp = new Promise((resolve, reject)=>{
          const req = indexedDB.open(DB_NAME, 1);
          req.onupgradeneeded = (e)=>{
            const db = e.target.result;
            if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
          };
          req.onsuccess = ()=> resolve(req.result);
          req.onerror = ()=> reject(req.error);
        });
        return dbp;
      }
      async function get(key){
        const db = await open();
        return new Promise((res, rej)=>{
          const tx = db.transaction(STORE,'readonly');
          const st = tx.objectStore(STORE);
          const r = st.get(key);
          r.onsuccess = ()=> res(r.result);
          r.onerror = ()=> rej(r.error);
        });
      }
      async function set(key, val){
        const db = await open();
        return new Promise((res, rej)=>{
          const tx = db.transaction(STORE,'readwrite');
          const st = tx.objectStore(STORE);
          const r = st.put(val, key);
          r.onsuccess = ()=> res(true);
          r.onerror = ()=> rej(r.error);
        });
      }
      async function del(key){
        const db = await open();
        return new Promise((res, rej)=>{
          const tx = db.transaction(STORE,'readwrite');
          const st = tx.objectStore(STORE);
          const r = st.delete(key);
          r.onsuccess = ()=> res(true);
          r.onerror = ()=> rej(r.error);
        });
      }
      return { get, set, del };
    })();

    // =========================
    // Lazy-load helper for heavy libs
    // =========================
    function loadScriptOnce(src){
      return new Promise((resolve,reject)=>{
        if(document.querySelector(`script[src="${src}"]`)) return resolve();
        const s = document.createElement('script');
        s.src = src;
        s.onload = ()=> resolve();
        s.onerror = (e)=> reject(e);
        document.head.appendChild(s);
      });
    }

    // ============================================
    // RONDOLOG - SISTEMA DE GEST√ÉO DE FROTAS
    // Vers√£o: 15.2 - COM DASHBOARD DE AN√ÅLISE
    // ============================================
    
    // ============================================
    // üî• FIREBASE AUTHENTICATION SERVICE - CORRIGIDO
    // ============================================
    const firebaseAuth = {
      currentUser: null,
      
      // Inicializar auth
      async init() {
        try {
          // J√° est√° inicializado no firebaseService
          this.auth = firebase.auth();
          
          // Observar mudan√ßas de estado
          this.auth.onAuthStateChanged(async (user) => {
            if (user) {
              await this.handleUserSignedIn(user);
            } else {
              this.handleUserSignedOut();
            }
          });
          
        } catch (error) {
          console.error('Erro ao inicializar Firebase Auth:', error);
        }
      },
      
      // Login com email/senha
      async login(email, password) {
        try {
          const userCredential = await this.auth.signInWithEmailAndPassword(email, password);
          this.currentUser = userCredential.user;
          
          // For√ßar refresh do token
          await this.currentUser.getIdToken(true);
          
          // Buscar role customizada do Database
          await this.fetchUserRole();
          
          return { success: true, user: this.currentUser };
        } catch (error) {
          return { success: false, error: error.message };
        }
      },
      
      // Buscar role do usu√°rio no Database
      // Buscar role do usu√°rio no Database - VERS√ÉO CORRIGIDA
      async fetchUserRole() {
        console.log('üîç Buscando role do usu√°rio (VERS√ÉO CORRIGIDA)...');
        
        if (!this.currentUser) {
          console.log('‚ùå Nenhum usu√°rio atual');
          return null;
        }
        
        try {
          console.log(`üë§ Usu√°rio: ${this.currentUser.email}`);
          
          // USU√ÅRIO PRINCIPAL - SEMPRE ADMIN
          if (this.currentUser.email === 'info.fvalentim@gmail.com') {
            console.log('üéØ Usu√°rio principal detectado - ATRIBUINDO ADMIN');
            
            this.currentUser = {
              ...this.currentUser,
              role: 'ADMIN',
              displayName: 'Fernando Administrador',
              permissions: this.getPermissions('ADMIN')
            };
            
            this.updateRoleBadge();
            return this.currentUser;
          }
          
          console.log(`üîë UID: ${this.currentUser.uid}`);
          
          // Para outros usu√°rios, buscar do Database
          const userRef = firebase.database().ref(`users/${this.currentUser.uid}`);
          const snapshot = await userRef.once('value');
          
          if (snapshot.exists()) {
            const userData = snapshot.val();
            console.log('üìã Dados encontrados no Database:', userData);
            
            const role = userData.role || 'VIEWER';
            const displayName = userData.displayName || this.currentUser.displayName || this.currentUser.email.split('@')[0];
            
            console.log(`üé≠ Role atribu√≠da: ${role}`);
            
            this.currentUser = {
              ...this.currentUser,
              role: role,
              displayName: displayName,
              permissions: this.getPermissions(role)
            };
            
          } else {
            console.log('‚ö†Ô∏è Usu√°rio n√£o encontrado no Database, usando VIEWER');
            this.currentUser = {
              ...this.currentUser,
              role: 'VIEWER',
              permissions: this.getPermissions('VIEWER')
            };
          }
          
          this.updateRoleBadge();
          
          console.log('‚úÖ Usu√°rio final:', {
            email: this.currentUser.email,
            role: this.currentUser.role
          });
          
          return this.currentUser;
          
        } catch (error) {
          console.error('‚ùå Erro ao buscar role:', error);
          
          // FALLBACK: Se der erro, usar ADMIN para garantir acesso
          this.currentUser = {
            ...this.currentUser,
            role: 'ADMIN',
            permissions: this.getPermissions('ADMIN')
          };
          
          this.updateRoleBadge();
          return this.currentUser;
        }
      },
      
      // Criar usu√°rio (somente admin)
      async createUser(email, password, role = 'VIEWER', displayName = '') {
        try {
          if (!this.currentUser || this.currentUser.role !== 'ADMIN') {
            throw new Error('Apenas administradores podem criar usu√°rios');
          }
          
          // 1. Criar usu√°rio no Firebase Auth
          const userCredential = await this.auth.createUserWithEmailAndPassword(email, password);
          const user = userCredential.user;
          
          // 2. Adicionar nome (opcional)
          if (displayName) {
            await user.updateProfile({ displayName });
          }
          
          // 3. Salvar role personalizada no Database
          await firebaseService.database.ref(`users/${user.uid}`).set({
            email: user.email,
            role: role,
            displayName: displayName || user.email.split('@')[0],
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            createdBy: this.currentUser.uid,
            active: true
          });
          
          return { success: true, user };
        } catch (error) {
          return { success: false, error: error.message };
        }
      },
      
      // Logout
      async logout() {
        await this.auth.signOut();
        this.currentUser = null;
      },
      
      // Handler quando usu√°rio faz login
      // Handler quando usu√°rio faz login
      async handleUserSignedIn(user) {
        console.log('========================================');
        console.log('üë§ HANDLE USER SIGNED IN');
        console.log('Email:', user.email);
        console.log('UID:', user.uid);
        console.log('========================================');
        
        // Buscar role customizada do Database
        await this.fetchUserRole();
        
        // Atualizar UI
        this.updateUIAfterLogin();
        
        // Configurar refresh autom√°tico de token
        this.setupTokenRefresh();
        
        // DEBUG: Testar permiss√µes imediatamente
        setTimeout(() => {
          console.log('üîç TESTE DE PERMISS√ïES AP√ìS LOGIN:');
          console.log('Role:', this.currentUser?.role);
          console.log('canAccessVehicles:', permissionManager?.canAccessVehicles?.());
          console.log('canAccessNCs:', permissionManager?.canAccessNCs?.());
        }, 1000);
      },
      
      // Handler quando usu√°rio faz logout
      handleUserSignedOut() {
        console.log('üëã Usu√°rio deslogado');
        this.currentUser = null;
        // Redirecionar para login
        document.getElementById('loginModal').style.display = 'flex';
        document.getElementById('mainContainer').style.display = 'none';
        document.getElementById('settingsIcon').style.display = 'none';
        document.getElementById('userRoleBadge').style.display = 'none';
      },
      
      // Mapear roles para permiss√µes
      getPermissions(role) {
        const permissions = {
          'ADMIN': ['create_users', 'edit_all', 'delete_all', 'system_config', 'nc_admin', 'nc_import'],
          'MANAGER': ['edit_all', 'view_reports', 'export_data', 'nc_import', 'nc_view'],
          'OPERATOR': ['view_only', 'add_vehicles', 'edit_own', 'nc_view'],
          'VIEWER': ['view_only', 'nc_view']
        };
        return permissions[role] || permissions['VIEWER'];
      },
      
      // Atualizar interface ap√≥s login - CORRIGIDA
      updateUIAfterLogin() {
        // Esconder modal de login
        document.getElementById('loginModal').style.display = 'none';
        
        // Mostrar aplica√ß√£o principal
        document.getElementById('mainContainer').style.display = 'block';
        
        // Verificar se o √≠cone existe antes de mostrar
        const settingsIcon = document.getElementById('settingsIcon');
        if (settingsIcon) {
          settingsIcon.style.display = 'flex';
        }
        
        // Mostrar menu de abas
        const tabMenu = document.getElementById('tabMenu');
        if (tabMenu) {
          tabMenu.style.display = 'flex';
        }
        
        // Atualizar nome do usu√°rio com verifica√ß√£o de seguran√ßa
        const userDisplay = this.currentUser?.email || 'Usu√°rio';
        const userName = this.currentUser?.displayName || userDisplay;
        
        const loggedUserEl = document.getElementById('loggedUser');
        const currentUserInfoEl = document.getElementById('currentUserInfo');
        
        if (loggedUserEl) {
          loggedUserEl.textContent = userName;
        }
        
        if (currentUserInfoEl) {
          currentUserInfoEl.textContent = userDisplay;
        }
        
        // Mostrar/ocultar se√ß√£o admin baseado na role
        const adminSection = document.getElementById('adminSection');
        if (adminSection) {
          const userRole = this.currentUser?.role || 'VIEWER';
          adminSection.style.display = userRole === 'ADMIN' ? 'block' : 'none';
        }
        
        // Mostrar badge de role
        this.updateRoleBadge();
        
        // Carregar dados do sistema
        initializeApp();
      },
      
      // Atualizar badge de role
      updateRoleBadge() {
        const badge = document.getElementById('userRoleBadge');
        if (badge && this.currentUser?.role) {
          badge.textContent = this.currentUser.role;
          badge.className = `role-badge ${this.currentUser.role.toLowerCase()}`;
          badge.style.display = 'inline-block';
        }
      },
      
      // Configurar refresh autom√°tico de token
      setupTokenRefresh() {
        if (!this.currentUser) return;
        
        // Refresh token a cada 30 minutos
        setInterval(async () => {
          try {
            if (this.currentUser) {
              await this.currentUser.getIdToken(true);
              console.log('‚úÖ Token atualizado automaticamente');
            }
          } catch (error) {
            console.error('‚ùå Erro ao atualizar token:', error);
          }
        }, 30 * 60 * 1000); // 30 minutos
      },
      
      // Verificar permiss√µes
      hasPermission(permission) {
        if (!this.currentUser) return false;
        return this.currentUser.permissions.includes(permission);
      },
      
      // Verificar se √© admin
      isAdmin() {
        return this.currentUser && this.currentUser.role === 'ADMIN';
      },
      
      // Verificar se √© manager
      isManager() {
        return this.currentUser && this.currentUser.role === 'MANAGER';
      },
      
      // Verificar se tem permiss√£o para NCs
      hasNCPermission() {
        return this.isAdmin() || this.isManager();
      }
    };

    // ============================================
    // üî• VERIFICA√á√ÉO DE PERMISS√ïES PARA NCs
    // ============================================
    const ncPermissaoMiddleware = {
      async verificarAdminOuManager() {
        try {
          const user = firebase.auth().currentUser;
          if (!user) {
            throw new Error('N√£o autenticado. Fa√ßa login novamente.');
          }
          
          // For√ßar refresh do token
          await user.getIdToken(true);
          
          // Buscar role do usu√°rio
          const snapshot = await firebase.database()
            .ref(`users/${user.uid}/role`)
            .once('value');
          
          if (!snapshot.exists()) {
            throw new Error('Role n√£o configurada. Contate o administrador.');
          }
          
          const role = snapshot.val();
          const permitido = role === 'ADMIN' || role === 'MANAGER';
          
          if (!permitido) {
            throw new Error(`Acesso negado para NCs. Role atual: ${role}. Requer ADMIN ou MANAGER.`);
          }
          
          return { user, role };
          
        } catch (error) {
          console.error('‚ùå Verifica√ß√£o de permiss√£o falhou:', error);
          throw error;
        }
      }
    };

    // ============================================
    //  Ô∏è SISTEMA UNIFICADO DE PERMISS√ïES
    // ============================================
    const permissionManager = {
      // Verificar acesso a ve√≠culos
      canAccessVehicles() {
        const user = firebaseAuth.currentUser;
        if (!user) return false;
        
        const role = user.role;
        const allowed = ['ADMIN', 'MANAGER', 'OPERATOR', 'VIEWER'].includes(role);
        console.log(`üîê Permiss√£o ve√≠culos: ${role} ‚Üí ${allowed ? 'PERMITIDO' : 'NEGADO'}`);
        return allowed;
      },
      
      // Verificar acesso a NCs
      canAccessNCs() {
        const user = firebaseAuth.currentUser;
        if (!user) return false;
        
        const role = user.role;
        const allowed = ['ADMIN', 'MANAGER'].includes(role);
        console.log(`üîê Permiss√£o NCs: ${role} ‚Üí ${allowed ? 'PERMITIDO' : 'NEGADO'}`);
        return allowed;
      },
      
      // Verificar escrita em ve√≠culos
      canWriteVehicles() {
        const user = firebaseAuth.currentUser;
        if (!user) return false;
        
        const role = user.role;
        const allowed = ['ADMIN', 'MANAGER', 'OPERATOR'].includes(role);
        console.log(`üîê Escrita ve√≠culos: ${role} ‚Üí ${allowed ? 'PERMITIDO' : 'NEGADO'}`);
        return allowed;
      },
      
      // Verificar escrita em NCs
      canWriteNCs() {
        const user = firebaseAuth.currentUser;
        if (!user) return false;
        
        const role = user.role;
        const allowed = ['ADMIN', 'MANAGER'].includes(role);
        console.log(`üîê Escrita NCs: ${role} ‚Üí ${allowed ? 'PERMITIDO' : 'NEGADO'}`);
        return allowed;
      },
      
      // Verificar se √© admin
      isAdmin() {
        const user = firebaseAuth.currentUser;
        const isAdmin = user && user.role === 'ADMIN';
        console.log(`üëë √â admin? ${isAdmin ? 'SIM' : 'N√ÉO'}`);
        return isAdmin;
      }
    };

    // ============================================
    //  üö® M√ìDULO N√ÉO CONFORMIDADES - CORRIGIDO
    // ============================================
    const ncModule = {
      dados: [],
      filteredData: [],
      currentSort: { column: null, direction: 'asc' },
      stats: {
        total: 0,
        hoje: 0,
        veiculos: new Set(),
        motoristas: new Set(),
        tipos: {}
      },
      
      // Fun√ß√£o auxiliar para obter token de autentica√ß√£o - CORRIGIDA
      async getFirebaseToken() {
        try {
          const user = firebase.auth().currentUser;
          if (!user) {
            throw new Error('Usu√°rio n√£o autenticado. Fa√ßa login novamente.');
          }
          
          // For√ßar refresh do token
          const token = await user.getIdToken(true);
          return token;
        } catch (error) {
          console.error('‚ùå Erro ao obter token:', error);
          throw new Error(`Falha na autentica√ß√£o: ${error.message}`);
        }
      },
      
      async carregarDoFirebase() {
        try {
          // Verifica√ß√£o de permiss√£o SIMPLES
          if (!permissionManager.canAccessNCs()) {
            showNotification('üîí Apenas ADMIN ou MANAGER podem acessar NCs', 'error');
            updateNcStatus('üîí Acesso restrito');
            return [];
          }
          
          showNotification('üì• Carregando n√£o conformidades...', 'info');
          
          const snapshot = await firebaseService.database.ref('nc_dados/registros').once('value');
          
          if (snapshot.exists()) {
            const data = snapshot.val();
            const dadosArray = Object.entries(data).map(([key, value]) => ({
              id: key,
              ...value
            }));
            
            this.dados = dadosArray.filter(item => item !== null);
            this.atualizarEstatisticas();
            this.aplicarFiltros();
            this.renderizarTabela();
            
            showNotification(`‚úÖ ${this.dados.length} NCs carregadas`, 'success');
            updateNcStatus(`‚úÖ ${this.dados.length} NCs carregadas`);
            
            if (document.getElementById('tabDashboard').classList.contains('active')) {
              atualizarDashboard();
            }
          } else {
            this.dados = [];
            updateNcStatus('üì≠ Nenhuma NC encontrada');
          }
          
          return this.dados;
          
        } catch (error) {
          console.error('‚ùå Erro ao carregar NCs:', error);
          
          if (error.message.includes('permission_denied')) {
            showNotification('üîí Sem permiss√£o para acessar NCs', 'error');
            updateNcStatus('üîí Permiss√£o negada');
          } else {
            showNotification(`‚ùå Erro: ${error.message}`, 'error');
            updateNcStatus('‚ùå Erro ao carregar');
          }
          
          return [];
        }
      },
      
      async importarPlanilha(file = null) {
        try {
          // Verificar permiss√µes
          await ncPermissaoMiddleware.verificarAdminOuManager();
          
          if (!file) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls,.csv';
            input.onchange = (e) => {
              if (e.target.files.length) {
                this.processarArquivoNC(e.target.files[0]);
              }
            };
            input.click();
          } else {
            await this.processarArquivoNC(file);
          }
        } catch (error) {
          console.error('‚ùå Erro de permiss√£o na importa√ß√£o:', error);
          showNotification(`‚ùå ${error.message}`, 'error');
        }
      },
      
      async processarArquivoNC(arquivo) {
        try {
          showNotification(`üìÅ Processando ${arquivo.name}...`, 'info');
          
          // 1. Verificar conectividade e autentica√ß√£o
          await this.verificarConectividadeFirebase();
          
          const data = await this.lerExcel(arquivo);
          
          console.log('üîç ESTRUTURA DA PLANILHA NC:', {
            nomeArquivo: arquivo.name,
            totalLinhas: data.length,
            cabecalhos: data.length > 0 ? Object.keys(data[0]) : [],
            primeiraLinha: data.length > 0 ? data[0] : null
          });
          
          const processados = await this.processarPlanilhaNC(data, arquivo.name);
          
          if (processados.length === 0) {
            const erroMsg = `‚ùå NENHUMA NC V√ÅLIDA ENCONTRADA!\n\nArquivo: ${arquivo.name}\nLinhas na planilha: ${data.length}\n\nVerifique se a planilha cont√©m as colunas obrigat√≥rias:\n‚Ä¢ Ve√≠culo\n‚Ä¢ N√£o Conformidade\n‚Ä¢ Data Ocorrencia`;
            console.error(erroMsg);
            alert(erroMsg);
            showNotification('‚ö†Ô∏è Nenhuma NC v√°lida encontrada', 'warning');
            return;
          }
          
          // 2. Salvar no Firebase
          await this.salvarNCFirebase(processados, arquivo.name);
          
          // 3. Atualizar dados locais AP√ìS salvar no Firebase
          this.dados = processados;
          this.atualizarEstatisticas();
          this.aplicarFiltros();
          this.renderizarTabela();
          
          showNotification(`‚úÖ ${processados.length} NCs importadas com sucesso!`, 'success');
          updateNcStatus(`‚úÖ ${processados.length} NCs salvas no Firebase`);
          
          // 4. Atualizar dashboard
          if (document.getElementById('tabDashboard').classList.contains('active')) {
            atualizarDashboard();
          }
          
        } catch (error) {
          console.error('‚ùå Erro na importa√ß√£o:', error);
          showNotification(`‚ùå ${error.message}`, 'error');
          
          // Mensagem mais amig√°vel para o usu√°rio
          if (error.message.includes('Acesso negado')) {
            alert(`PERMISS√ÉO NEGADA\n\nVoc√™ n√£o tem permiss√£o para importar NCs.\n\nRequisi√ß√£o: ADMIN ou MANAGER\n\nSeu perfil: ${firebaseAuth.currentUser?.role || 'N√£o identificado'}`);
          } else if (error.message.includes('Sess√£o expirada')) {
            alert('SESS√ÉO EXPIRADA\n\nSua sess√£o expirou. Por favor, fa√ßa login novamente.');
            firebaseAuth.logout();
          } else {
            alert(`ERRO NA IMPORTA√á√ÉO:\n\n${error.message}\n\nVerifique o console (F12) para mais detalhes.`);
          }
        }
      },
      
      lerExcel(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const sheet = workbook.Sheets[workbook.SheetNames[0]];
              const jsonData = XLSX.utils.sheet_to_json(sheet);
              resolve(jsonData);
            } catch (error) {
              reject(new Error(`Erro ao ler arquivo Excel: ${error.message}`));
            }
          };
          reader.onerror = () => reject(new Error('Erro ao ler o arquivo'));
          reader.readAsArrayBuffer(file);
        });
      },
      
      async processarPlanilhaNC(data, fileName) {
        const processados = [];
        const hoje = new Date().toISOString().split('T')[0];
        
        console.log('üìä Processando planilha NC:', data.length, 'linhas');
        
        for (let i = 0; i < data.length; i++) {
          const row = data[i];
          
          try {
            const extrairCampo = (nomesPossiveis, defaultValue = '') => {
              for (const nome of nomesPossiveis) {
                if (row[nome] !== undefined && row[nome] !== null && row[nome] !== '') {
                  return String(row[nome]).trim();
                }
              }
              return defaultValue;
            };
            
            // Valida√ß√µes b√°sicas
            const veiculo = extrairCampo(['Ve√≠culo', 'Veiculo']).toUpperCase().trim();
            const naoConformidade = extrairCampo(['N√£o Conformidade', 'Nao Conformidade']);
            
            // Pular linhas sem dados essenciais
            if (!veiculo || veiculo === '' || !naoConformidade || naoConformidade === '') {
              console.warn(`‚ö†Ô∏è Linha ${i + 1} ignorada - Dados insuficientes:`, {
                veiculo: veiculo,
                naoConformidade: naoConformidade
              });
              continue;
            }
            
            const nc = {
              id: `nc_${Date.now()}_${i}`,
              viagem: extrairCampo(['Viagem']),
              cliente: extrairCampo(['Cliente']),
              embarcador: extrairCampo(['Embarcador']),
              veiculo: veiculo,
              cpfCondutor: extrairCampo(['CPF Condutor']),
              nomeCondutor: extrairCampo(['Nome Condutor']),
              origem: extrairCampo(['Origem']),
              destino: extrairCampo(['Destino']),
              naoConformidade: naoConformidade,
              dataOcorrencia: extrairCampo(['Data Ocorrencia']),
              importadoEm: hoje,
              arquivoOrigem: fileName,
              linhaOrigem: i + 1,
              importadoPor: firebaseAuth.currentUser?.email || 'Sistema'
            };
            
            nc.dataOcorrencia = this.formatarDataOcorrencia(nc.dataOcorrencia);
            nc.tipoNC = this.classificarTipoNC(nc.naoConformidade);
            
            processados.push(nc);
            
          } catch (error) {
            console.error(`‚ùå Erro na linha ${i + 1}:`, error, 'Dados:', row);
          }
        }
        
        console.log(`‚úÖ Processamento conclu√≠do: ${processados.length} NCs v√°lidas de ${data.length} linhas`);
        return processados;
      },
      
      formatarDataOcorrencia(dataString) {
        if (dataString === null || dataString === undefined) return '';

        if (Object.prototype.toString.call(dataString) === '[object Date]') {
          const d = dataString;
          if (isNaN(d.getTime())) return '';
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth() + 1).padStart(2, '0');
          const dd = String(d.getDate()).padStart(2, '0');
          const hh = String(d.getHours()).padStart(2, '0');
          const min = String(d.getMinutes()).padStart(2, '0');
          return `${yyyy}-${mm}-${dd}${hh || min ? ` ${hh}:${min}` : ''}`.trim();
        }

        const str = String(dataString).trim();

        if (/^\d+(?:\.\d+)?$/.test(str)) {
          try {
            const serial = parseFloat(str);
            const ms = (serial - 25569) * 86400 * 1000;
            const d = new Date(ms);
            if (!isNaN(d.getTime())) {
              const yyyy = d.getFullYear();
              const mm = String(d.getMonth() + 1).padStart(2, '0');
              const dd = String(d.getDate()).padStart(2, '0');
              const hh = String(d.getHours()).padStart(2, '0');
              const min = String(d.getMinutes()).padStart(2, '0');
              return `${yyyy}-${mm}-${dd}${hh || min ? ` ${hh}:${min}` : ''}`.trim();
            }
          } catch (e) {
            console.warn('‚ö†Ô∏è Erro convertendo serial Excel:', e);
          }
        }

        if (str.includes('/')) {
          try {
            const partes = str.split(' ');
            const dataParte = partes[0];
            const horaParte = partes[1] || '';

            if (dataParte.includes('/')) {
              const [dia, mes, ano] = dataParte.split('/');
              const horaFormatada = horaParte ? ` ${horaParte}` : '';
              return `${ano}-${String(mes).padStart(2, '0')}-${String(dia).padStart(2, '0')}${horaFormatada}`.trim();
            }
          } catch (e) {
            console.warn('‚ö†Ô∏è Erro ao formatar data:', e);
          }
        }

        try {
          const maybeDate = new Date(str);
          if (!isNaN(maybeDate.getTime())) {
            const yyyy = maybeDate.getFullYear();
            const mm = String(maybeDate.getMonth() + 1).padStart(2, '0');
            const dd = String(maybeDate.getDate()).padStart(2, '0');
            const hh = String(maybeDate.getHours()).padStart(2, '0');
            const min = String(maybeDate.getMinutes()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}${hh || min ? ` ${hh}:${min}` : ''}`.trim();
          }
        } catch (e) {
          // fallthrough
        }

        return '';
      },
      
      classificarTipoNC(descricao) {
        if (!descricao) return 'outros';
        
        const desc = descricao.toLowerCase();
        
        const tipos = [
          { padrao: ['inicio de viagem sem aguardar', 'sem aguardar a mensagem ok gs'], tipo: 'inicio_sem_ok' },
          { padrao: ['inicio de viagem n√£o informado', 'inicio n√£o informado'], tipo: 'nao_informado' },
          { padrao: ['sm com dados incorretos', 'dados incorretos'], tipo: 'dados_incorretos' },
          { padrao: ['movimento indevido'], tipo: 'movimento_indevido' },
          { padrao: ['isca com problema', 'isca problema'], tipo: 'isca_problema' },
          { padrao: ['detectado intera√ß√£o', 'intera√ß√£o do cliente'], tipo: 'interacao_cliente' },
          { padrao: ['fim de viagem n√£o informado'], tipo: 'fim_nao_informado' },
          { padrao: ['sm enviada ap√≥s', 'sm atrasada'], tipo: 'sm_atrasada' },
          { padrao: ['liberado fora do romaneio', 'fora do romaneio'], tipo: 'fora_romaneio' },
          { padrao: ['perda de sinal'], tipo: 'perda_sinal' },
          { padrao: ['chegada n√£o informada'], tipo: 'chegada_nao_info' }
        ];
        
        for (const tipo of tipos) {
          for (const padrao of tipo.padrao) {
            if (desc.includes(padrao)) {
              return tipo.tipo;
            }
          }
        }
        
        return 'outros';
      },
      
      async verificarConectividadeFirebase() {
        try {
          // Testar conex√£o com Firebase
          const connectedRef = firebase.database().ref('.info/connected');
          const snapshot = await connectedRef.once('value');
          const conectado = snapshot.val() === true;
          
          if (!conectado) {
            throw new Error('Sem conex√£o com Firebase');
          }
          
          // Verificar autentica√ß√£o
          const user = firebase.auth().currentUser;
          if (!user) {
            throw new Error('Usu√°rio n√£o autenticado');
          }
          
          // Verificar token
          const token = await user.getIdToken(true);
          console.log('‚úÖ Usu√°rio autenticado, token v√°lido');
          
          return true;
        } catch (error) {
          console.error('‚ùå Erro de conectividade:', error);
          throw error;
        }
      },
      
      async salvarNCFirebase(dados, fileName) {
        try {
          showNotification('üíæ Salvando no Firebase...', 'info');
          
          // Verificar permiss√µes
          await ncPermissaoMiddleware.verificarAdminOuManager();
          
          const updates = {};
          const usuario = firebaseAuth.currentUser?.email || 'Sistema';
          const timestamp = new Date().toISOString();
          const userId = firebaseAuth.currentUser?.uid || 'system';
          
          // Usar o SDK Firebase diretamente para garantir o contexto correto
          const database = firebase.database();
          
          console.log(`üì§ Preparando ${dados.length} registros para salvar...`);
          
          dados.forEach((nc, index) => {
            // Criar uma chave √∫nica usando timestamp e index
            const key = nc.id || `nc_${timestamp.replace(/[^0-9]/g, '')}_${index}`;
            
            updates[`nc_dados/registros/${key}`] = {
              ...nc,
              id: key,
              salvoEm: timestamp,
              salvoPor: usuario,
              salvoPorId: userId,
              syncStatus: 'synced',
              updatedAt: firebase.database.ServerValue.TIMESTAMP
            };
          });
          
          // Estat√≠sticas
          updates['nc_dados/stats/total'] = dados.length;
          updates['nc_dados/stats/ultima_importacao'] = timestamp;
          updates['nc_dados/stats/arquivo_ultima_importacao'] = fileName;
          updates['nc_dados/stats/importado_por'] = usuario;
          updates['nc_dados/stats/importado_por_id'] = userId;
          
          console.log('üî• Updates a serem enviados:', updates);
          
          // Salvar no Firebase
          await database.ref().update(updates);
          
          // Verificar se os dados foram salvos
          const verificarSnapshot = await database.ref('nc_dados/registros').once('value');
          const countSalvo = verificarSnapshot.numChildren();
          
          console.log(`‚úÖ ${countSalvo} registros salvos no Firebase`);
          
          syncLog.add('nc_import', `${dados.length} NCs importadas`, {
            arquivo: fileName,
            usuario: usuario,
            userId: userId,
            count: dados.length,
            countSalvo: countSalvo
          });
          
          showNotification(`‚úÖ ${dados.length} NCs salvas no Firebase`, 'success');
          return true;
          
        } catch (error) {
          console.error('‚ùå Erro ao salvar no Firebase:', error);
          
          // Log detalhado do erro
          if (error.code) {
            console.error('C√≥digo do erro:', error.code);
            console.error('Mensagem:', error.message);
          }
          
          if (error.message.includes('Acesso negado') || error.message.includes('permission_denied')) {
            throw new Error('Apenas ADMIN ou MANAGER podem salvar NCs no Firebase');
          } else if (error.message.includes('N√£o autenticado') || error.message.includes('auth/')) {
            throw new Error('Sess√£o expirada. Fa√ßa login novamente.');
          } else {
            throw new Error(`Erro ao salvar no Firebase: ${error.message}`);
          }
        }
      },
      
      atualizarEstatisticas() {
        this.stats = {
          total: this.dados.length,
          hoje: 0,
          veiculos: new Set(),
          motoristas: new Set(),
          tipos: {}
        };
        
        const hoje = new Date().toISOString().split('T')[0];
        
        this.dados.forEach(nc => {
          if (nc.dataOcorrencia && nc.dataOcorrencia.includes(hoje)) {
            this.stats.hoje++;
          }
          
          if (nc.veiculo) this.stats.veiculos.add(nc.veiculo);
          
          if (nc.nomeCondutor) this.stats.motoristas.add(nc.nomeCondutor);
          
          const tipo = this.classificarTipoNC(nc.naoConformidade);
          this.stats.tipos[tipo] = (this.stats.tipos[tipo] || 0) + 1;
        });
        
        document.getElementById('ncTotal').textContent = this.stats.total;
        document.getElementById('ncHoje').textContent = this.stats.hoje;
        document.getElementById('ncVeiculos').textContent = this.stats.veiculos.size;
        document.getElementById('ncMotoristas').textContent = this.stats.motoristas.size;
        
        this.atualizarPeriodo();
      },
      
      atualizarPeriodo() {
        if (this.dados.length === 0) {
          document.getElementById('ncPeriodo').textContent = 'Sem dados';
          return;
        }
        
        const datas = this.dados
          .map(nc => nc.dataOcorrencia)
          .filter(data => data)
          .map(data => {
            try {
              return new Date(data.split(' ')[0]);
            } catch {
              return null;
            }
          })
          .filter(data => data && !isNaN(data.getTime()));
        
        if (datas.length === 0) {
          document.getElementById('ncPeriodo').textContent = 'Datas indispon√≠veis';
          return;
        }
        
        const minData = new Date(Math.min(...datas));
        const maxData = new Date(Math.max(...datas));
        
        const formatarDataBR = (data) => {
          return data.toLocaleDateString('pt-BR');
        };
        
        document.getElementById('ncPeriodo').textContent = 
          `${formatarDataBR(minData)} √† ${formatarDataBR(maxData)}`;
      },
      
      aplicarFiltros() {
        const tipo = document.getElementById('ncTipoFilter').value;
        const veiculo = document.getElementById('ncVeiculoFilter').value.toLowerCase();
        const motorista = document.getElementById('ncMotoristaFilter').value.toLowerCase();
        const data = document.getElementById('ncDataFilter').value;
        
        this.filteredData = this.dados.filter(nc => {
          let match = true;
          
          if (tipo !== 'all') {
            const ncTipo = this.classificarTipoNC(nc.naoConformidade);
            match = match && ncTipo === tipo;
          }
          
          if (veiculo) {
            match = match && nc.veiculo.toLowerCase().includes(veiculo);
          }
          
          if (motorista) {
            match = match && nc.nomeCondutor.toLowerCase().includes(motorista);
          }
          
          if (data) {
            const ncData = nc.dataOcorrencia.split(' ')[0];
            match = match && ncData === data;
          }
          
          return match;
        });
        
        if (this.currentSort.column) {
          this.ordenarDados(this.currentSort.column, this.currentSort.direction);
        }
        
        document.getElementById('ncTotalCount').textContent = this.dados.length;
        document.getElementById('ncFilteredCount').textContent = this.filteredData.length;
      },
      
      ordenarDados(coluna, direcao) {
        this.filteredData.sort((a, b) => {
          let aVal = a[coluna] || '';
          let bVal = b[coluna] || '';
          
          if (coluna === 'dataOcorrencia') {
            aVal = new Date(aVal);
            bVal = new Date(bVal);
          }
          
          if (typeof aVal === 'string') {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
          }
          
          if (aVal < bVal) return direcao === 'asc' ? -1 : 1;
          if (aVal > bVal) return direcao === 'asc' ? 1 : -1;
          return 0;
        });
      },
      
      renderizarTabela() {
        const tbody = document.getElementById('ncTableBody');
        
        if (this.filteredData.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                Nenhuma n√£o conformidade encontrada com os filtros aplicados.
              </td>
            </tr>
          `;
          return;
        }
        
        tbody.innerHTML = this.filteredData.map(nc => {
          const naoConformidade = nc.naoConformidade || '-';
          const naoConformidadeTexto = typeof naoConformidade === 'string' 
            ? naoConformidade.substring(0, 60) + (naoConformidade.length > 60 ? '...' : '')
            : '-';
          
          const tipoNC = nc.tipoNC || 'outros';
          
          return `
            <tr>
              <td><strong>${nc.viagem || '-'}</strong></td>
              <td><span class="vehicle-plate">${nc.veiculo || '-'}</span></td>
              <td>${nc.nomeCondutor || '-'}</td>
              <td>
                <span style="font-size: 11px; color: var(--text-secondary);">
                  ${naoConformidadeTexto}
                </span>
                <br>
                <small style="color: var(--primary-red); font-size: 10px;">
                  ${this.obterTipoNC(tipoNC)}
                </small>
              </td>
              <td>${this.formatarDataParaExibicao(nc.dataOcorrencia)}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn-edit" onclick="ncVerDetalhes('${nc.id || ''}')" title="Ver detalhes">
                    üëÅÔ∏è Ver
                  </button>
                  ${firebaseAuth.hasNCPermission() ? `
                  <button class="btn-delete" onclick="ncExcluir('${nc.id || ''}')" title="Excluir">
                    üóëÔ∏è Excluir
                  </button>
                  ` : ''}
                </div>
              </td>
            </tr>
          `;
        }).join('');
        
        document.getElementById('ncLastUpdateTime').textContent = 
          new Date().toLocaleString('pt-BR');
      },
      
      formatarDataParaExibicao(dataString) {
        if (!dataString) return '-';

        if (/^\d+(?:\.\d+)?$/.test(String(dataString).trim())) {
          const serial = parseFloat(String(dataString).trim());
          const ms = (serial - 25569) * 86400 * 1000;
          const d = new Date(ms);
          if (!isNaN(d.getTime())) {
            const dia = String(d.getDate()).padStart(2, '0');
            const mes = String(d.getMonth() + 1).padStart(2, '0');
            const ano = d.getFullYear();
            const hh = String(d.getHours()).padStart(2, '0');
            const min = String(d.getMinutes()).padStart(2, '0');
            return hh || min ? `${dia}/${mes}/${ano} ${hh}:${min}` : `${dia}/${mes}/${ano}`;
          }
        }

        try {
          const [data, hora] = String(dataString).split(' ');
          if (!data) return String(dataString);
          const parts = data.split('-');
          if (parts.length === 3) {
            const [ano, mes, dia] = parts;
            if (hora) return `${dia}/${mes}/${ano} ${hora}`;
            return `${dia}/${mes}/${ano}`;
          }

          const maybe = new Date(String(dataString));
          if (!isNaN(maybe.getTime())) {
            const dia = String(maybe.getDate()).padStart(2, '0');
            const mes = String(maybe.getMonth() + 1).padStart(2, '0');
            const ano = maybe.getFullYear();
            const hh = String(maybe.getHours()).padStart(2, '0');
            const min = String(maybe.getMinutes()).padStart(2, '0');
            return hh || min ? `${dia}/${mes}/${ano} ${hh}:${min}` : `${dia}/${mes}/${ano}`;
          }
        } catch (e) {
          // fallback to raw
        }

        return String(dataString);
      },
      
      obterTipoNC(tipo) {
        const tipos = {
          'inicio_sem_ok': 'In√≠cio sem OK GS',
          'nao_informado': 'In√≠cio N√£o Informado',
          'dados_incorretos': 'SM Dados Incorretos',
          'movimento_indevido': 'Movimento Indevido',
          'isca_problema': 'Isca com Problema',
          'interacao_cliente': 'Intera√ß√£o do Cliente',
          'fim_nao_informado': 'Fim N√£o Informado',
          'sm_atrasada': 'SM Enviada Atrasada',
          'fora_romaneio': 'Fora do Romaneio',
          'perda_sinal': 'Perda de Sinal',
          'chegada_nao_info': 'Chegada N√£o Informada',
          'outros': 'Outros'
        };
        
        return tipos[tipo] || tipo;
      },
      
      verDetalhes(id) {
        const nc = this.dados.find(item => item.id === id);
        if (!nc) return;
        
        const modal = document.getElementById('ncViewModal');
        const content = document.getElementById('ncViewContent');
        
        const naoConformidade = nc.naoConformidade || '-';
        const tipoNC = nc.tipoNC || 'outros';
        
        content.innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div class="stat-item-detailed">
              <span class="stat-label">Viagem</span>
              <span class="stat-value">${nc.viagem || '-'}</span>
            </div>
            <div class="stat-item-detailed">
              <span class="stat-label">Ve√≠culo</span>
              <span class="stat-value">${nc.veiculo || '-'}</span>
            </div>
            <div class="stat-item-detailed">
              <span class="stat-label">Motorista</span>
              <span class="stat-value">${nc.nomeCondutor || '-'}</span>
            </div>
            <div class="stat-item-detailed">
              <span class="stat-label">CPF</span>
              <span class="stat-value">${nc.cpfCondutor || '-'}</span>
            </div>
          </div>
          
          <div style="background: var(--bg-secondary); padding: 15px; border-radius: var(--radius-sm); margin-bottom: 15px;">
            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">N√£o Conformidade</div>
            <div style="font-weight: 600; color: var(--primary-red);">${naoConformidade}</div>
            <div style="font-size: 11px; color: var(--gray-text); margin-top: 5px;">
              Tipo: <strong>${this.obterTipoNC(tipoNC)}</strong>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <div style="font-size: 12px; color: var(--text-secondary);">Origem</div>
              <div>${nc.origem || '-'}</div>
            </div>
            <div>
              <div style="font-size: 12px; color: var(--text-secondary);">Destino</div>
              <div>${nc.destino || '-'}</div>
            </div>
          </div>
          
          <div style="margin-bottom: 15px;">
            <div style="font-size: 12px; color: var(--text-secondary);">Data da Ocorr√™ncia</div>
            <div>${this.formatarDataParaExibicao(nc.dataOcorrencia)}</div>
          </div>
          
          <div style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 15px;">
            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 10px;">Informa√ß√µes Adicionais</div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 12px;">
              <div>
                <div style="color: var(--text-secondary);">Embarcador</div>
                <div>${nc.embarcador || '-'}</div>
              </div>
              <div>
                <div style="color: var(--text-secondary);">Cliente</div>
                <div>${nc.cliente || '-'}</div>
              </div>
              <div>
                <div style="color: var(--text-secondary);">Importado em</div>
                <div>${nc.importadoEm || '-'}</div>
              </div>
            </div>
          </div>
        `;
        
        modal.style.display = 'flex';
      },
      
      async excluir(id) {
        try {
          // Verificar permiss√µes
          await ncPermissaoMiddleware.verificarAdminOuManager();
          
          if (!confirm('üóëÔ∏è Tem certeza que deseja excluir esta n√£o conformidade?\n\nEsta a√ß√£o n√£o pode ser desfeita.')) {
            return;
          }
          
          await firebaseService.database.ref(`nc_dados/registros/${id}`).remove();
          
          this.dados = this.dados.filter(item => item.id !== id);
          this.atualizarEstatisticas();
          this.aplicarFiltros();
          this.renderizarTabela();
          
          showNotification('‚úÖ NC exclu√≠da com sucesso', 'success');
          
          syncLog.add('nc_delete', `NC ${id} exclu√≠da`, {
            usuario: firebaseAuth.currentUser?.email
          });
          
          // Atualizar dashboard
          if (document.getElementById('tabDashboard').classList.contains('active')) {
            atualizarDashboard();
          }
          
        } catch (error) {
          console.error('‚ùå Erro ao excluir NC:', error);
          
          if (error.message.includes('Acesso negado') || error.message.includes('Role')) {
            showNotification('üîí Apenas ADMIN ou MANAGER podem excluir NCs', 'error');
          } else {
            showNotification(`‚ùå Erro ao excluir NC: ${error.message}`, 'error');
          }
        }
      }
    };

    // ============================================
    // üìä M√ìDULO DASHBOARD DE AN√ÅLISE
    // ============================================
    const dashboardModule = {
      periodo: '7d',
      charts: {},
      
      inicializar() {
        console.log('üìä Inicializando dashboard (VERS√ÉO SEGURA)...');
        
        // N√ÉO inicializar gr√°ficos automaticamente
        // S√≥ configurar per√≠odo
        this.periodo = '7d';
        
        console.log('‚úÖ Dashboard configurado (gr√°ficos ser√£o criados quando a aba for clicada)');
      },
      
      inicializarGraficos() {
        // Gr√°fico 1: Distribui√ß√£o por Tipo
        const ctxTipoNC = document.getElementById('chartTipoNC').getContext('2d');
        this.charts.chartTipoNC = new Chart(ctxTipoNC, {
          type: 'bar',
          data: {
            labels: ['Carregando...'],
            datasets: [{
              label: 'NCs por Tipo',
              data: [0],
              backgroundColor: '#ff0000'
            }]
          },
          options: this.getChartOptions('Distribui√ß√£o por Tipo de NC')
        });
        
        // Gr√°fico 2: Evolu√ß√£o Temporal
        const ctxEvolucao = document.getElementById('chartEvolucao').getContext('2d');
        this.charts.chartEvolucao = new Chart(ctxEvolucao, {
          type: 'line',
          data: {
            labels: ['Carregando...'],
            datasets: [{
              label: 'NCs por Dia',
              data: [0],
              borderColor: '#2196f3',
              backgroundColor: 'rgba(33, 150, 243, 0.1)',
              fill: true
            }]
          },
          options: this.getChartOptions('Evolu√ß√£o Temporal')
        });
        
        // Gr√°fico 3: Top Ve√≠culos
        const ctxTopVeiculos = document.getElementById('chartTopVeiculos').getContext('2d');
        this.charts.chartTopVeiculos = new Chart(ctxTopVeiculos, {
          type: 'bar',
          data: {
            labels: ['Carregando...'],
            datasets: [{
              label: 'NCs por Ve√≠culo',
              data: [0],
              backgroundColor: '#ff9800'
            }]
          },
          options: this.getChartOptions('Top Ve√≠culos')
        });
        
        // Gr√°fico 4: Top Motoristas
        const ctxTopMotoristas = document.getElementById('chartTopMotoristas').getContext('2d');
        this.charts.chartTopMotoristas = new Chart(ctxTopMotoristas, {
          type: 'bar',
          data: {
            labels: ['Carregando...'],
            datasets: [{
              label: 'NCs por Motorista',
              data: [0],
              backgroundColor: '#9c27b0'
            }]
          },
          options: this.getChartOptions('Top Motoristas')
        });
        
        // Gr√°fico 5: Dia da Semana
        const ctxDiaSemana = document.getElementById('chartDiaSemana').getContext('2d');
        this.charts.chartDiaSemana = new Chart(ctxDiaSemana, {
          type: 'pie',
          data: {
            labels: ['Carregando...'],
            datasets: [{
              label: 'NCs por Dia da Semana',
              data: [0],
              backgroundColor: [
                '#ff0000', '#ff9800', '#2196f3', '#4caf50',
                '#9c27b0', '#00bcd4', '#ffc107'
              ]
            }]
          },
          options: this.getChartOptions('NCs por Dia da Semana')
        });
        
        // Gr√°fico 6: Comparativo
        const ctxComparativo = document.getElementById('chartComparativo').getContext('2d');
        this.charts.chartComparativo = new Chart(ctxComparativo, {
          type: 'bar',
          data: {
            labels: ['Per√≠odo Atual', 'Per√≠odo Anterior'],
            datasets: [{
              label: 'Total de NCs',
              data: [0, 0],
              backgroundColor: ['#ff0000', '#ff9800']
            }]
          },
          options: this.getChartOptions('Comparativo Per√≠odos')
        });
      },
      
      getChartOptions(title) {
        return {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: false,
              text: title
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        };
      },
      
      atualizarDashboard() {
        if (ncModule.dados.length === 0) {
          this.mostrarMensagemSemDados();
          return;
        }
        
        console.log('üìä Atualizando dashboard com', ncModule.dados.length, 'NCs');
        
        // Atualizar m√©tricas principais
        this.atualizarMetricas();
        
        // Atualizar gr√°ficos
        this.atualizarGraficoDistribuicaoTipo();
        this.atualizarGraficoEvolucaoTemporal();
        this.atualizarGraficoTopVeiculos();
        this.atualizarGraficoTopMotoristas();
        this.atualizarGraficoDiaSemana();
        this.atualizarGraficoComparativo();
        
        // Atualizar lista top
        this.atualizarListasTop();
        
        // Atualizar timestamp
        document.getElementById('dashboardLastUpdateTime').textContent = 
          new Date().toLocaleString('pt-BR');
      },
      
      mostrarMensagemSemDados() {
        Object.values(this.charts).forEach(chart => {
          chart.data.labels = ['Sem dados'];
          chart.data.datasets[0].data = [0];
          chart.update();
        });
        
        document.getElementById('dashboardTotalNCs').textContent = '0';
        document.getElementById('dashboardMediaDiaria').textContent = '0';
        document.getElementById('dashboardTopVeiculo').textContent = '-';
        document.getElementById('dashboardTopMotorista').textContent = '-';
        
        const containers = document.querySelectorAll('.top-list');
        containers.forEach(container => {
          container.innerHTML = '<div class="top-item"><span class="top-name">Sem dados dispon√≠veis</span></div>';
        });
      },
      
      atualizarMetricas() {
        const dados = this.filtrarPorPeriodo(ncModule.dados);
        const total = dados.length;

        console.log(`üìä M√©tricas - Per√≠odo: ${this.periodo}`);
        console.log(`üìä Total de NCs no per√≠odo: ${total}`);

        // Calcular m√©dia di√°ria
        const dias = this.getDiasNoPeriodo();
        const mediaDiaria = dias > 0 ? (total / dias).toFixed(1) : '0';

        console.log(`üìä Dias no per√≠odo: ${dias}`);
        console.log(`üìä M√©dia di√°ria: ${mediaDiaria}`);
        
        // Encontrar ve√≠culo com mais NCs
        const veiculoCounts = {};
        const motoristaCounts = {};
        
        dados.forEach(nc => {
          if (nc.veiculo) {
            veiculoCounts[nc.veiculo] = (veiculoCounts[nc.veiculo] || 0) + 1;
          }
          if (nc.nomeCondutor) {
            motoristaCounts[nc.nomeCondutor] = (motoristaCounts[nc.nomeCondutor] || 0) + 1;
          }
        });
        
        const topVeiculo = Object.entries(veiculoCounts).sort((a, b) => b[1] - a[1])[0];
        const topMotorista = Object.entries(motoristaCounts).sort((a, b) => b[1] - a[1])[0];
        
        // Atualizar elementos DOM
        document.getElementById('dashboardTotalNCs').textContent = total;
        document.getElementById('dashboardMediaDiaria').textContent = mediaDiaria;
        document.getElementById('dashboardTopVeiculo').textContent = topVeiculo ? `${topVeiculo[0]} (${topVeiculo[1]})` : '-';
        document.getElementById('dashboardTopMotorista').textContent = topMotorista ? `${topMotorista[0].substring(0, 15)}... (${topMotorista[1]})` : '-';
        
        // Atualizar per√≠odo exibido
        const periodoText = this.getPeriodoTexto();
        document.getElementById('dashboardPeriodo').textContent = periodoText;
      },

      parseNcDate(value) {
        if (!value && value !== 0) return null;
        try {
          if (Object.prototype.toString.call(value) === '[object Date]') {
            return isNaN(value.getTime()) ? null : new Date(value.getTime());
          }

          if (typeof value === 'number') {
            if (value > 1e12) return new Date(value);
            const ms = (value - 25569) * 86400 * 1000;
            const d = new Date(ms);
            return isNaN(d.getTime()) ? null : d;
          }

          const s = String(value).trim();
          if (!s) return null;

          if (/^\d+(?:\.\d+)?$/.test(s)) {
            const v = parseFloat(s);
            if (v > 1e12) return new Date(v);
            const ms = (v - 25569) * 86400 * 1000;
            const d = new Date(ms);
            if (!isNaN(d.getTime())) return d;
          }

          if (s.includes('/')) {
            const parts = s.split(' ');
            const datePart = parts[0];
            const timePart = parts[1] || '';
            const comps = datePart.split('/');
            if (comps.length === 3) {
              const dia = parseInt(comps[0],10);
              const mes = parseInt(comps[1],10) - 1;
              const ano = parseInt(comps[2],10);
              const d = new Date(ano, mes, dia);
              if (!isNaN(d.getTime())) {
                if (timePart) {
                  const [hh, mm] = timePart.split(':').map(x=>parseInt(x,10)||0);
                  d.setHours(hh, mm);
                }
                return d;
              }
            }
          }

          const iso = new Date(s);
          if (!isNaN(iso.getTime())) return iso;
        } catch (e) {
          console.warn('parseNcDate error', e, value);
        }
        return null;
      },
      
      filtrarPorPeriodo(dados) {
        const agora = new Date();
        let dataLimite = new Date();

        switch(this.periodo) {
          case '7d':
            dataLimite.setDate(agora.getDate() - 7);
            break;
          case '30d':
            dataLimite.setDate(agora.getDate() - 30);
            break;
          case '60d':
            dataLimite.setDate(agora.getDate() - 60);
            break;
          case '90d':
            dataLimite.setDate(agora.getDate() - 90);
            break;
          case 'all':
            return dados;
        }

        dataLimite.setHours(0,0,0,0);

        console.log(`üìÖ Filtrando ${dados.length} registros por per√≠odo: ${this.periodo}`);
        console.log(`üìä Data limite: ${dataLimite.toLocaleDateString('pt-BR')}`);

        const dadosFiltrados = dados.filter(nc => {
          try {
            const d = this.parseNcDate(nc.dataOcorrencia);
            if (!d) return false;
            const filtroAtivo = d >= dataLimite;
            return filtroAtivo;
          } catch (e) {
            return false;
          }
        });

        console.log(`‚úÖ Filtrados: ${dadosFiltrados.length} de ${dados.length} registros`);
        return dadosFiltrados;
      },
      
      getDiasNoPeriodo() {
        switch(this.periodo) {
          case '7d': return 7;
          case '30d': return 30;
          case '60d': return 60;
          case '90d': return 90;
          case 'all': 
            if (ncModule.dados.length === 0) return 1;
            const datas = ncModule.dados
              .map(nc => this.parseNcDate(nc.dataOcorrencia))
              .filter(d => d && !isNaN(d.getTime()));

            if (datas.length === 0) return 1;

            const minData = new Date(Math.min(...datas.map(d=>d.getTime())));
            const maxData = new Date(Math.max(...datas.map(d=>d.getTime())));
            const diffTime = Math.abs(maxData - minData);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(diffDays, 1);
        }
      },
      
      getPeriodoTexto() {
        switch(this.periodo) {
          case '7d': return '√öltimos 7 dias';
          case '30d': return '√öltimos 30 dias';
          case '90d': return '√öltimos 90 dias';
          case 'all': return 'Todo per√≠odo dispon√≠vel';
        }
      },
      
      atualizarGraficoDistribuicaoTipo() {
        const dados = this.filtrarPorPeriodo(ncModule.dados);
        
        // Agrupar por tipo
        const tiposCount = {};
        dados.forEach(nc => {
          const tipo = nc.tipoNC || 'outros';
          tiposCount[tipo] = (tiposCount[tipo] || 0) + 1;
        });
        
        // Ordenar por quantidade
        const tiposOrdenados = Object.entries(tiposCount)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);
        
        const labels = tiposOrdenados.map(([tipo, _]) => ncModule.obterTipoNC(tipo));
        const data = tiposOrdenados.map(([_, count]) => count);
        
        // Cores din√¢micas
        const colors = this.generateColors(labels.length);
        
        const chart = this.charts.chartTipoNC;
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.data.datasets[0].backgroundColor = colors;
        chart.update();
      },
      
      atualizarGraficoEvolucaoTemporal() {
        const dados = this.filtrarPorPeriodo(ncModule.dados);
        
        // Agrupar por dia usando parseNcDate
        const diasMap = new Map();
        dados.forEach(nc => {
          try {
            const date = this.parseNcDate(nc.dataOcorrencia);
            if (!date) return;
            const key = date.toISOString().split('T')[0];
            diasMap.set(key, (diasMap.get(key) || 0) + 1);
          } catch {
            // Ignora datas inv√°lidas
          }
        });
        
        // Ordenar por data
        const diasOrdenados = Array.from(diasMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));

        // Determinar quantos dias mostrar
        const diasDisponiveis = diasOrdenados.length;
        const diasSolicitados = (typeof this.getDiasNoPeriodo === 'function') ? Math.max(1, this.getDiasNoPeriodo()) : 30;
        const diasParaMostrar = Math.min(diasSolicitados, diasDisponiveis);
        const diasOrdenadosCortados = diasOrdenados.slice(-diasParaMostrar);

        const labels = diasOrdenadosCortados.map(([data, _]) => {
          const date = new Date(data);
          return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        });
        const data = diasOrdenadosCortados.map(([_, count]) => count);
        
        const chart = this.charts.chartEvolucao;
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update();
      },
      
      atualizarGraficoTopVeiculos() {
        const dados = this.filtrarPorPeriodo(ncModule.dados);
        
        // Contar por ve√≠culo
        const veiculoCounts = {};
        dados.forEach(nc => {
          if (nc.veiculo) {
            veiculoCounts[nc.veiculo] = (veiculoCounts[nc.veiculo] || 0) + 1;
          }
        });
        
        // Top 10 ve√≠culos
        const topVeiculos = Object.entries(veiculoCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);
        
        const labels = topVeiculos.map(([veiculo, _]) => veiculo);
        const data = topVeiculos.map(([_, count]) => count);
        
        const chart = this.charts.chartTopVeiculos;
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update();
      },
      
      atualizarGraficoTopMotoristas() {
        const dados = this.filtrarPorPeriodo(ncModule.dados);
        
        // Contar por motorista
        const motoristaCounts = {};
        dados.forEach(nc => {
          if (nc.nomeCondutor) {
            motoristaCounts[nc.nomeCondutor] = (motoristaCounts[nc.nomeCondutor] || 0) + 1;
          }
        });
        
        // Top 10 motoristas
        const topMotoristas = Object.entries(motoristaCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);
        
        const labels = topMotoristas.map(([motorista, _]) => 
          motorista.length > 15 ? motorista.substring(0, 15) + '...' : motorista
        );
        const data = topMotoristas.map(([_, count]) => count);
        
        const chart = this.charts.chartTopMotoristas;
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update();
      },
      
      atualizarGraficoDiaSemana() {
        const dados = this.filtrarPorPeriodo(ncModule.dados);
        
        // Contar por dia da semana
        const diasSemana = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
        const counts = [0, 0, 0, 0, 0, 0, 0];
        
        dados.forEach(nc => {
          if (!nc.dataOcorrencia) return;
          
          try {
            const date = new Date(nc.dataOcorrencia.split(' ')[0]);
            const diaSemana = date.getDay();
            counts[diaSemana]++;
          } catch {
            // Ignora datas inv√°lidas
          }
        });
        
        const chart = this.charts.chartDiaSemana;
        chart.data.labels = diasSemana;
        chart.data.datasets[0].data = counts;
        chart.update();
      },
      
      atualizarGraficoComparativo() {
        const dadosAtuais = this.filtrarPorPeriodo(ncModule.dados);
        const totalAtual = dadosAtuais.length;
        
        // Calcular per√≠odo anterior
        let totalAnterior = 0;
        if (this.periodo !== 'all') {
          const dias = this.periodo === '7d' ? 7 : this.periodo === '30d' ? 30 : 90;
          const dataInicioAnterior = new Date();
          dataInicioAnterior.setDate(dataInicioAnterior.getDate() - (dias * 2));
          const dataFimAnterior = new Date();
          dataFimAnterior.setDate(dataFimAnterior.getDate() - dias);
          
          totalAnterior = ncModule.dados.filter(nc => {
            if (!nc.dataOcorrencia) return false;
            try {
              const dataNC = new Date(nc.dataOcorrencia.split(' ')[0]);
              return dataNC >= dataInicioAnterior && dataNC < dataFimAnterior;
            } catch {
              return false;
            }
          }).length;
        }
        
        const chart = this.charts.chartComparativo;
        chart.data.datasets[0].data = [totalAtual, totalAnterior];
        chart.update();
      },
      
      atualizarListasTop() {
        const dados = this.filtrarPorPeriodo(ncModule.dados);
        
        // Top Tipos
        const tiposCount = {};
        dados.forEach(nc => {
          const tipo = nc.tipoNC || 'outros';
          tiposCount[tipo] = (tiposCount[tipo] || 0) + 1;
        });
        
        const topTipos = Object.entries(tiposCount)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);
        
        document.getElementById('topTiposNC').innerHTML = topTipos.map(([tipo, count]) => `
          <div class="top-item">
            <span class="top-name">${ncModule.obterTipoNC(tipo)}</span>
            <span class="top-count">${count}</span>
          </div>
        `).join('');
        
        // Top Ve√≠culos
        const veiculoCounts = {};
        dados.forEach(nc => {
          if (nc.veiculo) {
            veiculoCounts[nc.veiculo] = (veiculoCounts[nc.veiculo] || 0) + 1;
          }
        });
        
        const topVeiculos = Object.entries(veiculoCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);
        
        document.getElementById('topVeiculosList').innerHTML = topVeiculos.map(([veiculo, count]) => `
          <div class="top-item">
            <span class="top-name">${veiculo}</span>
            <span class="top-count">${count}</span>
          </div>
        `).join('');
        
        // Top Motoristas
        const motoristaCounts = {};
        dados.forEach(nc => {
          if (nc.nomeCondutor) {
            motoristaCounts[nc.nomeCondutor] = (motoristaCounts[nc.nomeCondutor] || 0) + 1;
          }
        });
        
        const topMotoristas = Object.entries(motoristaCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);
        
        document.getElementById('topMotoristasList').innerHTML = topMotoristas.map(([motorista, count]) => `
          <div class="top-item">
            <span class="top-name">${motorista.length > 20 ? motorista.substring(0, 20) + '...' : motorista}</span>
            <span class="top-count">${count}</span>
          </div>
        `).join('');
      },
      
      atualizarTodosGraficos() {
        const tipo = document.getElementById('dashboardChartType').value;
        
        // Atualizar tipo de gr√°fico para todos
        Object.values(this.charts).forEach(chart => {
          chart.config.type = tipo;
          chart.update();
        });
      },
      
      generateColors(count) {
        const colors = [];
        for (let i = 0; i < count; i++) {
          const hue = (i * 360) / count;
          colors.push(`hsl(${hue}, 70%, 60%)`);
        }
        return colors;
      }
    };

    // ============================================
    // üîç SISTEMA DE DIAGN√ìSTICO COMPLETO
    // ============================================
    const diagnosticoSistema = {
      
      // Executar diagn√≥stico completo
      async executarDiagnosticoCompleto() {
        try {
          showNotification('üîç Iniciando diagn√≥stico do sistema...', 'info');
          
          const resultado = {
            timestamp: new Date().toISOString(),
            usuario: firebaseAuth.currentUser?.email || 'N√£o autenticado',
            modules: {},
            problemas: [],
            sugestoes: []
          };
          
          // 1. DIAGN√ìSTICO DE AUTENTICA√á√ÉO
          resultado.modules.autenticacao = await this.diagnosticarAutenticacao();
          
          // 2. DIAGN√ìSTICO DE DADOS
          resultado.modules.dados = await this.diagnosticarDados();
          
          // 3. DIAGN√ìSTICO DE CONEX√ÉO
          resultado.modules.conexao = await this.diagnosticarConexao();
          
          // 4. DIAGN√ìSTICO DE PERMISS√ïES
          resultado.modules.permissoes = await this.diagnosticarPermissoes();
          
          // 5. DIAGN√ìSTICO DE ARMAZENAMENTO
          resultado.modules.armazenamento = await this.diagnosticarArmazenamento();
          
          // 6. AN√ÅLISE DE PROBLEMAS
          resultado.problemas = this.analisarProblemas(resultado.modules);
          
          // 7. SUGEST√ïES DE CORRE√á√ÉO
          resultado.sugestoes = this.gerarSugestoes(resultado.problemas);
          
          // 8. EXIBIR RESULTADO
          this.exibirResultadoDiagnostico(resultado);
          
          // 9. SALVAR NO LOG
          syncLog.add('diagnostico', 'Diagn√≥stico completo executado', resultado);
          
          showNotification('‚úÖ Diagn√≥stico conclu√≠do!', 'success');
          
          return resultado;
          
        } catch (error) {
          console.error('‚ùå Erro no diagn√≥stico:', error);
          showNotification(`‚ùå Erro no diagn√≥stico: ${error.message}`, 'error');
          return null;
        }
      },
      
      // 1. Diagn√≥stico de Autentica√ß√£o
      async diagnosticarAutenticacao() {
        const diagnostico = {
          status: 'verificando',
          usuario: null,
          firebaseAuth: null,
          role: null,
          problemas: []
        };
        
        try {
          // Usu√°rio Firebase Auth
          const authUser = firebase.auth().currentUser;
          diagnostico.usuario = {
            email: authUser?.email || 'N/A',
            uid: authUser?.uid || 'N/A',
            autenticado: !!authUser
          };
          
          // Usu√°rio no firebaseAuth
          diagnostico.firebaseAuth = {
            email: firebaseAuth.currentUser?.email || 'N/A',
            role: firebaseAuth.currentUser?.role || 'N/A',
            displayName: firebaseAuth.currentUser?.displayName || 'N/A'
          };
          
          // Verificar consist√™ncia
          if (authUser && firebaseAuth.currentUser) {
            if (authUser.email !== firebaseAuth.currentUser.email) {
              diagnostico.problemas.push('Email diferente entre Firebase Auth e firebaseAuth');
            }
            
            if (!firebaseAuth.currentUser.role) {
              diagnostico.problemas.push('Role n√£o definida no firebaseAuth');
            }
          }
          
          // Verificar token
          if (authUser) {
            try {
              const token = await authUser.getIdToken();
              diagnostico.tokenValido = !!token;
            } catch (e) {
              diagnostico.problemas.push('Token inv√°lido ou expirado');
              diagnostico.tokenValido = false;
            }
          }
          
          diagnostico.status = diagnostico.problemas.length > 0 ? 'problemas' : 'ok';
          
        } catch (error) {
          diagnostico.status = 'erro';
          diagnostico.erro = error.message;
        }
        
        return diagnostico;
      },
      
      // 2. Diagn√≥stico de Dados
      async diagnosticarDados() {
        const diagnostico = {
          status: 'verificando',
          veiculos: {},
          nc: {},
          problemas: []
        };
        
        try {
          // Dados de Ve√≠culos
          diagnostico.veiculos = {
            local: vehicleData?.length || 0,
            firebase: appStats.firebaseCount || 0,
            diferenca: Math.abs((vehicleData?.length || 0) - (appStats.firebaseCount || 0))
          };
          
          // Verificar consist√™ncia
          if (diagnostico.veiculos.diferenca > 0) {
            diagnostico.problemas.push(`Diferen√ßa de ${diagnostico.veiculos.diferenca} ve√≠culos entre local e Firebase`);
          }
          
          if (vehicleData?.length === 0 && appStats.firebaseCount > 0) {
            diagnostico.problemas.push('Dados locais vazios mas Firebase tem dados');
          }
          
          // Dados de N√£o Conformidades
          diagnostico.nc = {
            local: ncModule.dados?.length || 0,
            carregado: ncModule.dados?.length > 0
          };
          
          // Verificar qualidade dos dados
          if (vehicleData?.length > 0) {
            const problemasQualidade = this.verificarQualidadeDadosVeiculos();
            diagnostico.problemas.push(...problemasQualidade);
          }
          
          diagnostico.status = diagnostico.problemas.length > 0 ? 'problemas' : 'ok';
          
        } catch (error) {
          diagnostico.status = 'erro';
          diagnostico.erro = error.message;
        }
        
        return diagnostico;
      },
      
      // 3. Diagn√≥stico de Conex√£o
      async diagnosticarConexao() {
        const diagnostico = {
          status: 'verificando',
          firebase: {},
          internet: {},
          problemas: []
        };
        
        try {
          // Testar conex√£o Firebase
          const connectedRef = firebase.database().ref('.info/connected');
          const snapshot = await connectedRef.once('value');
          diagnostico.firebase = {
            conectado: snapshot.val() === true,
            timestamp: new Date().toISOString()
          };
          
          if (!diagnostico.firebase.conectado) {
            diagnostico.problemas.push('N√£o conectado ao Firebase');
          }
          
          // Testar conex√£o internet
          diagnostico.internet = {
            online: navigator.onLine,
            userAgent: navigator.userAgent.substring(0, 50)
          };
          
          if (!diagnostico.internet.online) {
            diagnostico.problemas.push('Sem conex√£o com internet');
          }
          
          // Testar Database
          try {
            const testRef = firebase.database().ref('.info/serverTimeOffset');
            const testSnapshot = await testRef.once('value');
            diagnostico.firebase.databaseAcessivel = true;
          } catch (e) {
            diagnostico.problemas.push('Database inacess√≠vel: ' + e.message);
            diagnostico.firebase.databaseAcessivel = false;
          }
          
          diagnostico.status = diagnostico.problemas.length > 0 ? 'problemas' : 'ok';
          
        } catch (error) {
          diagnostico.status = 'erro';
          diagnostico.erro = error.message;
        }
        
        return diagnostico;
      },
      
      // 4. Diagn√≥stico de Permiss√µes
      async diagnosticarPermissoes() {
        const diagnostico = {
          status: 'verificando',
          permissoes: {},
          problemas: []
        };
        
        try {
          // Verificar permissionManager
          diagnostico.permissoes.permissionManagerExiste = typeof permissionManager !== 'undefined';
          
          if (!diagnostico.permissoes.permissionManagerExiste) {
            diagnostico.problemas.push('Sistema de permiss√µes n√£o inicializado');
            diagnostico.status = 'erro';
            return diagnostico;
          }
          
          // Testar todas as permiss√µes
          diagnostico.permissoes.canAccessVehicles = permissionManager.canAccessVehicles();
          diagnostico.permissoes.canAccessNCs = permissionManager.canAccessNCs();
          diagnostico.permissoes.canWriteVehicles = permissionManager.canWriteVehicles();
          diagnostico.permissoes.canWriteNCs = permissionManager.canWriteNCs();
          diagnostico.permissoes.isAdmin = permissionManager.isAdmin();
          
          // Verificar role do usu√°rio
          const userRole = firebaseAuth.currentUser?.role;
          diagnostico.permissoes.role = userRole || 'N/A';
          
          if (!userRole || userRole === 'N/A') {
            diagnostico.problemas.push('Role do usu√°rio n√£o definida');
          }
          
          // Verificar se permiss√µes correspondem √† role
          if (userRole === 'ADMIN') {
            if (!diagnostico.permissoes.canAccessVehicles || !diagnostico.permissoes.canAccessNCs) {
              diagnostico.problemas.push('Usu√°rio ADMIN sem permiss√µes completas');
            }
          }
          
          diagnostico.status = diagnostico.problemas.length > 0 ? 'problemas' : 'ok';
          
        } catch (error) {
          diagnostico.status = 'erro';
          diagnostico.erro = error.message;
        }
        
        return diagnostico;
      },
      
      // 5. Diagn√≥stico de Armazenamento
      async diagnosticarArmazenamento() {
        const diagnostico = {
          status: 'verificando',
          localStorage: {},
          indexedDB: {},
          problemas: []
        };
        
        try {
          // LocalStorage
          try {
            const lsKeys = Object.keys(localStorage);
            diagnostico.localStorage = {
              habilitado: true,
              itens: lsKeys.length,
              usado: JSON.stringify(localStorage).length
            };
          } catch (e) {
            diagnostico.localStorage.habilitado = false;
            diagnostico.problemas.push('LocalStorage n√£o dispon√≠vel: ' + e.message);
          }
          
          // IndexedDB
          try {
            const db = await idb.open();
            diagnostico.indexedDB = {
              habilitado: true,
              nome: 'rondolog_db_v1'
            };
          } catch (e) {
            diagnostico.indexedDB.habilitado = false;
            diagnostico.problemas.push('IndexedDB n√£o dispon√≠vel: ' + e.message);
          }
          
          // Mem√≥ria do navegador
          diagnostico.memoria = {
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language
          };
          
          diagnostico.status = diagnostico.problemas.length > 0 ? 'problemas' : 'ok';
          
        } catch (error) {
          diagnostico.status = 'erro';
          diagnostico.erro = error.message;
        }
        
        return diagnostico;
      },
      
      // Verificar qualidade dos dados
      verificarQualidadeDadosVeiculos() {
        const problemas = [];
        
        if (!Array.isArray(vehicleData)) {
          problemas.push('vehicleData n√£o √© um array');
          return problemas;
        }
        
        let placasInvalidas = 0;
        let datasInvalidas = 0;
        let statusInvalidos = 0;
        
        vehicleData.forEach((veiculo, index) => {
          // Verificar placa
          if (!veiculo.placa || veiculo.placa.trim() === '') {
            placasInvalidas++;
          }
          
          // Verificar datas
          if (veiculo.vigenciaChecklist) {
            const data = new Date(veiculo.vigenciaChecklist);
            if (isNaN(data.getTime())) {
              datasInvalidas++;
            }
          }
          
          // Verificar status
          const statusValidos = ['OK', 'PENDENTE', 'VENCIDO'];
          if (!statusValidos.includes(veiculo.statusChecklist)) {
            statusInvalidos++;
          }
        });
        
        if (placasInvalidas > 0) {
          problemas.push(`${placasInvalidas} ve√≠culos com placa inv√°lida`);
        }
        
        if (datasInvalidas > 0) {
          problemas.push(`${datasInvalidas} ve√≠culos com data inv√°lida`);
        }
        
        if (statusInvalidos > 0) {
          problemas.push(`${statusInvalidos} ve√≠culos com status inv√°lido`);
        }
        
        return problemas;
      },
      
      // Analisar problemas
      analisarProblemas(modules) {
        const problemas = [];
        
        // Coletar todos os problemas
        Object.values(modules).forEach(module => {
          if (module.problemas && module.problemas.length > 0) {
            problemas.push(...module.problemas);
          }
        });
        
        return problemas;
      },
      
      // Gerar sugest√µes
      gerarSugestoes(problemas) {
        const sugestoes = [];
        
        problemas.forEach(problema => {
          if (problema.includes('permissionManager n√£o inicializado')) {
            sugestoes.push('Reinicie o sistema ou execute "Reparar Automaticamente"');
          }
          
          if (problema.includes('Role n√£o definida')) {
            sugestoes.push('Fa√ßa logout e login novamente para carregar as permiss√µes');
          }
          
          if (problema.includes('N√£o conectado ao Firebase')) {
            sugestoes.push('Verifique sua conex√£o com a internet e as regras do Firebase');
          }
          
          if (problema.includes('Diferen√ßa de ve√≠culos')) {
            sugestoes.push('Execute sincroniza√ß√£o manual nos Settings ‚Üí Sincroniza√ß√£o Firebase');
          }
          
          if (problema.includes('Dados locais vazios')) {
            sugestoes.push('Clique em "Carregar do Firebase" nos Settings');
          }
        });
        
        // Sugest√µes gerais
        if (sugestoes.length === 0 && problemas.length === 0) {
          sugestoes.push('‚úÖ Sistema funcionando corretamente!');
        } else {
          sugestoes.push('üí° Use o bot√£o "Reparar Automaticamente" para tentar corrigir os problemas');
        }
        
        return sugestoes;
      },
      
      // Exibir resultado
      exibirResultadoDiagnostico(resultado) {
        const container = document.getElementById('diagnosticoResultado');
        if (!container) return;
        
        let html = `
          <div style="background: var(--bg-secondary); padding: 15px; border-radius: var(--radius-sm); margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <strong>üîç Diagn√≥stico do Sistema</strong>
              <small>${new Date().toLocaleString('pt-BR')}</small>
            </div>
        `;
        
        // Resumo
        const totalProblemas = resultado.problemas.length;
        html += `
          <div style="background: ${totalProblemas > 0 ? '#fff3cd' : '#d4edda'}; 
                      padding: 10px; border-radius: var(--radius-sm); margin-bottom: 15px;">
            <strong>üìä Resumo:</strong>
            <div>Usu√°rio: ${resultado.usuario}</div>
            <div>Status: ${totalProblemas > 0 ? '‚ö†Ô∏è Com problemas' : '‚úÖ OK'}</div>
            <div>Problemas encontrados: ${totalProblemas}</div>
          </div>
        `;
        
        // M√≥dulos
        html += `<div style="margin-bottom: 15px;"><strong>üì¶ M√≥dulos:</strong></div>`;
        
        Object.entries(resultado.modules).forEach(([nome, modulo]) => {
          const icone = modulo.status === 'ok' ? '‚úÖ' : modulo.status === 'problemas' ? '‚ö†Ô∏è' : '‚ùå';
          html += `
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding: 8px; 
                        background: var(--bg-primary); border-radius: var(--radius-sm);">
              <span style="font-size: 20px;">${icone}</span>
              <div>
                <strong style="text-transform: capitalize;">${nome}</strong>
                <div style="font-size: 11px; color: var(--text-secondary);">
                  Status: ${modulo.status}
                  ${modulo.problemas?.length > 0 ? `(${modulo.problemas.length} problemas)` : ''}
                </div>
              </div>
            </div>
          `;
        });
        
        // Problemas
        if (resultado.problemas.length > 0) {
          html += `
            <div style="margin-top: 15px;">
              <strong>üö® Problemas encontrados (${resultado.problemas.length}):</strong>
              <div style="max-height: 150px; overflow-y: auto; margin-top: 8px;">
          `;
          
          resultado.problemas.forEach((problema, index) => {
            html += `
              <div style="font-size: 12px; padding: 6px 10px; background: #f8d7da; 
                          border-left: 3px solid #dc3545; margin-bottom: 4px; border-radius: 3px;">
                ${index + 1}. ${problema}
              </div>
            `;
          });
          
          html += `</div></div>`;
        }
        
        // Sugest√µes
        if (resultado.sugestoes.length > 0) {
          html += `
            <div style="margin-top: 15px;">
              <strong>üí° Sugest√µes:</strong>
              <div style="max-height: 150px; overflow-y: auto; margin-top: 8px;">
          `;
          
          resultado.sugestoes.forEach((sugestao, index) => {
            html += `
              <div style="font-size: 12px; padding: 6px 10px; background: #d1ecf1; 
                          border-left: 3px solid #17a2b8; margin-bottom: 4px; border-radius: 3px;">
                ${index + 1}. ${sugestao}
              </div>
            `;
          });
          
          html += `</div></div>`;
        }
        
        // Estat√≠sticas
        html += `
          <div style="margin-top: 15px; font-size: 11px; color: var(--text-secondary);">
            <strong>üìà Estat√≠sticas:</strong>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">
              <div>Ve√≠culos locais: ${resultado.modules.dados?.veiculos?.local || 0}</div>
              <div>Ve√≠culos Firebase: ${resultado.modules.dados?.veiculos?.firebase || 0}</div>
              <div>NCs carregadas: ${resultado.modules.dados?.nc?.local || 0}</div>
              <div>Sincroniza√ß√µes: ${appStats.saves || 0}</div>
            </div>
          </div>
        `;
        
        html += `</div>`;
        
        container.innerHTML = html;
      },
      
      // Exportar relat√≥rio
      exportarRelatorioDiagnostico() {
        const resultado = this.executarDiagnosticoCompleto();
        
        if (!resultado) {
          showNotification('‚ùå Execute o diagn√≥stico primeiro', 'warning');
          return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(16);
        doc.text('RONDOLOG - RELAT√ìRIO DE DIAGN√ìSTICO', 105, 15, { align: 'center' });
        
        doc.setFontSize(10);
        doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, 22, { align: 'center' });
        doc.text(`Usu√°rio: ${resultado.usuario}`, 105, 28, { align: 'center' });
        
        let y = 40;
        
        // Resumo
        doc.setFontSize(12);
        doc.text('üìä RESUMO DO DIAGN√ìSTICO', 20, y);
        y += 10;
        
        doc.setFontSize(10);
        doc.text(`Status: ${resultado.problemas.length > 0 ? 'COM PROBLEMAS' : 'OK'}`, 20, y);
        y += 6;
        doc.text(`Problemas encontrados: ${resultado.problemas.length}`, 20, y);
        y += 6;
        doc.text(`Sugest√µes: ${resultado.sugestoes.length}`, 20, y);
        y += 10;
        
        // M√≥dulos
        doc.setFontSize(12);
        doc.text('üì¶ STATUS DOS M√ìDULOS', 20, y);
        y += 10;
        
        Object.entries(resultado.modules).forEach(([nome, modulo]) => {
          const status = modulo.status === 'ok' ? '‚úÖ OK' : modulo.status === 'problemas' ? '‚ö†Ô∏è PROBLEMAS' : '‚ùå ERRO';
          doc.text(`${nome.toUpperCase()}: ${status}`, 20, y);
          y += 6;
        });
        
        y += 5;
        
        // Problemas
        if (resultado.problemas.length > 0) {
          doc.setFontSize(12);
          doc.text('üö® PROBLEMAS IDENTIFICADOS', 20, y);
          y += 10;
          
          doc.setFontSize(10);
          resultado.problemas.forEach((problema, index) => {
            if (y > 270) {
              doc.addPage();
              y = 20;
            }
            doc.text(`${index + 1}. ${problema}`, 20, y);
            y += 6;
          });
          
          y += 5;
        }
        
        // Sugest√µes
        if (resultado.sugestoes.length > 0) {
          doc.setFontSize(12);
          doc.text('üí° SUGEST√ïES DE CORRE√á√ÉO', 20, y);
          y += 10;
          
          doc.setFontSize(10);
          resultado.sugestoes.forEach((sugestao, index) => {
            if (y > 270) {
              doc.addPage();
              y = 20;
            }
            doc.text(`${index + 1}. ${sugestao}`, 20, y);
            y += 6;
          });
        }
        
        doc.save(`diagnostico_rondolog_${new Date().toISOString().split('T')[0]}.pdf`);
        
        showNotification('üìã Relat√≥rio de diagn√≥stico exportado!', 'success');
      },
      
      // Ver logs do sistema
      verLogsSistema() {
        const logs = syncLog.getRecent(20);
        
        let html = `<div style="max-height: 300px; overflow-y: auto;">`;
        html += `<strong>üìù √öltimos 20 logs do sistema:</strong><br><br>`;
        
        logs.forEach(log => {
          const data = new Date(log.timestamp).toLocaleTimeString('pt-BR');
          const tipo = log.type.toUpperCase();
          const icone = log.type.includes('error') ? '‚ùå' : 
                       log.type.includes('success') ? '‚úÖ' : 
                       'üìã';
          
          html += `
            <div style="font-size: 11px; padding: 5px; border-bottom: 1px solid var(--border-color);">
              <span style="color: var(--text-secondary);">${data}</span>
              <span style="margin: 0 5px;">${icone}</span>
              <strong>[${tipo}]</strong>
              ${log.message}
            </div>
          `;
        });
        
        html += `</div>`;
        
        alertPopup('üìã Logs do Sistema', html);
      },
      
      // Reparar problemas automaticamente
      async repararProblemasAutomaticamente() {
        showNotification('‚ö° Reparando problemas automaticamente...', 'info');
        
        const reparos = [];
        
        try {
          // 1. Recarregar dados do usu√°rio
          if (firebaseAuth.currentUser) {
            await firebaseAuth.fetchUserRole();
            reparos.push('‚úÖ Permiss√µes do usu√°rio recarregadas');
          }
          
          // 2. Recarregar dados do Firebase
          if (permissionManager.canAccessVehicles()) {
            await loadInitialData();
            reparos.push('‚úÖ Dados do Firebase recarregados');
          }
          
          // 3. Recarregar NCs
          if (permissionManager.canAccessNCs()) {
            await ncModule.carregarDoFirebase();
            reparos.push('‚úÖ NCs recarregadas');
          }
          
          // 4. For√ßar sincroniza√ß√£o
          appStats.lastSync = new Date().toISOString();
          saveConfig();
          reparos.push('‚úÖ Configura√ß√µes salvas');
          
          // 5. Executar diagn√≥stico novamente
          setTimeout(() => {
            this.executarDiagnosticoCompleto();
          }, 2000);
          
          // Mostrar resumo
          let mensagem = '‚ö° REPAROS EXECUTADOS:\n\n';
          reparos.forEach(reparo => {
            mensagem += `‚Ä¢ ${reparo}\n`;
          });
          
          alert(mensagem);
          showNotification('‚úÖ Reparos conclu√≠dos!', 'success');
          
        } catch (error) {
          console.error('‚ùå Erro nos reparos:', error);
          showNotification(`‚ùå Erro nos reparos: ${error.message}`, 'error');
        }
      }
    };

    // Fun√ß√µes globais para acesso f√°cil
    function executarDiagnosticoCompleto() {
      return diagnosticoSistema.executarDiagnosticoCompleto();
    }

    function exportarRelatorioDiagnostico() {
      return diagnosticoSistema.exportarRelatorioDiagnostico();
    }

    function verLogsSistema() {
      return diagnosticoSistema.verLogsSistema();
    }

    function repararProblemasAutomaticamente() {
      return diagnosticoSistema.repararProblemasAutomaticamente();
    }

    // Fun√ß√£o auxiliar para alertas customizados
    function alertPopup(title, content) {
      const modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100%';
      modal.style.height = '100%';
      modal.style.background = 'rgba(0,0,0,0.5)';
      modal.style.display = 'flex';
      modal.style.justifyContent = 'center';
      modal.style.alignItems = 'center';
      modal.style.zIndex = '9999';
      
      const box = document.createElement('div');
      box.style.background = 'var(--bg-primary)';
      box.style.padding = '20px';
      box.style.borderRadius = '10px';
      box.style.maxWidth = '500px';
      box.style.maxHeight = '80vh';
      box.style.overflow = 'auto';
      box.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
      
      box.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3 style="margin: 0;">${title}</h3>
          <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                  style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">
            √ó
          </button>
        </div>
        <div>${content}</div>
        <div style="margin-top: 20px; text-align: center;">
          <button onclick="this.parentElement.parentElement.parentElement.remove()"
                  style="padding: 8px 20px; background: var(--primary-red); color: white; border: none; border-radius: 5px; cursor: pointer;">
            Fechar
          </button>
        </div>
      `;
      
      modal.appendChild(box);
      document.body.appendChild(modal);
    }

    // ============================================
    // ‚ö° DIAGN√ìSTICO R√ÅPIDO (BOT√ÉO NO HEADER)
    // ============================================

    // Fun√ß√£o para diagn√≥stico r√°pido
    async function executarDiagnosticoRapido() {
      showNotification('üîç Executando diagn√≥stico r√°pido...', 'info');
      
      // Verifica√ß√µes r√°pidas
      const checks = [];
      
      // 1. Usu√°rio
      checks.push({
        item: 'Usu√°rio autenticado',
        status: !!firebaseAuth.currentUser,
        valor: firebaseAuth.currentUser?.email || 'N√£o'
      });
      
      // 2. Role
      checks.push({
        item: 'Role do usu√°rio',
        status: !!firebaseAuth.currentUser?.role,
        valor: firebaseAuth.currentUser?.role || 'N√£o definida'
      });
      
      // 3. Dados locais
      checks.push({
        item: 'Ve√≠culos carregados',
        status: vehicleData?.length > 0,
        valor: vehicleData?.length || 0
      });
      
      // 4. NCs
      checks.push({
        item: 'NCs carregadas',
        status: ncModule.dados?.length > 0,
        valor: ncModule.dados?.length || 0
      });
      
      // 5. Conex√£o
      checks.push({
        item: 'Conex√£o Firebase',
        status: firebaseService.isConnected,
        valor: firebaseService.isConnected ? 'Conectado' : 'Desconectado'
      });
      
      // 6. Permiss√µes
      checks.push({
        item: 'Permiss√µes ativas',
        status: permissionManager?.canAccessVehicles?.(),
        valor: permissionManager?.canAccessVehicles?.() ? 'Sim' : 'N√ÉO'
      });
      
      // Exibir resultado
      let mensagem = 'üîç DIAGN√ìSTICO R√ÅPIDO\n\n';
      checks.forEach(check => {
        const icone = check.status ? '‚úÖ' : '‚ùå';
        mensagem += `${icone} ${check.item}: ${check.valor}\n`;
      });
      
      alert(mensagem);
    }

    // ============================================
    //   DIAGN√ìSTICO ESPEC√çFICO N√ÉO CONFORMIDADES
    // ============================================
    const ncDiagnostico = {

      // Diagn√≥stico completo de NCs
      async executarDiagnosticoNCs() {
        try {
          showNotification('üö® Iniciando diagn√≥stico de NCs...', 'info');

          const resultado = {
            timestamp: new Date().toISOString(),
            usuario: firebaseAuth.currentUser?.email || 'N√£o autenticado',
            permissoes: {},
            dados: {},
            conexao: {},
            problemas: [],
            sugestoes: []
          };

          // 1. VERIFICAR PERMISS√ïES
          resultado.permissoes = await this.diagnosticarPermissoesNC();

          // 2. VERIFICAR DADOS
          resultado.dados = await this.diagnosticarDadosNC();

          // 3. VERIFICAR CONEX√ÉO
          resultado.conexao = await this.diagnosticarConexaoNC();

          // 4. TESTAR ACESSO DIRETO
          resultado.testeAcesso = await this.testarAcessoDiretoFirebase();

          // 5. AN√ÅLISE
          this.analisarResultados(resultado);

          // 6. EXIBIR
          this.exibirDiagnosticoNCs(resultado);

          showNotification('‚úÖ Diagn√≥stico de NCs conclu√≠do!', 'success');

          return resultado;

        } catch (error) {
          console.error('‚ùå Erro no diagn√≥stico NCs:', error);
          showNotification(`‚ùå Erro: ${error.message}`, 'error');
          return null;
        }
      },

      // 1. Diagn√≥stico de permiss√µes para NCs
      async diagnosticarPermissoesNC() {
        const diagnostico = {
          status: 'verificando',
          testes: [],
          problemas: []
        };

        try {
          // Teste 1: Usu√°rio autenticado
          const user = firebase.auth().currentUser;
          diagnostico.testes.push({
            nome: 'Usu√°rio autenticado no Firebase Auth',
            resultado: !!user,
            detalhes: user ? user.email : 'Nenhum'
          });

          if (!user) {
            diagnostico.problemas.push('Nenhum usu√°rio autenticado no Firebase Auth');
          }

          // Teste 2: Role no firebaseAuth
          diagnostico.testes.push({
            nome: 'Role no firebaseAuth',
            resultado: !!firebaseAuth.currentUser?.role,
            detalhes: firebaseAuth.currentUser?.role || 'N√£o definida'
          });

          if (!firebaseAuth.currentUser?.role) {
            diagnostico.problemas.push('Role n√£o definida no firebaseAuth');
          }

          // Teste 3: permissionManager existe
          diagnostico.testes.push({
            nome: 'Sistema de permiss√µes carregado',
            resultado: typeof permissionManager !== 'undefined',
            detalhes: permissionManager ? 'Carregado' : 'N√£o carregado'
          });

          if (!permissionManager) {
            diagnostico.problemas.push('Sistema de permiss√µes n√£o inicializado');
          }

          // Teste 4: Permiss√£o espec√≠fica para NCs
          if (permissionManager) {
            const podeAcessar = permissionManager.canAccessNCs();
            diagnostico.testes.push({
              nome: 'Permiss√£o para acessar NCs',
              resultado: podeAcessar,
              detalhes: podeAcessar ? 'PERMITIDO' : 'NEGADO'
            });

            if (!podeAcessar) {
              diagnostico.problemas.push(`Usu√°rio n√£o tem permiss√£o para NCs. Role atual: ${firebaseAuth.currentUser?.role}`);
            }
          }

          // Teste 5: Token v√°lido
          if (user) {
            try {
              const token = await user.getIdToken();
              diagnostico.testes.push({
                nome: 'Token de autentica√ß√£o v√°lido',
                resultado: !!token,
                detalhes: token ? 'V√°lido' : 'Inv√°lido'
              });
            } catch (e) {
              diagnostico.problemas.push('Token de autentica√ß√£o inv√°lido ou expirado');
            }
          }

          diagnostico.status = diagnostico.problemas.length > 0 ? 'problemas' : 'ok';

        } catch (error) {
          diagnostico.status = 'erro';
          diagnostico.erro = error.message;
        }

        return diagnostico;
      },

      // 2. Diagn√≥stico de dados de NCs
      async diagnosticarDadosNC() {
        const diagnostico = {
          status: 'verificando',
          locais: {},
          firebase: {},
          problemas: []
        };

        try {
          // Dados locais
          diagnostico.locais = {
            carregados: ncModule.dados?.length || 0,
            temDados: ncModule.dados?.length > 0,
            ultimaAtualizacao: ncModule.dados?.length > 0 ? 'Carregados' : 'Nunca'
          };

          if (ncModule.dados?.length === 0) {
            diagnostico.problemas.push('Nenhum dado de NC carregado localmente');
          }

          // Verificar estrutura do m√≥dulo
          diagnostico.moduloNC = {
            existe: typeof ncModule !== 'undefined',
            temFuncoes: typeof ncModule.carregarDoFirebase === 'function'
          };

          if (!diagnostico.moduloNC.existe) {
            diagnostico.problemas.push('M√≥dulo ncModule n√£o est√° definido');
          }

          if (!diagnostico.moduloNC.temFuncoes) {
            diagnostico.problemas.push('M√≥dulo ncModule n√£o tem fun√ß√µes necess√°rias');
          }

          diagnostico.status = diagnostico.problemas.length > 0 ? 'problemas' : 'ok';

        } catch (error) {
          diagnostico.status = 'erro';
          diagnostico.erro = error.message;
        }

        return diagnostico;
      },

      // 3. Diagn√≥stico de conex√£o para NCs
      async diagnosticarConexaoNC() {
        const diagnostico = {
          status: 'verificando',
          firebase: {},
          problemas: []
        };

        try {
          // Testar conex√£o com Firebase
          const connectedRef = firebase.database().ref('.info/connected');
          const snapshot = await connectedRef.once('value');
          diagnostico.firebase.conectado = snapshot.val() === true;

          if (!diagnostico.firebase.conectado) {
            diagnostico.problemas.push('Sem conex√£o com Firebase');
          }

          // Testar acesso ao caminho das NCs
          if (diagnostico.firebase.conectado) {
            try {
              const ncRef = firebase.database().ref('nc_dados');
              const ncSnapshot = await ncRef.once('value');

              diagnostico.firebase.caminhoAcessivel = true;
              diagnostico.firebase.temDados = ncSnapshot.exists();
              diagnostico.firebase.quantidadeRegistros = ncSnapshot.exists() ? ncSnapshot.numChildren() : 0;

              if (!diagnostico.firebase.caminhoAcessivel) {
                diagnostico.problemas.push('Caminho "nc_dados" inacess√≠vel no Firebase');
              }

              if (!diagnostico.firebase.temDados) {
                diagnostico.problemas.push('N√£o h√° dados de NCs no Firebase');
              }

            } catch (error) {
              diagnostico.problemas.push(`Erro ao acessar nc_dados: ${error.message}`);
              diagnostico.firebase.caminhoAcessivel = false;
            }
          }

          diagnostico.status = diagnostico.problemas.length > 0 ? 'problemas' : 'ok';

        } catch (error) {
          diagnostico.status = 'erro';
          diagnostico.erro = error.message;
        }

        return diagnostico;
      },

      // 4. Testar acesso direto ao Firebase (sem middleware)
      async testarAcessoDiretoFirebase() {
        const teste = {
          status: 'verificando',
          resultados: [],
          problemas: []
        };

        try {
          const user = firebase.auth().currentUser;

          if (!user) {
            teste.problemas.push('Nenhum usu√°rio para testar');
            teste.status = 'erro';
            return teste;
          }

          console.log('üîç TESTE DIRETO FIREBASE - Usu√°rio:', user.email);

          // Teste 1: Obter token
          try {
            const token = await user.getIdToken(true);
            teste.resultados.push({
              teste: 'Token obtido',
              sucesso: true,
              detalhes: 'Token v√°lido'
            });
          } catch (e) {
            teste.resultados.push({
              teste: 'Token obtido',
              sucesso: false,
              detalhes: e.message
            });
            teste.problemas.push(`Erro no token: ${e.message}`);
          }

          // Teste 2: Acesso direto ao Database
          try {
            const testRef = firebase.database().ref('.info/serverTimeOffset');
            await testRef.once('value');
            teste.resultados.push({
              teste: 'Acesso ao Database',
              sucesso: true,
              detalhes: 'Database acess√≠vel'
            });
          } catch (e) {
            teste.resultados.push({
              teste: 'Acesso ao Database',
              sucesso: false,
              detalhes: e.message
            });
            teste.problemas.push(`Database inacess√≠vel: ${e.message}`);
          }

          // Teste 3: Acesso ao caminho das NCs
          try {
            const ncRef = firebase.database().ref('nc_dados');
            const snapshot = await ncRef.once('value');

            teste.resultados.push({
              teste: 'Acesso a nc_dados',
              sucesso: true,
              detalhes: snapshot.exists() ?
                `${snapshot.numChildren()} registros encontrados` :
                'Caminho existe mas vazio'
            });

            if (snapshot.exists()) {
              // Mostrar primeiros 3 registros para debug
              const dados = snapshot.val();
              const primeirasChaves = Object.keys(dados.registros || {}).slice(0, 3);
              console.log('üìã Primeiros registros NC:', primeirasChaves);

              teste.resultados.push({
                teste: 'Dados dispon√≠veis',
                sucesso: true,
                detalhes: `${Object.keys(dados.registros || {}).length} registros no total`
              });
            }

          } catch (e) {
            teste.resultados.push({
              teste: 'Acesso a nc_dados',
              sucesso: false,
              detalhes: e.message
            });

            if (e.message.includes('permission_denied')) {
              teste.problemas.push('PERMISS√ÉO NEGADA para acessar nc_dados');
            } else {
              teste.problemas.push(`Erro ao acessar nc_dados: ${e.message}`);
            }
          }

          // Teste 4: Acesso usando firebaseService
          try {
            if (firebaseService && firebaseService.database) {
              const serviceRef = firebaseService.database.ref('nc_dados');
              const serviceSnapshot = await serviceRef.once('value');

              teste.resultados.push({
                teste: 'Acesso via firebaseService',
                sucesso: true,
                detalhes: serviceSnapshot.exists() ? 'OK' : 'Sem dados'
              });
            }
          } catch (e) {
            teste.resultados.push({
              teste: 'Acesso via firebaseService',
              sucesso: false,
              detalhes: e.message
            });
          }

          teste.status = teste.problemas.length > 0 ? 'problemas' : 'ok';

        } catch (error) {
          teste.status = 'erro';
          teste.erro = error.message;
        }

        return teste;
      },

      // Analisar resultados
      analisarResultados(resultado) {
        // Coletar todos os problemas
        resultado.problemas = [
          ...(resultado.permissoes.problemas || []),
          ...(resultado.dados.problemas || []),
          ...(resultado.conexao.problemas || []),
          ...(resultado.testeAcesso.problemas || [])
        ];

        // Gerar sugest√µes baseadas nos problemas
        resultado.sugestoes = this.gerarSugestoesNC(resultado.problemas);
      },

      // Gerar sugest√µes espec√≠ficas para NCs
      gerarSugestoesNC(problemas) {
        const sugestoes = [];

        problemas.forEach(problema => {
          if (problema.includes('PERMISS√ÉO NEGADA')) {
            sugestoes.push('üîÑ Atualize as regras do Firebase para permitir acesso');
            sugestoes.push('üëë Verifique se o usu√°rio tem role ADMIN ou MANAGER');
            sugestoes.push('üîê Fa√ßa logout e login novamente para atualizar token');
          }

          if (problema.includes('Role n√£o definida')) {
            sugestoes.push('üîÑ Execute "Reparar Automaticamente" nos Settings');
            sugestoes.push('üìã Use o bot√£o "For√ßar Admin" no console (F12)');
          }

          if (problema.includes('Nenhum dado de NC')) {
            sugestoes.push('üì• Clique em "Carregar do Firebase" na aba NCs');
            sugestoes.push('üìÅ Importe uma planilha de NCs pelos Settings');
          }

          if (problema.includes('Token inv√°lido')) {
            sugestoes.push('üîê Fa√ßa logout e login novamente');
          }

          if (problema.includes('M√≥dulo ncModule')) {
            sugestoes.push('üîÑ Recarregue a p√°gina (F5)');
          }
        });

        // Sugest√µes gerais
        if (sugestoes.length === 0 && problemas.length === 0) {
          sugestoes.push('‚úÖ Sistema de NCs funcionando corretamente!');
        }

        return sugestoes;
      },

      // Exibir diagn√≥stico
      exibirDiagnosticoNCs(resultado) {
        const container = document.getElementById('diagnosticoResultado') ||
                         document.createElement('div');

        if (!document.getElementById('diagnosticoResultado')) {
          container.id = 'diagnosticoResultado';
          document.querySelector('.settings-section:has(h5:contains("Diagn√≥stico"))')?.appendChild(container);
        }

        let html = `
          <div style="background: var(--bg-secondary); padding: 15px; border-radius: var(--radius-sm);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <strong style="color: #ff0000;">üö® DIAGN√ìSTICO N√ÉO CONFORMIDADES</strong>
              <small>${new Date().toLocaleString('pt-BR')}</small>
            </div>

            <div style="background: ${resultado.problemas.length > 0 ? '#fff3cd' : '#d4edda'};
                        padding: 10px; border-radius: var(--radius-sm); margin-bottom: 15px;">
              <strong>üìä RESUMO NCs:</strong>
              <div>Usu√°rio: ${resultado.usuario}</div>
              <div>Status: ${resultado.problemas.length > 0 ? 'üö® COM PROBLEMAS' : '‚úÖ OK'}</div>
              <div>Problemas: ${resultado.problemas.length}</div>
              <div>NCs locais: ${resultado.dados.locais?.carregados || 0}</div>
              <div>NCs Firebase: ${resultado.conexao.firebase?.quantidadeRegistros || 0}</div>
            </div>
        `;

        // Teste de acesso direto (MAIS IMPORTANTE)
        if (resultado.testeAcesso) {
          html += `
            <div style="margin-bottom: 15px;">
              <strong>üîç TESTE DE ACESSO DIRETO:</strong>
              <div style="max-height: 200px; overflow-y: auto; margin-top: 8px;">
          `;

          resultado.testeAcesso.resultados?.forEach(teste => {
            const icone = teste.sucesso ? '‚úÖ' : '‚ùå';
            const cor = teste.sucesso ? '#d4edda' : '#f8d7da';

            html += `
              <div style="font-size: 11px; padding: 6px; background: ${cor};
                          margin-bottom: 4px; border-radius: 3px; border-left: 3px solid ${teste.sucesso ? '#28a745' : '#dc3545'};">
                ${icone} <strong>${teste.teste}:</strong> ${teste.detalhes}
              </div>
            `;
          });

          html += `</div></div>`;
        }

        // Problemas
        if (resultado.problemas.length > 0) {
          html += `
            <div style="margin-bottom: 15px;">
              <strong>üö® PROBLEMAS IDENTIFICADOS:</strong>
              <div style="max-height: 200px; overflow-y: auto; margin-top: 8px; background: #f8d7da; padding: 10px; border-radius: 5px;">
          `;

          resultado.problemas.forEach((problema, index) => {
            html += `
              <div style="font-size: 12px; padding: 5px; border-bottom: 1px solid #f5c6cb;">
                <strong>${index + 1}.</strong> ${problema}
              </div>
            `;
          });

          html += `</div></div>`;
        }

        // Sugest√µes
        if (resultado.sugestoes.length > 0) {
          html += `
            <div style="margin-bottom: 15px;">
              <strong>üí° SUGEST√ïES DE CORRE√á√ÉO:</strong>
              <div style="max-height: 200px; overflow-y: auto; margin-top: 8px; background: #d1ecf1; padding: 10px; border-radius: 5px;">
          `;

          resultado.sugestoes.forEach((sugestao, index) => {
            html += `
              <div style="font-size: 12px; padding: 5px; border-bottom: 1px solid #bee5eb;">
                <strong>${index + 1}.</strong> ${sugestao}
              </div>
            `;
          });

          html += `</div></div>`;
        }

        // Bot√µes de a√ß√£o
        html += `
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 15px;">
            <button onclick="ncForcarCarregamento()"
                    style="padding: 8px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
              üîÑ For√ßar Carregamento NCs
            </button>
            <button onclick="ncTestarPermissoes()"
                    style="padding: 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
              üîê Testar Permiss√µes
            </button>
            <button onclick="ncLimparCache()"
                    style="padding: 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
              üóëÔ∏è Limpar Cache NCs
            </button>
            <button onclick="executarDiagnosticoNCs()"
                    style="padding: 8px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
              üîç Executar Diagn√≥stico Novamente
            </button>
          </div>
        `;

        html += `</div>`;

        container.innerHTML = html;
      }
    };

    // Fun√ß√µes globais
    function executarDiagnosticoNCs() {
      return ncDiagnostico.executarDiagnosticoNCs();
    }

    function ncForcarCarregamento() {
      if (confirm('üîÑ FOR√áAR CARREGAMENTO DE NCs?\n\nIsso ir√° tentar carregar os dados ignorando todas as verifica√ß√µes de permiss√£o.')) {
        forcarCarregamentoNCs();
      }
    }

    function ncTestarPermissoes() {
      testarPermissoesNCs();
    }

    function ncLimparCache() {
      if (confirm('üóëÔ∏è LIMPAR CACHE DE NCs?\n\nIsso ir√° remover todos os dados locais de NCs.\nOs dados no Firebase n√£o ser√£o afetados.')) {
        ncModule.dados = [];
        ncModule.filteredData = [];
        ncModule.atualizarEstatisticas();
        ncModule.renderizarTabela();
        showNotification('‚úÖ Cache de NCs limpo!', 'success');
      }
    }

    // ============================================
    // FUN√á√ïES AUXILIARES
    // ============================================
    
    function updateNcStatus(message) {
      const statusEl = document.getElementById('ncStatus');
      if (statusEl) {
        statusEl.innerHTML = `üìù ${message}`;
      }
    }

    // ============================================
    // FUN√á√ïES GLOBAIS DO SISTEMA
    // ============================================
    
    // üìä ESTAT√çSTICAS
    let appStats = {
      loads: 0,
      saves: 0,
      sheetsSyncs: 0,
      lastSync: null,
      errors: 0,
      firebaseCount: 0,
      localCount: 0,
      totalProcessed: 0,
      lastUpdate: null
    };

    // üìã LOG DE SINCRONIZA√á√ÉO
    const syncLog = {
      entries: [],
      
      add: function(type, message, details = {}) {
        const entry = {
          timestamp: new Date().toISOString(),
          type,
          message,
          details,
          user: firebaseAuth.currentUser?.email || 'Sistema'
        };
        
        this.entries.push(entry);
        console.log(`[${type.toUpperCase()}] ${message}`, details);
        
        if (this.entries.length > 100) {
          this.entries.shift();
        }
        
        return entry;
      },
      
      getRecent: function(count = 20) {
        return this.entries.slice(-count).reverse();
      },
      
      clear: function() {
        this.entries = [];
        showNotification('üìù Logs limpos com sucesso', 'success');
      }
    };

    // üéØ ELEMENTOS DOM
    const loginModal = document.getElementById('loginModal');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const mainContainer = document.getElementById('mainContainer');
    const settingsIcon = document.getElementById('settingsIcon');
    const btnLogout = document.getElementById('btnLogout');
    const loggedUser = document.getElementById('loggedUser');
    const currentUserInfo = document.getElementById('currentUserInfo');
    const adminSection = document.getElementById('adminSection');
    const btnDarkMode = document.getElementById('btnDarkMode');
    
    // Elementos adicionais referenciados globalmente
    try {
      window.statusFilter = document.getElementById('statusFilter');
      window.dateFilter = document.getElementById('dateFilter');
      window.searchInput = document.getElementById('searchInput');
      window.btnCloseSettings = document.getElementById('btnCloseSettings');
      window.settingsMenu = document.getElementById('settingsMenu');
      window.dropAreaSettings = document.getElementById('dropAreaSettings');
      window.fileInputSettings = document.getElementById('fileInputSettings');
      window.importProgress = document.getElementById('importProgress');
      window.importProgressBar = document.getElementById('importProgressBar');
      window.importProgressText = document.getElementById('importProgressText');
      window.editModal = document.getElementById('editModal');
      window.editForm = document.getElementById('editForm');
      window.btnCancelModal = document.getElementById('btnCancelModal');
      window.modalTitle = document.getElementById('modalTitle');
      window.totalVehicles = document.getElementById('totalVehicles');
      window.validVehicles = document.getElementById('validVehicles');
      window.warningVehicles = document.getElementById('warningVehicles');
      window.expiredVehicles = document.getElementById('expiredVehicles');
      window.totalCount = document.getElementById('totalCount');
      window.filteredCount = document.getElementById('filteredCount');
      window.lastSaveInfo = document.getElementById('lastSaveInfo');
      window.onlineStatus = document.getElementById('onlineStatus');
      window.syncInfo = document.getElementById('syncInfo');
      window.syncStatusMini = document.getElementById('syncStatusMini');
      window.saveStatus = document.getElementById('saveStatus');
    } catch (e) {
      console.warn('Erro ao inicializar refer√™ncias DOM adicionais', e);
    }
    
    // ============================================
    // üî• FIREBASE SERVICE
    // ============================================
    class FirebaseService {
      constructor() {
        this.firebaseConfig = {
          apiKey: "AIzaSyDLBgeNjBJ8o2I4yh4ggBbwVwJQxa3zp94",
          authDomain: "rondolog-frotas.firebaseapp.com",
          databaseURL: "https://rondolog-frotas-default-rtdb.firebaseio.com",
          projectId: "rondolog-frotas",
          storageBucket: "rondolog-frotas.firebasestorage.app",
          messagingSenderId: "136477471508",
          appId: "1:136477471508:web:1640848958acf2078f0801",
          measurementId: "G-NY9VLX8BC9"
        };
        
        if (!firebase.apps.length) {
          this.app = firebase.initializeApp(this.firebaseConfig);
        } else {
          this.app = firebase.app();
        }
        
        this.database = firebase.database();
        this.auth = firebase.auth();
        this.isConnected = false;
        this.userId = null;
      }
      
      async connect() {
        try {
          console.log('üîå Conectando ao Firebase...');
          syncLog.add('connection', 'Conectando ao Firebase...');
          
          // N√£o mais fazer login an√¥nimo - usar Firebase Auth
          const connectedRef = this.database.ref('.info/connected');
          connectedRef.on('value', (snap) => {
            this.isConnected = snap.val() === true;
            console.log(this.isConnected ? '‚úÖ Conectado ao Firebase' : '‚ö†Ô∏è Desconectado');
            syncLog.add('connection', this.isConnected ? 'Conectado ao Firebase' : 'Desconectado do Firebase');
            updateOnlineStatus(this.isConnected);
          });
          
          return true;
          
        } catch (error) {
          console.error('‚ùå Erro na conex√£o Firebase:', error);
          syncLog.add('error', 'Erro na conex√£o Firebase', { error: error.message });
          return false;
        }
      }
      
      async saveAllVehicles(vehicles) {
        try {
          console.log(`üíæ Salvando ${vehicles.length} ve√≠culos...`);
          syncLog.add('save', `Iniciando salvamento de ${vehicles.length} ve√≠culos`);
          
          const updates = {};
          
          vehicles.forEach(vehicle => {
            const safeKey = this.normalizeId(vehicle.placa);
            updates[`vehicles/${safeKey}`] = {
              ...vehicle,
              updatedAt: firebase.database.ServerValue.TIMESTAMP,
              updatedBy: firebaseAuth.currentUser?.uid || 'anonymous',
              lastUpdatedBy: firebaseAuth.currentUser?.email || 'Sistema'
            };
          });
          
          await this.database.ref().update(updates);
          console.log(`‚úÖ ${vehicles.length} ve√≠culos salvos`);
          syncLog.add('save', `${vehicles.length} ve√≠culos salvos com sucesso`);
          return true;
          
        } catch (error) {
          console.error('‚ùå Erro ao salvar:', error);
          syncLog.add('error', 'Erro ao salvar ve√≠culos', { error: error.message, count: vehicles.length });
          throw error;
        }
      }
      
      async loadVehicles() {
        try {
          console.log('üì• Carregando dados...');
          syncLog.add('load', 'Carregando dados do Firebase...');
          
          const snapshot = await this.database.ref('vehicles').once('value');
          
          if (!snapshot.exists()) {
            console.log('üì≠ Nenhum dado encontrado');
            syncLog.add('load', 'Nenhum dado encontrado no Firebase');
            return [];
          }
          
          const vehicles = [];
          const loadReport = {
            total: snapshot.numChildren(),
            loaded: 0,
            ignored: 0,
            problems: []
          };
          
          snapshot.forEach(childSnapshot => {
            try {
              const rawVehicle = childSnapshot.val();
              const key = childSnapshot.key;
              
              if (rawVehicle && rawVehicle.placa) {
                const normalizedPlaca = rawVehicle.placa.toString().trim().toUpperCase();
                
                if (normalizedPlaca === '' || normalizedPlaca === 'UNDEFINED') {
                  loadReport.ignored++;
                  loadReport.problems.push({
                    key,
                    reason: 'Placa vazia ou "UNDEFINED"',
                    data: rawVehicle
                  });
                  return;
                }
                
                const vehicle = {
                  ...rawVehicle,
                  placa: normalizedPlaca
                };
                
                vehicle.vigenciaChecklist = vehicle.vigenciaChecklist || '';
                vehicle.statusChecklist = vehicle.statusChecklist || '';
                
                if (!vehicle.statusGeral) {
                  vehicle.statusGeral = calculateStatusGeral(
                    vehicle.vigenciaChecklist, 
                    vehicle.statusChecklist
                  );
                }
                
                vehicles.push(vehicle);
                loadReport.loaded++;
                
              } else {
                loadReport.ignored++;
                loadReport.problems.push({
                  key,
                  reason: rawVehicle ? 'Sem campo placa' : 'Dados nulos',
                  data: rawVehicle
                });
              }
            } catch (error) {
              loadReport.ignored++;
              loadReport.problems.push({
                key: childSnapshot.key,
                reason: `Erro: ${error.message}`,
                data: childSnapshot.val()
              });
            }
          });
          
          console.log(`‚úÖ ${vehicles.length} ve√≠culos carregados`);
          
          syncLog.add('load', `Carregamento conclu√≠do: ${vehicles.length} ve√≠culos`, loadReport);
          
          appStats.firebaseCount = loadReport.total;
          appStats.localCount = vehicles.length;
          appStats.totalProcessed += vehicles.length;
          appStats.lastUpdate = new Date().toISOString();
          updateDetailedStats();
          updateSettingsStats();
          
          if (loadReport.ignored > 0) {
            const lossRate = ((loadReport.ignored / loadReport.total) * 100).toFixed(2);
            showNotification(
              `‚ö†Ô∏è ${loadReport.ignored} registros ignorados ao carregar (${lossRate}% de perda)`, 
              'warning'
            );
          }
          
          return vehicles;
          
        } catch (error) {
          console.error('‚ùå Erro ao carregar:', error);
          syncLog.add('error', 'Erro ao carregar ve√≠culos', { error: error.message });
          throw error;
        }
      }
      
      async deleteVehicle(placa) {
        try {
          const safeKey = this.normalizeId(placa);
          await this.database.ref(`vehicles/${safeKey}`).remove();
          console.log(`üóëÔ∏è ${placa} exclu√≠do`);
          syncLog.add('delete', `Ve√≠culo ${placa} exclu√≠do`);
          return true;
        } catch (error) {
          console.error('‚ùå Erro ao excluir:', error);
          syncLog.add('error', `Erro ao excluir ve√≠culo ${placa}`, { error: error.message });
          throw error;
        }
      }
      
      setupRealtimeListener(callback) {
        try {
          console.log('üëÇ Configurando listener...');
          syncLog.add('connection', 'Configurando listener em tempo real');
          
          return this.database.ref('vehicles').on('value', (snapshot) => {
            if (snapshot.exists()) {
              const vehicles = [];
              snapshot.forEach(childSnapshot => {
                vehicles.push(childSnapshot.val());
              });
              callback(vehicles);
              appStats.firebaseCount = snapshot.numChildren();
              updateDetailedStats();
              updateSettingsStats();
              syncLog.add('realtime', 'Dados atualizados em tempo real', { count: vehicles.length });
            }
          });
          
        } catch (error) {
          console.error('‚ùå Erro no listener:', error);
          syncLog.add('error', 'Erro no listener em tempo real', { error: error.message });
        }
      }
      
      async testConnection() {
        try {
          const connectedRef = this.database.ref('.info/connected');
          const snapshot = await connectedRef.once('value');
          return snapshot.val() === true;
        } catch (error) {
          return false;
        }
      }
      
      normalizeId(placa) {
        if (!placa) return 'undefined';
        
        let normalized = placa.toString().toUpperCase().trim();
        normalized = normalized.replace(/[^A-Z0-9]/g, '_');
        normalized = normalized.replace(/_+/g, '_');
        normalized = normalized.replace(/^_+|_+$/g, '');
        
        if (normalized === '') {
          return 'vehicle_' + Math.random().toString(36).substr(2, 9);
        }
        
        return normalized.toLowerCase();
      }
    }

    // Criar inst√¢ncia global
    const firebaseService = new FirebaseService();

    // ============================================
    // üéØ FUN√á√ïES DO SISTEMA (EXISTENTES)
    // ============================================

    function calculateStatusGeral(vigenciaChecklist, statusChecklist) {
      const statusUpper = (statusChecklist || '').toUpperCase().trim();
      
      if (statusUpper === 'OK') return 'OK';
      if (statusUpper === 'VENCIDO') return 'VENCIDO';
      
      return 'PENDENTE';
    }

    function parseBrazilianDate(dateStr) {
      if (!dateStr || dateStr.toString().trim() === '') return '';
      
      const str = dateStr.toString().trim();
      
      if (str.includes('/')) {
        const parts = str.split('/');
        if (parts.length === 3) {
          const day = parseInt(parts[0], 10);
          const month = parseInt(parts[1], 10) - 1;
          const year = parseInt(parts[2], 10);
          return new Date(year, month, day);
        }
      }
      
      if (str.includes('-')) {
        const date = new Date(str);
        if (!isNaN(date.getTime())) return date;
      }
      
      const date = new Date(str);
      return isNaN(date.getTime()) ? '' : date;
    }

    function formatDateForInput(dateString) {
      if (!dateString) return '';
      try {
        const date = parseBrazilianDate(dateString);
        if (!date || isNaN(date.getTime())) return '';
        return date.toISOString().split('T')[0];
      } catch {
        return '';
      }
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      try {
        const date = parseBrazilianDate(dateString);
        if (!date || isNaN(date.getTime())) return dateString;
        return date.toLocaleDateString('pt-BR');
      } catch {
        return dateString;
      }
    }

    // ============================================
    // üîê SISTEMA DE AUTENTICA√á√ÉO - FIREBASE AUTH
    // ============================================

    async function initAuthentication() {
      console.log('üîê Inicializando autentica√ß√£o Firebase...');
      
      // Inicializar Firebase Auth
      await firebaseAuth.init();
      
      // Configurar evento de login
      loginForm.addEventListener('submit', handleLoginSubmit);
      btnLogout.addEventListener('click', handleLogout);
    }

    // ============================================
    // üîß DEBUG E DIAGN√ìSTICO
    // ============================================

    async function debugUserPermissions() {
      console.log('üîç ===== DEBUG PERMISSIONS =====');
      
      // 1. Firebase Auth User
      const authUser = firebase.auth().currentUser;
      console.log('1. Firebase Auth User:', authUser);
      console.log('2. Firebase UID:', authUser?.uid);
      console.log('3. Firebase Email:', authUser?.email);
      
      if (!authUser) {
        console.log('‚ùå Nenhum usu√°rio autenticado no Firebase Auth');
        return;
      }
      
      let dbRole = 'N/A';
      
      // 2. Buscar dados do usu√°rio no Database
      try {
        const userRef = firebase.database().ref(`users/${authUser.uid}`);
        const snapshot = await userRef.once('value');
        
        console.log('4. Database Path:', `users/${authUser.uid}`);
        console.log('5. Database Snapshot exists?', snapshot.exists());
        
        if (snapshot.exists()) {
          const userData = snapshot.val();
          console.log('6. Database User Data:', userData);
          console.log('7. Role from Database:', userData?.role);
          console.log('8. Email from Database:', userData?.email);
          dbRole = userData?.role || 'N/A';
        } else {
          console.log('‚ùå Usu√°rio n√£o encontrado no Database');
        }
      } catch (error) {
        console.log('‚ùå Erro ao buscar do Database:', error);
      }
      
      // 3. firebaseAuth.currentUser
      console.log('9. firebaseAuth.currentUser:', firebaseAuth.currentUser);
      console.log('10. firebaseAuth.currentUser?.role:', firebaseAuth.currentUser?.role);
      
      // 4. permissionManager
      console.log('11. permissionManager exists?', typeof permissionManager !== 'undefined');
      if (typeof permissionManager !== 'undefined') {
        console.log('12. canAccessVehicles:', permissionManager.canAccessVehicles());
        console.log('13. canAccessNCs:', permissionManager.canAccessNCs());
        console.log('14. isAdmin:', permissionManager.isAdmin());
      }
      
      console.log('üîç ===== FIM DEBUG =====');
      
      // Mostrar alerta para f√°cil visualiza√ß√£o
      setTimeout(() => {
        alert(`DEBUG PERMISSIONS:
    Firebase UID: ${authUser?.uid || 'N/A'}
    Database Role: ${dbRole}
    firebaseAuth Role: ${firebaseAuth.currentUser?.role || 'N/A'}
    canAccessVehicles: ${permissionManager?.canAccessVehicles?.() ? 'SIM' : 'N√ÉO'}`);
      }, 500);
    }

    // Chame esta fun√ß√£o ap√≥s o login
    // debugUserPermissions();

    async function handleLoginSubmit(e) {
      e.preventDefault();
      
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      const result = await firebaseAuth.login(email, password);
      
      if (result.success) {
        showNotification('‚úÖ Login realizado com sucesso', 'success');
      } else {
        document.getElementById('loginError').style.display = 'block';
        document.getElementById('loginError').textContent = `‚ùå ${result.error}`;
        
        setTimeout(() => {
          document.getElementById('loginError').style.display = 'none';
        }, 3000);
      }
    }

    async function handleLogout() {
      if (confirm('üö™ Deseja realmente sair do sistema?')) {
        await firebaseAuth.logout();
        location.reload();
      }
    }

    // ============================================
    // üë• GERENCIAMENTO DE USU√ÅRIOS - FIREBASE
    // ============================================

    async function openUserManager() {
      if (!firebaseAuth.isAdmin()) {
        showNotification('‚ö†Ô∏è Acesso restrito a administradores', 'warning');
        return;
      }
      
      const modal = document.getElementById('userManagerModal');
      if (modal) {
        modal.style.display = 'flex';
        await loadUserList();
      }
    }

    function closeUserManager() {
      const modal = document.getElementById('userManagerModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    async function loadUserList() {
      const tbody = document.getElementById('userListBody');
      if (!tbody) return;
      
      try {
        const usersRef = firebaseService.database.ref('users');
        const snapshot = await usersRef.once('value');
        const users = snapshot.val() || {};
        
        tbody.innerHTML = Object.entries(users).map(([uid, userData]) => `
          <tr>
            <td><strong>${userData.email}</strong></td>
            <td>${userData.displayName || '-'}</td>
            <td>
              <select class="role-select" data-uid="${uid}" 
                      onchange="changeUserRole('${uid}', this.value)"
                      ${userData.email === firebaseAuth.currentUser?.email ? 'disabled' : ''}>
                <option value="VIEWER" ${userData.role === 'VIEWER' ? 'selected' : ''}>Visualizador</option>
                <option value="OPERATOR" ${userData.role === 'OPERATOR' ? 'selected' : ''}>Operador</option>
                <option value="MANAGER" ${userData.role === 'MANAGER' ? 'selected' : ''}>Gerente</option>
                <option value="ADMIN" ${userData.role === 'ADMIN' ? 'selected' : ''}>Administrador</option>
              </select>
            </td>
            <td>
              <span class="status-badge ${userData.active !== false ? 'status-valid' : 'status-expired'}" 
                    style="font-size: 10px; padding: 3px 8px;">
                ${userData.active !== false ? 'ATIVO' : 'INATIVO'}
              </span>
            </td>
            <td>${userData.lastLogin ? new Date(userData.lastLogin).toLocaleDateString('pt-BR') : 'Nunca'}</td>
            <td>
              <button class="btn-edit" onclick="resetUserPasswordPrompt('${userData.email}')" 
                      style="font-size: 11px; padding: 3px 8px;">
                üîê Resetar
              </button>
              <button class="btn-delete" onclick="toggleUserStatus('${uid}', ${userData.active !== false})" 
                      style="font-size: 11px; padding: 3px 8px;">
                ${userData.active !== false ? '‚ùå Desativar' : '‚úÖ Ativar'}
              </button>
            </td>
          </tr>
        `).join('');
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar lista de usu√°rios:', error);
        showNotification('‚ùå Erro ao carregar usu√°rios', 'error');
      }
    }

    async function changeUserRole(uid, newRole) {
      if (!firebaseAuth.isAdmin()) {
        showNotification('‚ö†Ô∏è Apenas administradores podem alterar perfis', 'warning');
        return;
      }
      
      try {
        await firebaseService.database.ref(`users/${uid}/role`).set(newRole);
        showNotification(`‚úÖ Perfil alterado com sucesso`, 'success');
        loadUserList();
      } catch (error) {
        showNotification(`‚ùå Erro: ${error.message}`, 'error');
      }
    }

    async function toggleUserStatus(uid, currentStatus) {
      if (!firebaseAuth.isAdmin()) {
        showNotification('‚ö†Ô∏è Apenas administradores podem alterar status', 'warning');
        return;
      }
      
      const newStatus = !currentStatus;
      
      try {
        await firebaseService.database.ref(`users/${uid}/active`).set(newStatus);
        showNotification(`‚úÖ Usu√°rio ${newStatus ? 'ativado' : 'desativado'}`, 'success');
        loadUserList();
      } catch (error) {
        showNotification(`‚ùå Erro: ${error.message}`, 'error');
      }
    }

    function resetUserPasswordPrompt(email) {
      if (!firebaseAuth.isAdmin()) {
        showNotification('‚ö†Ô∏è Apenas administradores podem resetar senhas', 'warning');
        return;
      }
      
      alert(`üîê RESET DE SENHA\n\nPara resetar a senha do usu√°rio ${email}, use o link "Esqueci minha senha" no login.\n\nO usu√°rio receber√° um email para criar uma nova senha.`);
    }

    function generatePassword() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%&';
      let password = '';
      for (let i = 0; i < 10; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      document.getElementById('newPassword').value = password;
      showNotification('üîê Senha gerada automaticamente', 'info');
    }

    async function createNewUser() {
      if (!firebaseAuth.isAdmin()) {
        showNotification('‚ö†Ô∏è Apenas administradores podem criar usu√°rios', 'warning');
        return;
      }
      
      const displayName = document.getElementById('newUserName').value.trim();
      const email = document.getElementById('newUserEmail').value.trim();
      const password = document.getElementById('newPassword').value;
      const role = document.getElementById('newUserRole').value;
      
      if (!email) {
        showNotification('‚ö†Ô∏è Digite um email v√°lido', 'warning');
        return;
      }
      
      if (!password) {
        showNotification('‚ö†Ô∏è Digite uma senha', 'warning');
        return;
      }
      
      try {
        const result = await firebaseAuth.createUser(email, password, role, displayName);
        
        if (result.success) {
          document.getElementById('newUserName').value = '';
          document.getElementById('newUserEmail').value = '';
          document.getElementById('newPassword').value = '';
          
          showNotification(`‚úÖ Usu√°rio ${email} criado com sucesso!`, 'success');
          loadUserList();
        } else {
          showNotification(`‚ùå Erro: ${result.error}`, 'error');
        }
      } catch (error) {
        showNotification(`‚ùå Erro: ${error.message}`, 'error');
      }
    }

    function openRoleManager() {
      showNotification('üé≠ Esta funcionalidade ser√° implementada em breve', 'info');
    }

    function viewAuditLogs() {
      showNotification('üìã Esta funcionalidade ser√° implementada em breve', 'info');
    }

    function systemDiagnostics() {
      showNotification('üîß Esta funcionalidade ser√° implementada em breve', 'info');
    }

    // ============================================
    // ‚öôÔ∏è SISTEMA DE SETTINGS
    // ============================================

    function initSettings() {
      console.log('‚öôÔ∏è Inicializando sistema de Settings...');
      
      settingsIcon.addEventListener('click', toggleSettingsMenu);
      btnCloseSettings.addEventListener('click', closeSettingsMenu);
      
      document.addEventListener('click', (e) => {
        if (!settingsMenu.contains(e.target) && !settingsIcon.contains(e.target)) {
          closeSettingsMenu();
        }
      });
      
      setupFileUpload();
      updateSettingsStats();
      updateDetailedStats();
      updateSystemInfo();
    }

    function toggleSettingsMenu() {
      settingsMenu.classList.toggle('show');
      if (settingsMenu.classList.contains('show')) {
        updateSettingsStats();
        updateDetailedStats();
        updateSystemInfo();
        updateNcStatus('Pronto para importar dados');
      }
    }

    function closeSettingsMenu() {
      settingsMenu.classList.remove('show');
    }

    function setupFileUpload() {
      const dropAreaSettings = document.getElementById('dropAreaSettings');
      const fileInputSettings = document.getElementById('fileInputSettings');
      
      dropAreaSettings.addEventListener('click', () => {
        fileInputSettings.click();
      });
      
      fileInputSettings.addEventListener('change', handleSettingsFileSelect);
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropAreaSettings.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        dropAreaSettings.addEventListener(eventName, () => {
          dropAreaSettings.style.borderColor = 'var(--primary-red)';
          dropAreaSettings.style.background = 'var(--bg-secondary)';
        }, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        dropAreaSettings.addEventListener(eventName, () => {
          dropAreaSettings.style.borderColor = 'var(--border-color)';
          dropAreaSettings.style.background = '';
        }, false);
      });
      
      dropAreaSettings.addEventListener('drop', handleSettingsDrop, false);
    }

    function handleSettingsDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files.length) {
        handleSettingsFileSelect({ target: { files } });
      }
    }

    function handleSettingsFileSelect(e) {
      const files = e.target.files;
      if (files.length) {
        const file = files[0];
        
        // Verificar se √© planilha de NC
        if (file.name.includes('NaoConformidade') || file.name.includes('N√£o Conformidade') || file.name.includes('nc')) {
          // Processar como NC
          ncImportarPlanilha(file);
        } else {
          // Processar como ve√≠culos (existente)
          processSettingsFile(file);
        }
      }
    }

    async function processSettingsFile(file) {
      try {
        showNotification(`üìÅ Processando ${file.name}...`, 'info');
        
        const data = await readExcelFile(file);
        const processed = await processSpreadsheetData(data, file.name);
        
        showNotification(`‚úÖ ${processed.length} ve√≠culos prontos para importar`, 'success');
        
        if (confirm(`Importar ${processed.length} ve√≠culos do arquivo ${file.name}?\n\n‚ö†Ô∏è Isso substituir√° os dados atuais.`)) {
          await importToFirebase(processed, file.name);
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao processar arquivo:', error);
        showNotification(`‚ùå Erro: ${error.message}`, 'error');
      }
    }

    function readExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet);
            resolve(jsonData);
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    async function processSpreadsheetData(data, fileName) {
      const processed = [];
      const ignored = [];
      
      const progressBar = document.getElementById('importProgressBar');
      const progressText = document.getElementById('importProgressText');
      const importProgress = document.getElementById('importProgress');
      
      importProgress.style.display = 'block';
      
      for (let i = 0; i < data.length; i++) {
        const row = data[i];
        
        const progress = Math.round(((i + 1) / data.length) * 100);
        progressBar.style.width = `${progress}%`;
        progressText.textContent = `Processando ${i + 1} de ${data.length}...`;
        
        try {
          const placa = extractField(row, [
            'Ve√≠culo', 'Veiculo', 'VE√çCULO', 'VEICULO', 
            'Placa', 'placa', 'PLACA', 'Veiculo', 'Ve√≠culo'
          ]);
          
          const statusChecklistRaw = extractField(row, [
            'Status', 'STATUS', 'status',
            'Status Checklist', 'Status do Checklist'
          ]);
          
          const dataRealizacao = extractField(row, [
            'Data Realiza√ß√£o', 'Data Realizacao', 'DATA REALIZA√á√ÉO',
            'Data', 'Data Checklist', 'Data do Checklist'
          ]);
          
          const validade = extractField(row, [
            'Validade', 'VALIDADE', 'validade',
            'Validade Checklist', 'Vencimento'
          ]);
          
          if (!placa || placa.toString().trim() === '') {
            ignored.push({ linha: i + 1, motivo: 'Placa vazia' });
            continue;
          }
          
          const placaNormalizada = placa.toString().trim().toUpperCase();
          
          let statusChecklist = 'PENDENTE';
          
          if (statusChecklistRaw) {
            const statusLower = statusChecklistRaw.toString().toLowerCase();
            
            if (statusLower.includes('v√°lido') || statusLower.includes('valido') || 
                statusLower.includes('aprovado') || statusLower.includes('ok')) {
              statusChecklist = 'OK';
            } else if (statusLower.includes('vencido') || statusLower.includes('expirado')) {
              statusChecklist = 'VENCIDO';
            } else if (statusLower.includes('pendente') || statusLower.includes('pend√™ncia')) {
              statusChecklist = 'PENDENTE';
            } else {
              if (statusLower.includes('reprovado') || statusLower.includes('inv√°lido')) {
                statusChecklist = 'PENDENTE';
              } else {
                statusChecklist = 'PENDENTE';
              }
            }
          }
          
          let vigenciaChecklist = '';
          if (validade && validade.toString().trim().toLowerCase() !== 'no embarque') {
            vigenciaChecklist = formatDateForInput(validade);
          } else if (dataRealizacao) {
            try {
              const dataReal = parseBrazilianDate(dataRealizacao);
              if (dataReal && !isNaN(dataReal.getTime())) {
                dataReal.setDate(dataReal.getDate() + 30);
                vigenciaChecklist = dataReal.toISOString().split('T')[0];
              }
            } catch (e) {
              console.warn('Erro ao calcular vig√™ncia:', e);
            }
          }
          
          const statusGeral = calculateStatusGeral(vigenciaChecklist, statusChecklist);
          
          processed.push({
            placa: placaNormalizada,
            vigenciaChecklist: vigenciaChecklist,
            statusChecklist: statusChecklist,
            statusGeral: statusGeral,
            importedAt: Date.now(),
            sourceFile: fileName,
            sourceRow: i + 1,
            importedBy: firebaseAuth.currentUser?.email || 'Sistema'
          });
          
        } catch (error) {
          ignored.push({ linha: i + 1, motivo: `Erro: ${error.message}` });
        }
      }
      
      progressBar.style.width = '0%';
      progressText.textContent = 'Processando...';
      importProgress.style.display = 'none';
      
      console.log(`‚úÖ Processados: ${processed.length}, Ignorados: ${ignored.length}`);
      
      if (ignored.length > 0) {
        console.warn('Linhas ignoradas:', ignored);
      }
      
      return processed;
    }

    function extractField(row, possibleKeys) {
      for (const key of possibleKeys) {
        if (row[key] !== undefined && row[key] !== null && row[key] !== '') {
          return row[key];
        }
        
        const keyWithSpace = key.replace(/([A-Z])/g, ' $1').trim();
        if (row[keyWithSpace] !== undefined) {
          return row[keyWithSpace];
        }
      }
      return '';
    }

    async function importToFirebase(data, fileName) {
      try {
        showNotification(`üì§ Importando ${data.length} ve√≠culos...`, 'info');
        
        const updates = {};
        data.forEach(vehicle => {
          const safeKey = firebaseService.normalizeId(vehicle.placa);
          updates[`vehicles/${safeKey}`] = {
            ...vehicle,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            updatedBy: firebaseAuth.currentUser?.uid || 'import_tool',
            lastUpdatedBy: firebaseAuth.currentUser?.email || 'Sistema'
          };
        });
        
        await firebaseService.database.ref().update(updates);
        
        vehicleData = data;
        applyFiltersAndRender();
        
        showNotification(`‚úÖ ${data.length} ve√≠culos importados com sucesso!`, 'success');
        updateSettingsStats();
        updateDetailedStats();
        
        syncLog.add('import', `Importa√ß√£o via Settings: ${data.length} ve√≠culos`, {
          fileName: fileName,
          count: data.length,
          importedBy: firebaseAuth.currentUser?.email
        });
        
      } catch (error) {
        console.error('‚ùå Erro na importa√ß√£o:', error);
        showNotification(`‚ùå Erro na importa√ß√£o: ${error.message}`, 'error');
        syncLog.add('error', 'Erro na importa√ß√£o via Settings', { 
          error: error.message,
          user: firebaseAuth.currentUser?.email
        });
      }
    }

    function updateDetailedStats() {
      const detailedFirebase = document.getElementById('detailedFirebase');
      const detailedLocal = document.getElementById('detailedLocal');
      const detailedSyncs = document.getElementById('detailedSyncs');
      const detailedLastSync = document.getElementById('detailedLastSync');
      const detailedLoads = document.getElementById('detailedLoads');
      const detailedLogs = document.getElementById('detailedLogs');
      
      if (detailedFirebase) detailedFirebase.textContent = appStats.firebaseCount || 0;
      if (detailedLocal) detailedLocal.textContent = appStats.localCount || vehicleData.length || 0;
      if (detailedSyncs) detailedSyncs.textContent = appStats.saves || 0;
      if (detailedLoads) detailedLoads.textContent = appStats.loads || 0;
      if (detailedLogs) detailedLogs.textContent = syncLog.entries.length || 0;
      
      if (detailedLastSync) {
        detailedLastSync.textContent = appStats.lastSync 
          ? new Date(appStats.lastSync).toLocaleTimeString('pt-BR')
          : '-';
      }
    }

    function exportBackupJSON() {
      const backupData = {
        timestamp: new Date().toISOString(),
        version: 'RONDOLOG v15.2',
        user: firebaseAuth.currentUser?.email || 'N√£o autenticado',
        vehicleCount: vehicleData.length,
        vehicles: vehicleData,
        ncCount: ncModule.dados.length,
        ncData: ncModule.dados,
        stats: appStats,
        logs: syncLog.entries.slice(-50)
      };
      
      const jsonStr = JSON.stringify(backupData, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `rondolog_backup_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      showNotification('üíæ Backup JSON gerado com sucesso!', 'success');
      syncLog.add('export', 'Backup JSON exportado', { 
        count: vehicleData.length,
        user: firebaseAuth.currentUser?.email
      });
    }

    function updateSettingsStats() {
      const total = vehicleData.length;
      const ok = vehicleData.filter(v => v.statusGeral === 'OK').length;
      const pending = vehicleData.filter(v => v.statusGeral === 'PENDENTE').length;
      const expired = vehicleData.filter(v => v.statusGeral === 'VENCIDO').length;
      
      document.getElementById('settingsVehicleCount').textContent = total;
      document.getElementById('settingsOkCount').textContent = ok;
      document.getElementById('settingsPendingCount').textContent = pending;
      document.getElementById('settingsExpiredCount').textContent = expired;
      document.getElementById('settingsFirebaseCount').textContent = appStats.firebaseCount || 0;
      document.getElementById('settingsSyncCount').textContent = appStats.saves || 0;
    }

    function updateSystemInfo() {
      const lastUpdateInfo = document.getElementById('lastUpdateInfo');
      const totalProcessedInfo = document.getElementById('totalProcessedInfo');
      
      if (lastUpdateInfo) {
        lastUpdateInfo.textContent = appStats.lastUpdate 
          ? new Date(appStats.lastUpdate).toLocaleString('pt-BR')
          : 'Nunca';
      }
      
      if (totalProcessedInfo) {
        totalProcessedInfo.textContent = appStats.totalProcessed || 0;
      }
    }

    // ============================================
    // üö® FUN√á√ïES DE N√ÉO CONFORMIDADES - CORRIGIDAS
    // ============================================

    async function ncImportarPlanilha(file = null) {
      try {
        await ncModule.importarPlanilha(file);
      } catch (error) {
        console.error('‚ùå Erro na importa√ß√£o:', error);
        showNotification(`‚ùå ${error.message}`, 'error');
      }
      
      closeSettingsMenu();
    }

    function ncConfigurarAlertas() {
      showNotification('üîî Configura√ß√£o de alertas em desenvolvimento', 'info');
      closeSettingsMenu();
    }

    async function ncLimparHistorico() {
      try {
        showNotification('üîÑ Verificando permiss√µes...', 'info');
        
        // 1. Verificar se o usu√°rio tem permiss√£o
        const { user, role } = await ncPermissaoMiddleware.verificarAdminOuManager();
        
        if (!confirm(`üóëÔ∏è LIMPAR HIST√ìRICO DE N√ÉO CONFORMIDADES\n\nEsta a√ß√£o remover√° TODOS os registros de NCs do Firebase.\n\nUsu√°rio: ${user.email}\nRole: ${role}\n\nDeseja continuar?`)) {
          return;
        }
        
        showNotification('üîÑ Gerando backup e limpando Firebase...', 'info');
        
        // 2. Obter token atualizado
        const token = await user.getIdToken(true);
        
        // 3. Primeiro fazer backup
        const backupUrl = 'https://rondolog-frotas-default-rtdb.firebaseio.com/nc_dados/registros.json';
        const resp = await fetch(`${backupUrl}?auth=${token}`);
        
        if (!resp.ok) {
          if (resp.status === 401) {
            throw new Error('Token inv√°lido ou expirado. Fa√ßa login novamente.');
          }
          throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);
        }
        
        const remoteData = await resp.json();
        
        // Fazer download do backup
        const ts = new Date().toISOString().replace(/[:\.]/g,'-');
        const backupFilename = `nc_backup_${ts}.json`;
        const blob = new Blob([JSON.stringify(remoteData, null, 2)], { type: 'application/json' });
        const backupUrlObj = URL.createObjectURL(blob);
        const a = document.createElement('a'); 
        a.href = backupUrlObj; 
        a.download = backupFilename; 
        document.body.appendChild(a); 
        a.click(); 
        a.remove();
        
        // 4. Limpar dados
        const deleteResp = await fetch(`${backupUrl}?auth=${token}`, { 
          method: 'DELETE'
        });
        
        if (!deleteResp.ok) {
          throw new Error(`Falha ao limpar: HTTP ${deleteResp.status}`);
        }
        
        // 5. Limpar localmente tamb√©m
        ncModule.dados = [];
        ncModule.atualizarEstatisticas();
        ncModule.aplicarFiltros();
        ncModule.renderizarTabela();
        
        showNotification('‚úÖ Hist√≥rico de NCs removido com sucesso! Backup criado.', 'success');
        updateNcStatus('‚úÖ Hist√≥rico limpo');
        
      } catch (error) {
        console.error('‚ùå Erro ao limpar Firebase:', error);
        
        if (error.message.includes('Acesso negado') || error.message.includes('Role')) {
          showNotification('üîí Apenas ADMIN ou MANAGER podem limpar NCs', 'error');
          updateNcStatus('üîí Permiss√£o negada');
        } else if (error.message.includes('Token') || error.message.includes('401')) {
          showNotification('üîí Erro de autentica√ß√£o. Fa√ßa login novamente.', 'error');
          updateNcStatus('üîí Erro de autentica√ß√£o');
          
          // For√ßar logout e relogin
          if (confirm('Sess√£o expirada. Deseja fazer login novamente?')) {
            await firebaseAuth.logout();
            location.reload();
          }
        } else {
          showNotification(`‚ùå Erro: ${error.message}`, 'error');
          updateNcStatus('‚ùå Erro ao limpar');
        }
      }
      
      closeSettingsMenu();
    }

    function ncVerEstatisticas() {
      const stats = ncModule.stats;
      
      const mensagem = `
üìä ESTAT√çSTICAS DE N√ÉO CONFORMIDADES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚Ä¢ Total de NCs: ${stats.total}
‚Ä¢ NCs hoje: ${stats.hoje}
‚Ä¢ Ve√≠culos envolvidos: ${stats.veiculos.size}
‚Ä¢ Motoristas envolvidos: ${stats.motoristas.size}

üìà DISTRIBUI√á√ÉO POR TIPO:
${Object.entries(stats.tipos).map(([tipo, count]) => `  ‚Ä¢ ${ncModule.obterTipoNC(tipo)}: ${count}`).join('\n')}
      `.trim();
      
      alert(mensagem);
      closeSettingsMenu();
    }

    function ncVerDetalhes(id) {
      ncModule.verDetalhes(id);
    }

    function ncExcluir(id) {
      ncModule.excluir(id);
    }

    function closeNcViewModal() {
      document.getElementById('ncViewModal').style.display = 'none';
    }

    function ncExportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(20);
      doc.text('RONDOLOG - DETALHES DA N√ÉO CONFORMIDADE', 105, 15, { align: 'center' });
      
      doc.setFontSize(10);
      doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, 25, { align: 'center' });
      
      showNotification('üìã Exporta√ß√£o de detalhes em desenvolvimento', 'info');
    }

    // ============================================
    // üìä FUN√á√ïES DO DASHBOARD (NOVAS)
    // ============================================

    function atualizarDashboard() {
      console.log('üîÑ Atualizando dashboard...');
      
      if (ncModule.dados.length === 0) {
        showNotification('üì≠ Carregue dados de NCs primeiro para ver o dashboard', 'warning');
        return;
      }
      
      dashboardModule.atualizarDashboard();
      showNotification('‚úÖ Dashboard atualizado com sucesso', 'success');
    }

    function setDashboardPeriod(periodo, evt) {
      // Remover active de todos os bot√µes
      const buttons = document.querySelectorAll('.time-btn');
      buttons.forEach(btn => btn.classList.remove('active'));

      if (evt && evt.classList && typeof evt.classList.add === 'function') {
        evt.classList.add('active');
      } else if (evt && evt.target && evt.target.classList) {
        evt.target.classList.add('active');
      } else {
        for (const btn of buttons) {
          const textMatches = btn.textContent && btn.textContent.trim().startsWith(periodo.replace('d',''));
          const dataMatches = btn.dataset && btn.dataset.period === periodo;
          if (textMatches || dataMatches) {
            btn.classList.add('active');
            break;
          }
        }
      }

      dashboardModule.periodo = periodo;
      dashboardModule.atualizarDashboard();
    }

    function exportChart(chartId, filename) {
      const chart = dashboardModule.charts[chartId];
      if (!chart) return;
      
      const link = document.createElement('a');
      link.download = `${filename}_${new Date().toISOString().split('T')[0]}.png`;
      link.href = chart.toBase64Image();
      link.click();
      
      showNotification('üì• Gr√°fico exportado com sucesso', 'success');
    }

    function toggleChartType(chartId) {
      const chart = dashboardModule.charts[chartId];
      if (!chart) return;
      
      const types = ['bar', 'line', 'pie', 'doughnut'];
      const currentIndex = types.indexOf(chart.config.type);
      const nextIndex = (currentIndex + 1) % types.length;
      
      chart.config.type = types[nextIndex];
      chart.update();
      
      showNotification(`üîÑ Gr√°fico alterado para ${types[nextIndex]}`, 'info');
    }

    function exportDashboardPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(20);
      doc.text('RONDOLOG - RELAT√ìRIO DE AN√ÅLISE DE NCs', 105, 15, { align: 'center' });
      
      doc.setFontSize(10);
      doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, 22, { align: 'center' });
      doc.text(`Usu√°rio: ${firebaseAuth.currentUser?.email || 'N√£o autenticado'}`, 105, 28, { align: 'center' });
      doc.text(`Per√≠odo: ${dashboardModule.getPeriodoTexto()}`, 105, 34, { align: 'center' });
      
      // Adicionar m√©tricas
      doc.setFontSize(14);
      doc.text('üìä M√âTRICAS PRINCIPAIS', 20, 45);
      
      const metrics = [
        [`Total de NCs:`, document.getElementById('dashboardTotalNCs').textContent],
        [`M√©dia Di√°ria:`, document.getElementById('dashboardMediaDiaria').textContent],
        [`Ve√≠culo com + NCs:`, document.getElementById('dashboardTopVeiculo').textContent],
        [`Motorista com + NCs:`, document.getElementById('dashboardTopMotorista').textContent]
      ];
      
      let yPos = 55;
      metrics.forEach(([label, value]) => {
        doc.text(`${label} ${value}`, 20, yPos);
        yPos += 8;
      });
      
      // Adicionar resumo
      doc.setFontSize(14);
      doc.text('üìà RESUMO ESTAT√çSTICO', 20, yPos + 10);
      yPos += 20;
      
      doc.setFontSize(10);
      doc.text(`‚Ä¢ Per√≠odo analisado: ${dashboardModule.getPeriodoTexto()}`, 20, yPos);
      yPos += 7;
      doc.text(`‚Ä¢ √öltima atualiza√ß√£o: ${new Date().toLocaleString('pt-BR')}`, 20, yPos);
      yPos += 7;
      doc.text(`‚Ä¢ Total de registros analisados: ${ncModule.dados.length}`, 20, yPos);
      
      doc.save(`rondolog_dashboard_${new Date().toISOString().split('T')[0]}.pdf`);
      
      showNotification('üìã Relat√≥rio do dashboard exportado com sucesso', 'success');
      syncLog.add('export', 'Relat√≥rio do dashboard exportado em PDF', {
        user: firebaseAuth.currentUser?.email
      });
    }

    // ============================================
    // üé™ CONTROLE DE ABAS
    // ============================================

    function showTab(tabName) {
      console.log(`üé™ Mostrando aba: ${tabName}`);
      
      // Controle especial para dashboard
      if (tabName === 'dashboard') {
        console.log('üìä Dashboard detectado - usando inicializa√ß√£o segura');
        
        // Chamar inicializa√ß√£o segura
        setTimeout(() => {
          if (typeof inicializarDashboardSeguro === 'function') {
            inicializarDashboardSeguro();
          }
        }, 300);
      }
      
      // Esconder todas as abas
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      // Remover active de todos os bot√µes
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

      // Mostrar aba selecionada
      const tabId = `tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`;
      const tabEl = document.getElementById(tabId);
      if (tabEl) tabEl.classList.add('active');

      // Ativar bot√£o correspondente por ordem conhecida
      const tabOrder = { frota: 0, naoConformidades: 1, dashboard: 2 };
      const idx = tabOrder[tabName] !== undefined ? tabOrder[tabName] : null;
      const btns = document.querySelectorAll('.tab-btn');
      if (idx !== null && btns[idx]) btns[idx].classList.add('active');

      // Se for a aba de n√£o conformidades, verificar permiss√£o
      if (tabName === 'naoConformidades') {
        setupNcTableSorting();
        setupNcFilters();
        if (ncModule.dados.length === 0) {
          if (permissionManager.canAccessNCs()) {
            ncModule.carregarDoFirebase();
          } else {
            showNotification('üîí Apenas ADMIN ou MANAGER podem acessar NCs', 'warning');
            updateNcStatus('üîí Acesso restrito a ADMIN/MANAGER');
          }
        }
      }

      // Se for a aba de dashboard, inicializar
      if (tabName === 'dashboard') {
        if (ncModule.dados.length === 0) {
          showNotification('üì≠ Carregue dados de NCs primeiro para ver o dashboard', 'warning');
        } else {
          dashboardModule.atualizarDashboard();
        }
      }
    }

    function setupNcTableSorting() {
      const headers = document.querySelectorAll('#ncDataTable thead th[data-sort]');
      headers.forEach(header => {
        header.addEventListener('click', () => {
          const column = header.getAttribute('data-sort');
          
          headers.forEach(h => {
            if (h !== header) {
              h.classList.remove('sorted-asc', 'sorted-desc');
            }
          });

          if (ncModule.currentSort.column === column) {
            ncModule.currentSort.direction = ncModule.currentSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            ncModule.currentSort.column = column;
            ncModule.currentSort.direction = 'asc';
          }

          header.classList.add(ncModule.currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
          ncModule.aplicarFiltros();
          ncModule.renderizarTabela();
        });
      });
    }

    function setupNcFilters() {
      document.getElementById('ncTipoFilter').addEventListener('change', () => {
        ncModule.aplicarFiltros();
        ncModule.renderizarTabela();
      });
      
      document.getElementById('ncVeiculoFilter').addEventListener('input', () => {
        ncModule.aplicarFiltros();
        ncModule.renderizarTabela();
      });
      
      document.getElementById('ncMotoristaFilter').addEventListener('input', () => {
        ncModule.aplicarFiltros();
        ncModule.renderizarTabela();
      });
      
      document.getElementById('ncDataFilter').addEventListener('change', () => {
        ncModule.aplicarFiltros();
        ncModule.renderizarTabela();
      });
    }

    // ============================================
    // üî• FUN√á√ïES PRINCIPAIS DO SISTEMA
    // ============================================

    function initializeApp() {
      console.log('üöÄ RONDOLOG v15.2 - Inicializando aplica√ß√£o...');
      
      syncLog.add('system', 'Sistema RONDOLOG v15.2 inicializando...', {
        user: firebaseAuth.currentUser?.email
      });
      
      loadConfig();
      setupEventListeners();
      setupSorting();
      updateSaveStatus();
      updateDetailedStats();
      initSettings();
      
      // Mostrar menu de abas
      document.getElementById('tabMenu').style.display = 'flex';
      
      // Inicializar dashboard
      dashboardModule.inicializar();
      
      // Conectar ao Firebase
      connectToFirebase();
    }

    async function connectToFirebase() {
      try {
        const connected = await firebaseService.connect();
        if (connected) {
          isOnlineMode = true;
          updateSyncInfo('Conectado ao Firebase');
          
          firebaseRealtimeListener = firebaseService.setupRealtimeListener((vehicles) => {
            console.log('üîÑ Dados atualizados em tempo real:', vehicles.length);
            vehicleData = vehicles;
            applyFiltersAndRender();
            updateSummaryCards();
            updateSettingsStats();
            updateDetailedStats();
            appStats.localCount = vehicles.length;
          });
          
          await loadInitialData();
        }
      } catch (error) {
        console.error('‚ùå Falha na inicializa√ß√£o do Firebase:', error);
        updateSyncInfo('Modo offline - Dados locais');
        applyFiltersAndRender();
      }
      
      console.log('‚úÖ Sistema inicializado');
      syncLog.add('system', 'Sistema inicializado com sucesso', {
        user: firebaseAuth.currentUser?.email
      });
    }

    async function loadInitialData() {
      console.log('üöÄ loadInitialData iniciada');
      console.log('üîê Usu√°rio atual:', firebaseAuth.currentUser);
      
      // TESTE: For√ßar permiss√£o temporariamente (REMOVA DEPOIS)
      console.log('‚ö†Ô∏è TESTE: Ignorando verifica√ß√£o de permiss√µes');
      
      // COMENTE TEMPORARIAMENTE A VERIFICA√á√ÉO:
      // if (!permissionManager.canAccessVehicles()) {
      //   showNotification('üîí Sem permiss√£o para acessar ve√≠culos', 'error');
      //   updateSyncInfo('Permiss√£o negada');
      //   return;
      // }
      
      try {
        
        showNotification('üì• Carregando dados do servidor...', 'info');
        updateSyncInfo('Carregando dados...');
        
        const vehicles = await firebaseService.loadVehicles();
        
        if (vehicles.length > 0) {
          vehicleData = vehicles;
          applyFiltersAndRender();
          appStats.loads++;
          appStats.localCount = vehicles.length;
          appStats.totalProcessed += vehicles.length;
          appStats.lastUpdate = new Date().toISOString();
          updateSettingsStats();
          updateSystemInfo();
          saveConfig();
          
          showNotification(`‚úÖ ${vehicles.length} ve√≠culos carregados do servidor`, 'success');
          updateSyncInfo(`${vehicles.length} ve√≠culos carregados`);
          syncLog.add('load', `Dados iniciais carregados: ${vehicles.length} ve√≠culos`);
        } else {
          updateSyncInfo('Nenhum dado encontrado');
          syncLog.add('load', 'Nenhum dado encontrado no Firebase');
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar dados:', error);
        
        if (error.message.includes('permission_denied') || error.message.includes('401')) {
          showNotification('üîí Sem permiss√£o para acessar dados', 'error');
          updateSyncInfo('Permiss√£o negada');
        } else {
          showNotification('‚ö†Ô∏è Erro ao carregar dados do servidor', 'warning');
          updateSyncInfo('Erro ao carregar');
        }
        
        syncLog.add('error', 'Erro ao carregar dados iniciais', { error: error.message });
      }
    }

    async function saveToFirebase() {
      if (vehicleData.length === 0) {
        showNotification('üì≠ Nenhum dado para salvar', 'warning');
        return false;
      }
      
      if (syncInProgress) {
        showNotification('‚è≥ J√° sincronizando...', 'info');
        return false;
      }
      
      if (!confirm(`üíæ SALVAR NO FIREBASE - RONDOLOG\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n` +
                   `Esta a√ß√£o ir√° salvar ${vehicleData.length} ve√≠culos no Firebase.\n\n` +
                   `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n` +
                   `Deseja continuar?`)) {
        return false;
      }
      
      syncInProgress = true;
      showNotification('üíæ Salvando no Firebase...', 'info');
      updateSyncInfo('Salvando dados...');
      syncLog.add('save', `Iniciando salvamento de ${vehicleData.length} ve√≠culos`, {
        user: firebaseAuth.currentUser?.email
      });
      
      try {
        await firebaseService.saveAllVehicles(vehicleData);
        
        appStats.saves++;
        appStats.lastSync = new Date().toISOString();
        appStats.firebaseCount = vehicleData.length;
        appStats.totalProcessed += vehicleData.length;
        appStats.lastUpdate = new Date().toISOString();
        lastSaveTime = new Date();
        updateSaveStatus();
        updateSettingsStats();
        updateSystemInfo();
        saveConfig();
        
        showNotification(`‚úÖ ${vehicleData.length} ve√≠culos salvos no Firebase!`, 'success');
        updateSyncInfo(`‚úÖ Salvo: ${vehicleData.length} ve√≠culos`);
        updateOnlineStatus(true);
        
        syncLog.add('save', `Salvamento conclu√≠do`, { 
          count: vehicleData.length,
          user: firebaseAuth.currentUser?.email
        });
        
        return true;
        
      } catch (error) {
        console.error('‚ùå Erro ao salvar no Firebase:', error);
        showNotification(`‚ùå Erro: ${error.message}`, 'error');
        updateSyncInfo('‚ùå Erro ao salvar');
        updateOnlineStatus(false);
        appStats.errors++;
        updateSettingsStats();
        saveConfig();
        syncLog.add('error', 'Erro no salvamento', { 
          error: error.message, 
          count: vehicleData.length,
          user: firebaseAuth.currentUser?.email
        });
        return false;
        
      } finally {
        syncInProgress = false;
      }
    }

    // ============================================
    // üéØ FUN√á√ïES DO SISTEMA (EXISTENTES)
    // ============================================

    let vehicleData = [];
    let filteredData = [];
    let currentSort = { column: null, direction: 'asc' };
    let currentEditIndex = -1;
    let lastSaveTime = null;
    let lastSyncSheetsTime = null;
    let isDarkMode = false;
    let isOnlineMode = false;
    let syncInProgress = false;
    let firebaseRealtimeListener = null;

    function openAddModal() {
      if (!permissionManager.canWriteVehicles()) {
        showNotification('‚ö†Ô∏è Voc√™ n√£o tem permiss√£o para adicionar ve√≠culos', 'warning');
        return;
      }
      
      currentEditIndex = -1;
      modalTitle.textContent = 'Adicionar Novo Ve√≠culo';
      clearEditForm();
      editModal.style.display = 'flex';
      closeSettingsMenu();
    }

    function openEditModal(index) {
      if (!permissionManager.canWriteVehicles()) {
        showNotification('‚ö†Ô∏è Voc√™ n√£o tem permiss√£o para editar ve√≠culos', 'warning');
        return;
      }
      
      currentEditIndex = index;
      const vehicle = vehicleData[index];

      modalTitle.textContent = 'Editar Ve√≠culo';
      document.getElementById('editPlaca').value = vehicle.placa || '';
      document.getElementById('editVigenciaChecklist').value = formatDateForInput(vehicle.vigenciaChecklist) || '';
      document.getElementById('editStatusChecklist').value = vehicle.statusChecklist || '';

      editModal.style.display = 'flex';
    }

    function clearEditForm() {
      document.getElementById('editPlaca').value = '';
      document.getElementById('editVigenciaChecklist').value = '';
      document.getElementById('editStatusChecklist').value = '';
      
      document.querySelectorAll('.error-message').forEach(el => {
        el.style.display = 'none';
      });
      document.querySelectorAll('.form-control').forEach(el => {
        el.classList.remove('error');
      });
    }

    function closeEditModal() {
      editModal.style.display = 'none';
    }

    async function handleFormSubmit(e) {
      e.preventDefault();
      
      if (!firebaseAuth.hasPermission('add_vehicles') && currentEditIndex === -1) {
        showNotification('‚ö†Ô∏è Voc√™ n√£o tem permiss√£o para adicionar ve√≠culos', 'warning');
        return;
      }
      
      if (!firebaseAuth.hasPermission('edit_own') && !firebaseAuth.hasPermission('edit_all') && currentEditIndex !== -1) {
        showNotification('‚ö†Ô∏è Voc√™ n√£o tem permiss√£o para editar ve√≠culos', 'warning');
        return;
      }
      
      const placa = document.getElementById('editPlaca').value;
      const vigenciaChecklist = document.getElementById('editVigenciaChecklist').value;
      const statusChecklist = document.getElementById('editStatusChecklist').value;
      
      let isValid = true;
      
      if (!placa) {
        document.getElementById('placaError').style.display = 'block';
        document.getElementById('editPlaca').classList.add('error');
        isValid = false;
      }
      
      if (!vigenciaChecklist) {
        document.getElementById('vigenciaChecklistError').style.display = 'block';
        document.getElementById('editVigenciaChecklist').classList.add('error');
        isValid = false;
      }
      
      if (!statusChecklist) {
        document.getElementById('statusChecklistError').style.display = 'block';
        document.getElementById('editStatusChecklist').classList.add('error');
        isValid = false;
      }
      
      if (!isValid) {
        showNotification('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios', 'warning');
        return;
      }
      
      const newVehicle = {
        placa: placa.toUpperCase().trim(),
        vigenciaChecklist: vigenciaChecklist,
        statusChecklist: statusChecklist,
        statusGeral: calculateStatusGeral(vigenciaChecklist, statusChecklist),
        updatedBy: firebaseAuth.currentUser?.email || 'Sistema',
        createdAt: currentEditIndex === -1 ? new Date().toISOString() : vehicleData[currentEditIndex].createdAt
      };

      if (currentEditIndex === -1) {
        vehicleData.push(newVehicle);
        showNotification('‚úÖ Ve√≠culo adicionado localmente', 'success');
        syncLog.add('edit', 'Novo ve√≠culo adicionado', { 
          placa: newVehicle.placa,
          user: firebaseAuth.currentUser?.email
        });
      } else {
        vehicleData[currentEditIndex] = newVehicle;
        showNotification('‚úÖ Dados atualizados localmente', 'success');
        syncLog.add('edit', 'Ve√≠culo editado', { 
          placa: newVehicle.placa, 
          index: currentEditIndex,
          user: firebaseAuth.currentUser?.email
        });
      }

      applyFiltersAndRender();
      updateSettingsStats();
      updateDetailedStats();
      appStats.localCount = vehicleData.length;
      appStats.totalProcessed++;
      appStats.lastUpdate = new Date().toISOString();
      updateSystemInfo();
      
      if (isOnlineMode) {
        setTimeout(async () => {
          try {
            await firebaseService.saveAllVehicles(vehicleData);
            console.log('‚úÖ Altera√ß√µes sincronizadas com Firebase');
            syncLog.add('sync', 'Altera√ß√µes sincronizadas com Firebase em background', { 
              count: vehicleData.length,
              user: firebaseAuth.currentUser?.email
            });
          } catch (error) {
            console.error('‚ùå Erro na sincroniza√ß√£o:', error);
            syncLog.add('error', 'Erro na sincroniza√ß√£o em background', { 
              error: error.message,
              user: firebaseAuth.currentUser?.email
            });
          }
        }, 500);
      }
      
      closeEditModal();
    }

    async function deleteVehicle(index) {
      if (!permissionManager.canWriteVehicles()) {
        showNotification('‚ö†Ô∏è Voc√™ n√£o tem permiss√£o para excluir ve√≠culos', 'warning');
        return;
      }
      
      const vehicle = vehicleData[index];
      const placa = vehicle.placa;
      
      if (confirm(`üóëÔ∏è Excluir ve√≠culo ${placa}?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
        try {
          await firebaseService.deleteVehicle(placa);
          
          vehicleData.splice(index, 1);
          applyFiltersAndRender();
          updateSummaryCards();
          updateSettingsStats();
          
          showNotification(`‚úÖ Ve√≠culo ${placa} exclu√≠do`, 'success');
          syncLog.add('delete', `Ve√≠culo ${placa} exclu√≠do`, { 
            user: firebaseAuth.currentUser?.email 
          });
          
        } catch (error) {
          console.error('‚ùå Erro ao excluir:', error);
          showNotification(`‚ùå Erro ao excluir ve√≠culo: ${error.message}`, 'error');
          syncLog.add('error', `Erro ao excluir ve√≠culo ${placa}`, { error: error.message });
        }
      }
    }

    function applyFiltersAndRender() {
      const statusValue = statusFilter.value;
      const dateValue = dateFilter.value;
      const searchValue = searchInput.value.trim().toLowerCase();
      
      filteredData = vehicleData.filter(vehicle => {
        let statusMatch = true;
        if (statusValue !== 'all') {
          switch(statusValue) {
            case 'valid':
              statusMatch = vehicle.statusGeral === 'OK';
              break;
            case 'pending':
              statusMatch = vehicle.statusGeral === 'PENDENTE';
              break;
            case 'expired':
              statusMatch = vehicle.statusGeral === 'VENCIDO';
              break;
          }
        }
        
        const dateMatch = !dateValue || vehicle.vigenciaChecklist === dateValue;
        
        const searchMatch = !searchValue || 
          (vehicle.placa && vehicle.placa.toLowerCase().includes(searchValue)) ||
          (vehicle.statusChecklist && vehicle.statusChecklist.toLowerCase().includes(searchValue)) ||
          (vehicle.vigenciaChecklist && vehicle.vigenciaChecklist.toString().toLowerCase().includes(searchValue));
        
        return statusMatch && dateMatch && searchMatch;
      });
      
      if (currentSort.column) {
        sortFilteredData(currentSort.column, currentSort.direction);
      }
      
      renderTable();
      updateSummaryCards();
    }

    function setupSorting() {
      const headers = document.querySelectorAll('#dataTable thead th[data-sort]');
      headers.forEach(header => {
        header.addEventListener('click', () => {
          const column = header.getAttribute('data-sort');
          
          headers.forEach(h => {
            if (h !== header) {
              h.classList.remove('sorted-asc', 'sorted-desc');
            }
          });

          if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            currentSort.column = column;
            currentSort.direction = 'asc';
          }

          header.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
          applyFiltersAndRender();
        });
      });
    }

    function sortFilteredData(column, direction) {
      filteredData.sort((a, b) => {
        let aValue = a[column] || '';
        let bValue = b[column] || '';
        
        if (column === 'vigenciaChecklist') {
          aValue = aValue ? new Date(aValue) : new Date(0);
          bValue = bValue ? new Date(bValue) : new Date(0);
        }
        
        if (typeof aValue === 'string') {
          aValue = aValue.toLowerCase();
          bValue = bValue.toLowerCase();
        }
        
        if (aValue < bValue) return direction === 'asc' ? -1 : 1;
        if (aValue > bValue) return direction === 'asc' ? 1 : -1;
        return 0;
      });
    }

    function renderTable() {
      const tbody = document.getElementById('tableBody');
      
      if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-secondary);">Nenhum dado encontrado</td></tr>';
        totalCount.textContent = vehicleData.length;
        filteredCount.textContent = 0;
        return;
      }

      tbody.innerHTML = filteredData.map((vehicle, index) => {
        const originalIndex = vehicleData.findIndex(v => 
          v.placa === vehicle.placa && 
          v.vigenciaChecklist === vehicle.vigenciaChecklist
        );
        
        let rowClass = '';
        let statusClass = '';
        let statusText = vehicle.statusGeral || 'PENDENTE';
        
        switch(vehicle.statusGeral) {
          case 'VENCIDO':
            rowClass = 'expired';
            statusClass = 'status-expired';
            break;
          case 'OK':
            statusClass = 'status-valid';
            break;
          default:
            statusClass = 'status-invalid';
            rowClass = 'pending';
        }
        
        const canEdit = firebaseAuth.hasPermission('edit_own') || firebaseAuth.hasPermission('edit_all');
        const canDelete = firebaseAuth.hasPermission('delete_all');
        
        return `
          <tr class="${rowClass}">
            <td><span class="vehicle-plate">${vehicle.placa || '-'}</span></td>
            <td>${formatDate(vehicle.vigenciaChecklist)}</td>
            <td>${vehicle.statusChecklist || '-'}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>
              <div class="action-buttons">
                ${canEdit ? `<button class="btn-edit" onclick="openEditModal(${originalIndex})">Editar</button>` : ''}
                ${canDelete ? `<button class="btn-delete" onclick="deleteVehicle(${originalIndex})">Excluir</button>` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');

      totalCount.textContent = vehicleData.length;
      filteredCount.textContent = filteredData.length;
    }

    function updateSummaryCards() {
      const total = vehicleData.length;
      const expired = vehicleData.filter(v => v.statusGeral === 'VENCIDO').length;
      const ok = vehicleData.filter(v => v.statusGeral === 'OK').length;
      const pendente = vehicleData.filter(v => v.statusGeral === 'PENDENTE').length;

      totalVehicles.textContent = total;
      validVehicles.textContent = ok;
      warningVehicles.textContent = pendente;
      expiredVehicles.textContent = expired;
    }

    function updateSaveStatus() {
      if (lastSaveTime) {
        const now = new Date();
        const diff = Math.floor((now - lastSaveTime) / 1000);
        
        let text = '';
        if (diff < 60) {
          text = `√öltima sincroniza√ß√£o: ${diff} segundos atr√°s`;
        } else if (diff < 3600) {
          text = `√öltima sincroniza√ß√£o: ${Math.floor(diff / 60)} minutos atr√°s`;
        } else {
          text = `√öltima sincroniza√ß√£o: ${lastSaveTime.toLocaleString('pt-BR')}`;
        }
        
        lastSaveInfo.textContent = text;
      } else {
        lastSaveInfo.textContent = 'Nunca sincronizado';
      }
    }

    function setupEventListeners() {
      btnDarkMode.addEventListener('click', toggleDarkMode);
      statusFilter.addEventListener('change', applyFiltersAndRender);
      dateFilter.addEventListener('change', applyFiltersAndRender);
      searchInput.addEventListener('input', applyFiltersAndRender);
      btnCancelModal.addEventListener('click', closeEditModal);
      editForm.addEventListener('submit', handleFormSubmit);
      
      window.addEventListener('click', function(e) {
        if (e.target === editModal) {
          closeEditModal();
        }
        if (e.target === document.getElementById('userManagerModal')) {
          closeUserManager();
        }
        if (e.target === document.getElementById('ncViewModal')) {
          closeNcViewModal();
        }
      });
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      isDarkMode = document.body.classList.contains('dark-mode');
      
      if (isDarkMode) {
        btnDarkMode.innerHTML = '<span>‚òÄÔ∏è</span> Modo Claro';
        localStorage.setItem('rondolog_dark_mode', 'true');
        syncLog.add('system', 'Modo escuro ativado', {
          user: firebaseAuth.currentUser?.email
        });
      } else {
        btnDarkMode.innerHTML = '<span>üåô</span> Modo Escuro';
        localStorage.setItem('rondolog_dark_mode', 'false');
        syncLog.add('system', 'Modo claro ativado', {
          user: firebaseAuth.currentUser?.email
        });
      }
    }

    function updateOnlineStatus(connected) {
      isOnlineMode = connected;
      
      if (onlineStatus) {
        if (connected) {
          onlineStatus.className = 'online-status online';
          onlineStatus.innerHTML = '<span class="online-dot"></span> Online';
        } else {
          onlineStatus.className = 'online-status offline';
          onlineStatus.innerHTML = '<span class="offline-dot"></span> Offline';
        }
      }
      
      if (syncStatusMini) {
        if (connected) {
          syncStatusMini.className = 'sync-info-mini';
          syncStatusMini.innerHTML = '<span class="online-dot" style="width: 8px; height: 8px;"></span> Online - Conectado';
        } else {
          syncStatusMini.className = 'sync-info-mini offline';
          syncStatusMini.innerHTML = '<span class="offline-dot" style="width: 8px; height: 8px;"></span> Offline - Sem conex√£o';
        }
      }
    }

    function updateSyncInfo(message) {
      if (syncInfo) {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        syncInfo.innerHTML = `${message} <small style="opacity:0.7;">(${timeStr})</small>`;
      }
    }

    function loadConfig() {
      isDarkMode = localStorage.getItem('rondolog_dark_mode') === 'true';
      if (isDarkMode) {
        document.body.classList.add('dark-mode');
        btnDarkMode.innerHTML = '<span>‚òÄÔ∏è</span> Modo Claro';
      }
      
      const savedStats = localStorage.getItem('rondolog_stats');
      if (savedStats) {
        appStats = JSON.parse(savedStats);
        updateDetailedStats();
        updateSettingsStats();
        updateSystemInfo();
      }
    }

    function saveConfig() {
      localStorage.setItem('rondolog_dark_mode', isDarkMode.toString());
      localStorage.setItem('rondolog_stats', JSON.stringify(appStats));
    }

    async function exportXLS() {
      let dataToExport = filteredData;
      let filename = `rondolog_frota_${new Date().toISOString().split('T')[0]}.xlsx`;

      if (dataToExport.length === 0) {
        alert('Nenhum dado para exportar! Aplique filtros diferentes ou carregue dados.');
        return;
      }

      const excelData = dataToExport.map(vehicle => ({
        'PLACA': vehicle.placa || '',
        'CHECKLIST VIG√äNCIA': formatDate(vehicle.vigenciaChecklist),
        'CHECKLIST STATUS': vehicle.statusChecklist || '',
        'STATUS GERAL': vehicle.statusGeral || ''
      }));

      const xlsxSrc = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
      const ensureXLSX = window.XLSX ? Promise.resolve() : loadScriptOnce(xlsxSrc);
      await ensureXLSX;
      const worksheet = XLSX.utils.json_to_sheet(excelData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Checklist');

      const colWidths = [
        { wch: 12 }, { wch: 20 }, { wch: 18 }, { wch: 15 }
      ];
      worksheet['!cols'] = colWidths;

      XLSX.writeFile(workbook, filename);
      syncLog.add('export', `Exportado para Excel: ${dataToExport.length} registros`, { 
        filename,
        user: firebaseAuth.currentUser?.email
      });
      closeSettingsMenu();
    }

    async function exportPDF() {
      const jsPDFsrc = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
      const autoTableSrc = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js';

      try {
        if (!window.jspdf && !window.jsPDF) await loadScriptOnce(jsPDFsrc);
        if (!window.jspdf || !window.jspdf.jsPDF) {
          if (window.jsPDF && !window.jspdf) window.jspdf = { jsPDF: window.jsPDF };
        }
        if (!window.jspdf || !window.jspdf.jsPDF) {
          if (!window.jsPDF) await loadScriptOnce(jsPDFsrc);
          if (window.jsPDF && !window.jspdf) window.jspdf = { jsPDF: window.jsPDF };
        }

        if (!('autoTable' in (window.jspdf || window))) await loadScriptOnce(autoTableSrc);

        const { jsPDF } = window.jspdf || window;
        const doc = new jsPDF();

        doc.setFontSize(20);
        doc.setTextColor(40, 40, 40);
        doc.text('RONDOLOG - RELAT√ìRIO DE CHECKLIST', 105, 15, { align: 'center' });

        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, 22, { align: 'center' });
        doc.text(`Usu√°rio: ${firebaseAuth.currentUser?.email || 'N√£o autenticado'}`, 105, 28, { align: 'center' });

        let dataToExport = filteredData;
        let title = 'RELAT√ìRIO DA FROTA';

        if (dataToExport.length === 0) {
          doc.text('Nenhum dado para exportar', 20, 40);
        } else {
          doc.setFontSize(14);
          doc.setTextColor(0, 0, 0);
          doc.text(title, 20, 35);

          const tableData = dataToExport.map(vehicle => [
            vehicle.placa || '',
            formatDate(vehicle.vigenciaChecklist),
            vehicle.statusChecklist || '',
            vehicle.statusGeral || ''
          ]);

          if (typeof doc.autoTable === 'function') {
            doc.autoTable({
              startY: 45,
              head: [['PLACA', 'CHECKLIST VIG√äNCIA', 'CHECKLIST STATUS', 'STATUS GERAL']],
              body: tableData,
              styles: { fontSize: 8 },
              headStyles: { fillColor: [0, 0, 0] },
              columnStyles: {
                0: { cellWidth: 25 },
                1: { cellWidth: 30 },
                2: { cellWidth: 30 },
                3: { cellWidth: 25 }
              }
            });
          } else if (window.jspdf && window.jspdf.autoTable) {
            window.jspdf.autoTable(doc, {
              startY: 45,
              head: [['PLACA', 'CHECKLIST VIG√äNCIA', 'CHECKLIST STATUS', 'STATUS GERAL']],
              body: tableData,
              styles: { fontSize: 8 }
            });
          } else {
            let y = 45;
            tableData.forEach(row => {
              doc.text(row.join(' | '), 20, y);
              y += 6;
              if (y > 270) { doc.addPage(); y = 20; }
            });
          }
        }

        const pageCount = doc.internal.getNumberOfPages();
        for(let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.setTextColor(100, 100, 100);
          doc.text(`P√°gina ${i} de ${pageCount} - RONDOLOG Sistema de Gest√£o`, 105, 285, { align: 'center' });
        }

        doc.save(`rondolog_relatorio_${new Date().toISOString().split('T')[0]}.pdf`);
        syncLog.add('export', `Exportado para PDF: ${dataToExport.length} registros`, {
          user: firebaseAuth.currentUser?.email
        });
        closeSettingsMenu();
      } catch (e) {
        console.error('Erro ao gerar PDF:', e);
        showNotification('‚ùå Erro ao gerar PDF. Veja o console para detalhes.', 'error');
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px; padding: 15px 20px;">
          <span style="font-size: 20px;">
            ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚è≥'}
          </span>
          <span>${message}</span>
        </div>
      `;
      
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#00c853' : type === 'error' ? '#ff0000' : type === 'warning' ? '#ff9800' : '#2196f3'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9999;
        max-width: 400px;
        animation: slideIn 0.3s ease;
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (notification.parentNode) {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => notification.remove(), 300);
        }
      }, 4000);
    }

    // ============================================
    // üîé DEDUPE: encontrar e remover duplicados de N√£o Conformidades
    // ============================================

    function _nc_normalize_key(nc){
      const placa = (nc.veiculo || '').toString().toUpperCase().trim();
      const data = (nc.dataOcorrencia || '').toString().split(' ')[0].trim();
      const texto = (nc.naoConformidade || '').toString().replace(/\s+/g,' ').toLowerCase().trim();
      return `${placa}|${data}|${texto}`;
    }

    function findDuplicates(){
      const map = new Map();
      (ncModule.dados || []).forEach(item => {
        const key = _nc_normalize_key(item);
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(item);
      });

      const groups = [];
      for (const [key, arr] of map.entries()){
        if (arr.length > 1) groups.push({ key, items: arr });
      }

      try{
        const el = document.getElementById('duplicatesInfo');
        if (el){
          if (groups.length === 0) el.innerText = 'Nenhum duplicado encontrado.';
          else el.innerText = `${groups.length} grupos de duplicados encontrados ‚Äî total ${groups.reduce((s,g)=>s+g.items.length,0)} registros.`;
        }
      }catch(e){ console.warn('duplicatesInfo update failed', e); }

      return groups;
    }

    async function removeDuplicates({ keepLatest = false, deleteRemote = false } = {}){
      const groups = findDuplicates();
      if (groups.length === 0){
        showNotification('üîç Nenhum duplicado encontrado', 'info');
        return { removed: 0 };
      }

      let removedCount = 0;
      const toRemoveIds = [];

      const keepSet = new Set();

      groups.forEach(group => {
        let keep = null;
        if (keepLatest){
          keep = group.items.reduce((best, cur) => {
            const bestTime = (best.salvoEm || best.importadoEm || best.id || '').toString();
            const curTime = (cur.salvoEm || cur.importadoEm || cur.id || '').toString();
            return (curTime > bestTime) ? cur : best;
          }, group.items[0]);
        } else {
          keep = group.items[0];
        }

        keepSet.add(keep.id || JSON.stringify(keep));
        group.items.forEach(it => {
          const id = it.id || JSON.stringify(it);
          if (!keepSet.has(id)) {
            toRemoveIds.push(it.id);
          }
        });
      });

      if (toRemoveIds.length === 0){
        showNotification('Nenhum registro removido (estrutura inesperada)', 'warning');
        return { removed: 0 };
      }

      const before = ncModule.dados.length;
      ncModule.dados = (ncModule.dados || []).filter(item => !toRemoveIds.includes(item.id));
      removedCount = before - ncModule.dados.length;

      ncModule.atualizarEstatisticas();
      ncModule.aplicarFiltros();
      ncModule.renderizarTabela();
      atualizarDashboard();

      showNotification(`üßπ Removidos ${removedCount} registros duplicados (local)`, 'success');

      if (deleteRemote){
        if (!firebaseAuth.isAdmin()){
          showNotification('üîí Remo√ß√£o remota requer privil√©gio ADMIN', 'warning');
        } else if (confirm(`Deseja tamb√©m remover ${toRemoveIds.length} registros duplicados do Firebase? Esta a√ß√£o √© irrevers√≠vel.`)){
          try{
            for (const id of toRemoveIds){
              if (!id) continue;
              await fetch(`https://rondolog-frotas-default-rtdb.firebaseio.com/nc_dados/registros/${encodeURIComponent(id)}.json`, { method: 'DELETE' });
            }
            showNotification('‚úÖ Remo√ß√£o remota conclu√≠da', 'success');
          }catch(e){
            console.error('Erro removendo remotos', e);
            showNotification('‚ùå Erro removendo registros remotos', 'error');
          }
        }
      }

      return { removed: removedCount, groupsFound: groups.length };
    }

    async function removeDuplicatesKeepLatest(){
      return removeDuplicates({ keepLatest: true, deleteRemote: false });
    }

    // ============================================
    // üîê FUN√á√ïES DE RECUPERA√á√ÉO DE SENHA
    // ============================================

    async function resetPassword() {
      const email = prompt('Digite o email para reset de senha:');
      if (!email) return;
      
      try {
        await firebase.auth().sendPasswordResetEmail(email);
        alert(`‚úÖ Email de recupera√ß√£o enviado para ${email}`);
      } catch (error) {
        alert(`‚ùå Erro: ${error.message}`);
      }
    }

    // ============================================
    // üîç FUN√á√ÉO DIAGNOSE FIREBASE DATA
    // ============================================

    async function diagnoseFirebaseData() {
      try {
        showNotification('üîç Diagn√≥stico Firebase...', 'info');
        
        const connected = await firebaseService.testConnection();
        const connectionText = connected ? '‚úÖ Conectado' : '‚ùå Desconectado';
        
        const vehicleCount = vehicleData.length;
        const snapshot = await firebaseService.database.ref('vehicles').once('value');
        const firebaseCount = snapshot.exists() ? snapshot.numChildren() : 0;
        
        let ncCount = 0;
        try {
          const ncSnapshot = await firebaseService.database.ref('nc_dados/registros').once('value');
          ncCount = ncSnapshot.exists() ? ncSnapshot.numChildren() : 0;
        } catch (e) {
          console.warn('Erro ao contar NCs:', e);
        }
        
        const message = `
üéØ DIAGN√ìSTICO FIREBASE:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚Ä¢ Status: ${connectionText}
‚Ä¢ Ve√≠culos Local: ${vehicleCount}
‚Ä¢ Ve√≠culos Firebase: ${firebaseCount}
‚Ä¢ NCs Firebase: ${ncCount}
‚Ä¢ Sincroniza√ß√µes: ${appStats.saves || 0}
‚Ä¢ √öltima Sinc: ${appStats.lastSync ? new Date(appStats.lastSync).toLocaleString('pt-BR') : 'Nunca'}

${firebaseCount !== vehicleCount ? '‚ö†Ô∏è DESCRIPAN√áA: Local e Firebase divergem!' : '‚úÖ Contagens OK'}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        `.trim();
        
        alert(message);
        syncLog.add('diagnostic', 'Diagn√≥stico Firebase executado', {
          connected,
          local: vehicleCount,
          firebase: firebaseCount,
          ncCount,
          discrepancy: firebaseCount !== vehicleCount
        });
        
      } catch (error) {
        console.error('‚ùå Erro no diagn√≥stico:', error);
        showNotification('‚ùå Erro no diagn√≥stico', 'error');
      }
    }

    async function recoverAllData() {
      if (!confirm('üîÑ RECUPERAR TODOS OS DADOS\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nEsta a√ß√£o tentar√° recuperar dados do Firebase e do IndexedDB local.\n\nDeseja continuar?')) {
        return;
      }
      
      try {
        showNotification('üîÑ Recuperando dados...', 'info');
        
        await loadInitialData();
        
        try {
          const localData = await idb.get('vehicleData');
          if (localData && localData.length > 0) {
            showNotification(`üì¶ ${localData.length} registros encontrados localmente`, 'info');
            
            if (confirm(`Encontrei ${localData.length} registros locais. Deseja mesclar com os dados atuais?`)) {
              vehicleData = [...vehicleData, ...localData];
              applyFiltersAndRender();
              updateSettingsStats();
            }
          }
        } catch (e) {
          console.warn('Erro ao carregar dados locais:', e);
        }
        
        showNotification('‚úÖ Recupera√ß√£o conclu√≠da', 'success');
        syncLog.add('recovery', 'Recupera√ß√£o de dados executada');
        
      } catch (error) {
        console.error('‚ùå Erro na recupera√ß√£o:', error);
        showNotification('‚ùå Erro na recupera√ß√£o', 'error');
      }
    }

    function showDetailedStats() {
      const message = `
üìä ESTAT√çSTICAS DETALHADAS - RONDOLOG
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚Ä¢ Ve√≠culos Local: ${vehicleData.length}
‚Ä¢ Ve√≠culos Firebase: ${appStats.firebaseCount || 0}
‚Ä¢ NCs: ${ncModule.dados.length}
‚Ä¢ Sincroniza√ß√µes: ${appStats.saves || 0}
‚Ä¢ Carregamentos: ${appStats.loads || 0}
‚Ä¢ Logs: ${syncLog.entries.length}

üìÖ TEMPO:
‚Ä¢ √öltima Sinc: ${appStats.lastSync ? new Date(appStats.lastSync).toLocaleString('pt-BR') : 'Nunca'}
‚Ä¢ √öltima Atualiza√ß√£o: ${appStats.lastUpdate ? new Date(appStats.lastUpdate).toLocaleString('pt-BR') : 'Nunca'}

üë§ USU√ÅRIO:
‚Ä¢ Email: ${firebaseAuth.currentUser?.email || 'N√£o autenticado'}
‚Ä¢ Role: ${firebaseAuth.currentUser?.role || 'VIEWER'}
‚Ä¢ Permiss√µes: ${firebaseAuth.currentUser?.permissions?.join(', ') || 'Nenhuma'}

‚ïê‚ïê‚ïê √öLTIMOS LOGS ‚ïê‚ïê‚ïê
${syncLog.getRecent(5).map(log => 
  `${new Date(log.timestamp).toLocaleTimeString('pt-BR')} - ${log.message}`
).join('\n')}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      `.trim();
      
      alert(message);
      syncLog.add('stats', 'Estat√≠sticas detalhadas visualizadas');
    }

    function checkDataIntegrity() {
      showNotification('‚úÖ Verificando integridade...', 'info');
      
      const issues = [];
      
      vehicleData.forEach((vehicle, index) => {
        if (!vehicle.placa || vehicle.placa.trim() === '') {
          issues.push(`Ve√≠culo ${index}: Placa vazia`);
        }
        if (!vehicle.statusGeral) {
          issues.push(`Ve√≠culo ${vehicle.placa}: Status geral ausente`);
        }
      });
      
      ncModule.dados.forEach((nc, index) => {
        if (!nc.veiculo || nc.veiculo.trim() === '') {
          issues.push(`NC ${index}: Ve√≠culo vazio`);
        }
        if (!nc.naoConformidade || nc.naoConformidade.trim() === '') {
          issues.push(`NC ${index}: Descri√ß√£o vazia`);
        }
      });
      
      if (issues.length === 0) {
        showNotification('‚úÖ Dados √≠ntegros', 'success');
        alert('‚úÖ Verifica√ß√£o conclu√≠da: Todos os dados est√£o √≠ntegros!');
      } else {
        const message = `‚ö†Ô∏è FORAM ENCONTRADOS ${issues.length} PROBLEMAS:\n\n${issues.slice(0, 10).join('\n')}${issues.length > 10 ? `\n\n... e mais ${issues.length - 10} problemas` : ''}`;
        alert(message);
        showNotification(`‚ö†Ô∏è ${issues.length} problemas encontrados`, 'warning');
      }
      
      syncLog.add('integrity', 'Verifica√ß√£o de integridade executada', {
        issues: issues.length
      });
    }

    function analyzeCountDiscrepancy() {
      const localCount = vehicleData.length;
      const firebaseCount = appStats.firebaseCount || 0;
      
      if (localCount === firebaseCount) {
        showNotification('‚úÖ Contagens id√™nticas', 'success');
        return;
      }
      
      const diff = Math.abs(localCount - firebaseCount);
      const direction = localCount > firebaseCount ? 'LOCAL tem mais' : 'FIREBASE tem mais';
      
      const message = `
‚ö†Ô∏è DISCREP√ÇNCIA DETECTADA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚Ä¢ Local: ${localCount} ve√≠culos
‚Ä¢ Firebase: ${firebaseCount} ve√≠culos
‚Ä¢ Diferen√ßa: ${diff} ve√≠culos
‚Ä¢ Status: ${direction}

POSS√çVEIS CAUSAS:
1. Dados n√£o sincronizados
2. Exclus√µes em um lado apenas
3. Problema de conex√£o durante sync

A√á√ïES SUGERIDAS:
1. Clique em "Salvar no Firebase"
2. Clique em "Carregar do Firebase"
3. Use "Diagnosticar" para detalhes
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      `.trim();
      
      alert(message);
      syncLog.add('discrepancy', 'An√°lise de discrep√¢ncia', {
        local: localCount,
        firebase: firebaseCount,
        diff,
        direction
      });
    }

    function clearAllData() {
      if (!confirm('‚ö†Ô∏è üóëÔ∏è LIMPAR TODOS OS DADOS\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nEsta a√ß√£o ir√°:\n‚Ä¢ Remover TODOS os dados locais\n‚Ä¢ N√£o afeta o Firebase\n\nDeseja continuar?')) {
        return;
      }
      
      try {
        vehicleData = [];
        ncModule.dados = [];
        filteredData = [];
        
        applyFiltersAndRender();
        ncModule.atualizarEstatisticas();
        ncModule.aplicarFiltros();
        ncModule.renderizarTabela();
        
        updateSettingsStats();
        updateDetailedStats();
        
        showNotification('üóëÔ∏è Todos os dados locais foram limpos', 'success');
        syncLog.add('clear', 'Dados locais limpos', {
          user: firebaseAuth.currentUser?.email
        });
        
      } catch (error) {
        console.error('‚ùå Erro ao limpar dados:', error);
        showNotification('‚ùå Erro ao limpar dados', 'error');
      }
    }

    function resetFilters() {
      statusFilter.value = 'all';
      dateFilter.value = '';
      searchInput.value = '';
      
      if (document.getElementById('tabNaoConformidades')?.classList.contains('active')) {
        document.getElementById('ncTipoFilter').value = 'all';
        document.getElementById('ncVeiculoFilter').value = '';
        document.getElementById('ncMotoristaFilter').value = '';
        document.getElementById('ncDataFilter').value = '';
        ncModule.aplicarFiltros();
        ncModule.renderizarTabela();
      }
      
      applyFiltersAndRender();
      showNotification('üîÑ Filtros resetados', 'success');
    }

    function clearLogs() {
      syncLog.clear();
      updateDetailedStats();
    }

    // ============================================
    // üéØ INICIALIZA√á√ÉO DO SISTEMA
    // ============================================
    
    async function testFirebaseConnection() {
      try {
        if (!firebaseService) {
          showNotification('‚ö†Ô∏è Servi√ßo Firebase n√£o inicializado', 'warning');
          return false;
        }
        const ok = await firebaseService.testConnection();
        showNotification(ok ? '‚úÖ Firebase acess√≠vel' : '‚ö†Ô∏è Firebase n√£o acess√≠vel', ok ? 'success' : 'warning');
        return ok;
      } catch (e) {
        console.error('Erro testFirebaseConnection', e);
        showNotification('‚ùå Erro ao testar Firebase', 'error');
        return false;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ RONDOLOG v15.2 - Sistema de Gest√£o de Frotas');
      console.log('üîê Iniciando sistema de autentica√ß√£o Firebase...');
      
      initAuthentication();
    });

    // ============================================
    // üéØ FUN√á√ïES GLOBAIS
    // ============================================
    
    // Fun√ß√µes existentes
    window.openEditModal = openEditModal;
    window.deleteVehicle = deleteVehicle;
    window.exportPDF = exportPDF;
    window.exportXLS = exportXLS;
    window.applyFiltersAndRender = applyFiltersAndRender;
    window.testFirebaseConnection = testFirebaseConnection;
    window.loadInitialData = loadInitialData;
    window.saveToFirebase = saveToFirebase;
    window.diagnoseFirebaseData = diagnoseFirebaseData;
    window.recoverAllData = recoverAllData;
    window.showDetailedStats = showDetailedStats;
    window.checkDataIntegrity = checkDataIntegrity;
    window.analyzeCountDiscrepancy = analyzeCountDiscrepancy;
    window.exportBackupJSON = exportBackupJSON;
    window.toggleDarkMode = toggleDarkMode;
    window.openAddModal = openAddModal;
    window.clearAllData = clearAllData;
    window.resetFilters = resetFilters;
    window.clearLogs = clearLogs;
    window.removeDuplicates = removeDuplicates;
    window.removeDuplicatesKeepLatest = removeDuplicatesKeepLatest;
    window.findDuplicates = findDuplicates;
    
    // Fun√ß√µes de gerenciamento de usu√°rios
    window.openUserManager = openUserManager;
    window.closeUserManager = closeUserManager;
    window.changeUserRole = changeUserRole;
    window.toggleUserStatus = toggleUserStatus;
    window.resetUserPasswordPrompt = resetUserPasswordPrompt;
    window.generatePassword = generatePassword;
    window.createNewUser = createNewUser;
    window.openRoleManager = openRoleManager;
    window.viewAuditLogs = viewAuditLogs;
    window.systemDiagnostics = systemDiagnostics;
    
    // Fun√ß√µes de N√£o Conformidades
    window.ncImportarPlanilha = ncImportarPlanilha;
    window.ncConfigurarAlertas = ncConfigurarAlertas;
    window.ncLimparHistorico = ncLimparHistorico;
    window.ncVerEstatisticas = ncVerEstatisticas;
    window.ncVerDetalhes = ncVerDetalhes;
    window.ncExcluir = ncExcluir;
    window.closeNcViewModal = closeNcViewModal;
    window.ncExportarPDF = ncExportarPDF;
    
    // Fun√ß√µes do Dashboard
    window.showTab = showTab;
    window.atualizarDashboard = atualizarDashboard;
    window.setDashboardPeriod = setDashboardPeriod;
    window.exportChart = exportChart;
    window.toggleChartType = toggleChartType;
    window.exportDashboardPDF = exportDashboardPDF;
    
    // Fun√ß√µes de autentica√ß√£o
    window.resetPassword = resetPassword;
    
    // ============================================
    // üêõ FUN√á√ÉO DE DEBUG
    // ============================================
    
    function debugSistema() {
      console.log('üõ†Ô∏è ===== DEBUG DO SISTEMA =====');
      
      // 1. Estado do Firebase Auth
      const authUser = firebase.auth().currentUser;
      console.log('1. Firebase Auth User:', authUser?.email);
      console.log('2. Firebase Auth UID:', authUser?.uid);
      
      // 2. Estado do firebaseAuth
      console.log('3. firebaseAuth.currentUser:', firebaseAuth.currentUser);
      console.log('4. Role no firebaseAuth:', firebaseAuth.currentUser?.role);
      
      // 3. Estado do permissionManager
      console.log('5. permissionManager existe?', typeof permissionManager !== 'undefined');
      if (permissionManager) {
        console.log('6. canAccessVehicles:', permissionManager.canAccessVehicles());
        console.log('7. canAccessNCs:', permissionManager.canAccessNCs());
      }
      
      // 4. Verificar Database
      if (authUser?.uid) {
        firebase.database().ref(`users/${authUser.uid}`).once('value')
          .then(snapshot => {
            console.log('8. Database user encontrado?', snapshot.exists());
            if (snapshot.exists()) {
              console.log('9. Database user data:', snapshot.val());
            }
          })
          .catch(err => console.log('8. Erro ao acessar Database:', err));
      }
      
      console.log('üõ†Ô∏è ===== FIM DEBUG =====');
      
      // Mostrar alerta resumido
      alert(`DEBUG:
    Email: ${authUser?.email || 'N/A'}
    UID: ${authUser?.uid || 'N/A'}
    Role local: ${firebaseAuth.currentUser?.role || 'N/A'}
    canAccessVehicles: ${permissionManager?.canAccessVehicles?.() ? 'SIM' : 'N√ÉO'}`);
    }
    
    // Adicionar bot√£o de debug
    function addDebugButton() {
      const btn = document.createElement('button');
      btn.innerHTML = 'üêõ Debug';
      btn.style.position = 'fixed';
      btn.style.top = '70px';
      btn.style.right = '20px';
      btn.style.zIndex = '9999';
      btn.style.padding = '8px 12px';
      btn.style.background = '#2196f3';
      btn.style.color = 'white';
      btn.style.border = 'none';
      btn.style.borderRadius = '4px';
      btn.style.cursor = 'pointer';
      btn.style.fontSize = '12px';
      
      btn.onclick = debugSistema;
      
      document.body.appendChild(btn);
      console.log('‚úÖ Bot√£o debug adicionado');
    }
    
    // Chamar ap√≥s carregamento
    setTimeout(addDebugButton, 3000);
  </script>
  
  <!-- üöÄ SCRIPT DE INICIALIZA√á√ÉO R√ÅPIDA -->
  <script>
  // Inicializa√ß√£o autom√°tica quando a p√°gina carrega
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ RONDOLOG - Sistema de Gest√£o de Frotas');
    console.log('üîß Vers√£o com corre√ß√µes aplicadas');
    
    // Verificar se j√° est√° logado
    setTimeout(() => {
      const user = firebase.auth().currentUser;
      if (user && user.email === 'info.fvalentim@gmail.com') {
        console.log('‚úÖ Usu√°rio j√° logado:', user.email);
        
        // For√ßar configura√ß√£o como ADMIN
        if (window.firebaseAuth && window.firebaseAuth.currentUser) {
          window.firebaseAuth.currentUser.role = 'ADMIN';
          window.firebaseAuth.currentUser.permissions = ['create_users', 'edit_all', 'delete_all', 'system_config', 'nc_admin', 'nc_import'];
          
          // Atualizar interface
          if (typeof firebaseAuth.updateRoleBadge === 'function') {
            firebaseAuth.updateRoleBadge();
          }
        }
      }
    }, 1000);
    
    // Inicializar autentica√ß√£o
    if (typeof initAuthentication === 'function') {
      initAuthentication();
    }
  });
  </script>
  
  <script>
// ============================================
// üõ†Ô∏è CORRE√á√ïES DEFINITIVAS DO SISTEMA
// ============================================

// 1. CORRE√á√ÉO DO SISTEMA DE PERMISS√ïES
function aplicarCorrecaoPermissoes() {
  console.log('üõ†Ô∏è Aplicando corre√ß√£o de permiss√µes...');
  
  // Sobrescrever o sistema de permiss√µes problem√°tico
  const originalFetchUserRole = firebaseAuth.fetchUserRole;
  
  firebaseAuth.fetchUserRole = async function() {
    console.log('üîç fetchUserRole CORRIGIDO sendo executado...');
    
    if (!this.currentUser) {
      console.log('‚ùå Nenhum usu√°rio atual');
      return null;
    }
    
    try {
      console.log(`üë§ Usu√°rio: ${this.currentUser.email}`);
      console.log(`üîë UID: ${this.currentUser.uid}`);
      
      // SEMPRE retornar ADMIN para o usu√°rio principal
      if (this.currentUser.email === 'info.fvalentim@gmail.com') {
        console.log('üéØ Usu√°rio principal detectado, atribuindo ADMIN');
        
        this.currentUser = {
          ...this.currentUser,
          role: 'ADMIN',
          displayName: 'Fernando Administrador',
          permissions: ['create_users', 'edit_all', 'delete_all', 'system_config', 'nc_admin', 'nc_import']
        };
        
        this.updateRoleBadge();
        return this.currentUser;
      }
      
      // Para outros usu√°rios, tentar buscar do Firebase
      try {
        const userRef = firebase.database().ref(`users/${this.currentUser.uid}`);
        const snapshot = await userRef.once('value');
        
        if (snapshot.exists()) {
          const userData = snapshot.val();
          console.log('üìã Dados encontrados:', userData);
          
          const role = userData.role || 'VIEWER';
          
          this.currentUser = {
            ...this.currentUser,
            role: role,
            displayName: userData.displayName || this.currentUser.email.split('@')[0],
            permissions: this.getPermissions(role)
          };
          
        } else {
          console.log('‚ö†Ô∏è Usu√°rio n√£o encontrado, usando VIEWER');
          this.currentUser = {
            ...this.currentUser,
            role: 'VIEWER',
            permissions: this.getPermissions('VIEWER')
          };
        }
      } catch (dbError) {
        console.error('‚ùå Erro ao buscar do Database:', dbError);
        this.currentUser = {
          ...this.currentUser,
          role: 'ADMIN', // Fallback para ADMIN em caso de erro
          permissions: this.getPermissions('ADMIN')
        };
      }
      
      this.updateRoleBadge();
      return this.currentUser;
      
    } catch (error) {
      console.error('‚ùå Erro no fetchUserRole corrigido:', error);
      
      // Fallback definitivo
      this.currentUser = {
        ...this.currentUser,
        role: 'ADMIN',
        permissions: this.getPermissions('ADMIN')
      };
      
      this.updateRoleBadge();
      return this.currentUser;
    }
  };
  
  console.log('‚úÖ Corre√ß√£o de permiss√µes aplicada');
}

// 2. CORRE√á√ÉO DO DASHBOARD (evitar erro do Chart.js)
function aplicarCorrecaoDashboard() {
  console.log('üìä Aplicando corre√ß√£o do dashboard...');
  
  // Sobrescrever inicializa√ß√£o problem√°tica
  const originalInicializar = dashboardModule.inicializar;
  
  dashboardModule.inicializar = function() {
    console.log('üö´ Dashboard inicializa√ß√£o MODIFICADA');
    
    // N√£o inicializar gr√°ficos automaticamente
    // S√≥ inicializar quando a aba for clicada
    this.periodo = '7d';
    
    console.log('‚úÖ Dashboard configurado (gr√°ficos adiados)');
  };
  
  // Modificar showTab para controlar dashboard
  const originalShowTab = window.showTab;
  
  window.showTab = function(tabName) {
    console.log(`üé™ showTab chamado para: ${tabName}`);
    
    // Chamar fun√ß√£o original primeiro
    if (originalShowTab) {
      originalShowTab(tabName);
    }
    
    // Controle especial para dashboard
    if (tabName === 'dashboard') {
      setTimeout(() => {
        inicializarDashboardSeguro();
      }, 500);
    }
  };
  
  console.log('‚úÖ Corre√ß√£o do dashboard aplicada');
}

// 3. FUN√á√ÉO PARA INICIALIZAR DASHBOARD SEGURO
function inicializarDashboardSeguro() {
  console.log('üõ°Ô∏è Inicializando dashboard SEGURO...');
  
  // Verificar se h√° dados
  if (!ncModule || ncModule.dados.length === 0) {
    console.log('‚ö†Ô∏è Sem dados para dashboard');
    showNotification('üì≠ Carregue dados de NCs primeiro para ver o dashboard', 'warning');
    return;
  }
  
  // Destruir gr√°ficos antigos
  destruirGraficosAntigos();
  
  // Aguardar e criar novos gr√°ficos
  setTimeout(() => {
    criarGraficosSeguros();
  }, 1000);
}

// 4. DESTRUIR GR√ÅFICOS ANTIGOS
function destruirGraficosAntigos() {
  console.log('üóëÔ∏è Destruindo gr√°ficos antigos...');
  
  if (dashboardModule.charts) {
    Object.values(dashboardModule.charts).forEach(chart => {
      if (chart && typeof chart.destroy === 'function') {
        try {
          chart.destroy();
        } catch (e) {
          // Ignorar erros de destrui√ß√£o
        }
      }
    });
    dashboardModule.charts = {};
  }
  
  // Limpar canvases
  const canvasIds = ['chartTipoNC', 'chartEvolucao', 'chartTopVeiculos', 
                    'chartTopMotoristas', 'chartDiaSemana', 'chartComparativo'];
  
  canvasIds.forEach(id => {
    const canvas = document.getElementById(id);
    if (canvas) {
      const ctx = canvas.getContext('2d');
      if (ctx) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    }
  });
  
  console.log('‚úÖ Gr√°ficos antigos destru√≠dos');
}

// 5. CRIAR GR√ÅFICOS SEGUROS
function criarGraficosSeguros() {
  console.log('üé® Criando gr√°ficos seguros...');
  
  try {
    // Gr√°fico 1: Distribui√ß√£o por Tipo
    criarGraficoTipoNCSeguro();
    
    // Gr√°fico 2: Top Ve√≠culos
    criarGraficoTopVeiculosSeguro();
    
    console.log('‚úÖ Gr√°ficos seguros criados');
    
  } catch (error) {
    console.error('‚ùå Erro ao criar gr√°ficos seguros:', error);
    showNotification('‚ùå Erro ao criar gr√°ficos do dashboard', 'error');
  }
}

// 6. GR√ÅFICO DE DISTRIBUI√á√ÉO POR TIPO (SEGURO)
function criarGraficoTipoNCSeguro() {
  const canvas = document.getElementById('chartTipoNC');
  if (!canvas || !window.Chart) return;
  
  if (!ncModule || ncModule.dados.length === 0) {
    canvas.parentElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <div>üì≠</div>
        <div style="margin-top: 10px;">Sem dados para gr√°fico</div>
      </div>
    `;
    return;
  }
  
  try {
    // Contar tipos de NC
    const tiposCount = {};
    ncModule.dados.forEach(nc => {
      const tipo = nc.tipoNC || 'outros';
      tiposCount[tipo] = (tiposCount[tipo] || 0) + 1;
    });
    
    const tiposOrdenados = Object.entries(tiposCount)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);
    
    const labels = tiposOrdenados.map(([tipo, _]) => {
      const nomes = {
        'inicio_sem_ok': 'In√≠cio sem OK',
        'nao_informado': 'N√£o Informado',
        'dados_incorretos': 'Dados Incorretos',
        'movimento_indevido': 'Movimento Indevido',
        'outros': 'Outros'
      };
      return nomes[tipo] || tipo;
    });
    
    const data = tiposOrdenados.map(([_, count]) => count);
    
    new Chart(canvas.getContext('2d'), {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: ['#ff0000', '#2196f3', '#4caf50', '#ff9800', '#9c27b0']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Top 5 Tipos de NC'
          }
        }
      }
    });
    
  } catch (error) {
    console.error('‚ùå Erro no gr√°fico de tipos:', error);
  }
}

// 7. GR√ÅFICO TOP VE√çCULOS (SEGURO)
function criarGraficoTopVeiculosSeguro() {
  const canvas = document.getElementById('chartTopVeiculos');
  if (!canvas || !window.Chart) return;
  
  if (!ncModule || ncModule.dados.length === 0) return;
  
  try {
    // Contar ve√≠culos
    const veiculoCount = {};
    ncModule.dados.forEach(nc => {
      if (nc.veiculo) {
        veiculoCount[nc.veiculo] = (veiculoCount[nc.veiculo] || 0) + 1;
      }
    });
    
    const topVeiculos = Object.entries(veiculoCount)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);
    
    const labels = topVeiculos.map(([veiculo, _]) => veiculo);
    const data = topVeiculos.map(([_, count]) => count);
    
    new Chart(canvas.getContext('2d'), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'NCs',
          data: data,
          backgroundColor: '#2196f3'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Top 5 Ve√≠culos com Mais NCs'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
    
  } catch (error) {
    console.error('‚ùå Erro no gr√°fico de ve√≠culos:', error);
  }
}

// 8. CORRE√á√ÉO DA FUN√á√ÉO updateUIAfterLogin
function corrigirUpdateUIAfterLogin() {
  console.log('üîÑ Corrigindo updateUIAfterLogin...');
  
  const originalUpdateUIAfterLogin = firebaseAuth.updateUIAfterLogin;
  
  firebaseAuth.updateUIAfterLogin = function() {
    console.log('üé® updateUIAfterLogin CORRIGIDO');
    
    // Esconder modal de login
    document.getElementById('loginModal').style.display = 'none';
    
    // Mostrar aplica√ß√£o principal
    document.getElementById('mainContainer').style.display = 'block';
    
    // Verificar se o √≠cone existe antes de mostrar
    const settingsIcon = document.getElementById('settingsIcon');
    if (settingsIcon) {
      settingsIcon.style.display = 'flex';
    }
    
    // Mostrar menu de abas
    const tabMenu = document.getElementById('tabMenu');
    if (tabMenu) {
      tabMenu.style.display = 'flex';
    }
    
    // Atualizar nome do usu√°rio
    const userDisplay = this.currentUser?.email || 'Usu√°rio';
    const userName = this.currentUser?.displayName || userDisplay;
    
    const loggedUserEl = document.getElementById('loggedUser');
    const currentUserInfoEl = document.getElementById('currentUserInfo');
    
    if (loggedUserEl) {
      loggedUserEl.textContent = userName;
    }
    
    if (currentUserInfoEl) {
      currentUserInfoEl.textContent = userDisplay;
    }
    
    // Mostrar/ocultar se√ß√£o admin
    const adminSection = document.getElementById('adminSection');
    if (adminSection) {
      const userRole = this.currentUser?.role || 'VIEWER';
      adminSection.style.display = userRole === 'ADMIN' ? 'block' : 'none';
      console.log(`üëë Se√ß√£o admin: ${adminSection.style.display}`);
    }
    
    // Mostrar badge de role
    this.updateRoleBadge();
    
    // Aplicar corre√ß√µes
    aplicarCorrecaoPermissoes();
    aplicarCorrecaoDashboard();
    
    // Carregar dados do sistema
    setTimeout(() => {
      initializeApp();
    }, 500);
  };
  
  console.log('‚úÖ updateUIAfterLogin corrigido');
}

// 9. INICIALIZAR CORRE√á√ïES QUANDO O SISTEMA CARREGAR
document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ Aplicando corre√ß√µes autom√°ticas...');
  
  // Aplicar corre√ß√µes ap√≥s um breve delay
  setTimeout(() => {
    aplicarCorrecaoPermissoes();
    aplicarCorrecaoDashboard();
    corrigirUpdateUIAfterLogin();
    
    console.log('‚úÖ Todas as corre√ß√µes aplicadas automaticamente');
    
    // Mostrar mensagem para o usu√°rio
    if (typeof showNotification === 'function') {
      showNotification('‚úÖ Sistema otimizado carregado', 'success');
    }
  }, 2000);
});

// ============================================
// üéØ FUN√á√ïES ADICIONAIS DE DIAGN√ìSTICO
// ============================================

// Diagn√≥stico r√°pido do sistema
function diagnosticoRapido() {
  console.log('üîç DIAGN√ìSTICO R√ÅPIDO DO SISTEMA');
  console.log('================================');
  
  const checks = [
    { item: 'Usu√°rio autenticado', status: !!firebaseAuth.currentUser, valor: firebaseAuth.currentUser?.email || 'N√£o' },
    { item: 'Role do usu√°rio', status: !!firebaseAuth.currentUser?.role, valor: firebaseAuth.currentUser?.role || 'N√£o definida' },
    { item: 'NCs carregadas', status: ncModule?.dados?.length > 0, valor: ncModule?.dados?.length || 0 },
    { item: 'Permiss√µes NCs', status: permissionManager?.canAccessNCs?.() || false, valor: permissionManager?.canAccessNCs?.() ? 'Sim' : 'N√ÉO' },
    { item: 'Firebase conectado', status: firebaseService?.isConnected || false, valor: firebaseService?.isConnected ? 'Sim' : 'N√£o' }
  ];
  
  let mensagem = 'üîç DIAGN√ìSTICO DO SISTEMA\n\n';
  checks.forEach(check => {
    const icone = check.status ? '‚úÖ' : '‚ùå';
    mensagem += `${icone} ${check.item}: ${check.valor}\n`;
  });
  
  alert(mensagem);
}

// Bot√£o de diagn√≥stico no header
function adicionarBotaoDiagnostico() {
  const headerControls = document.querySelector('.controls');
  if (!headerControls) return;
  
  const botaoDiagnostico = document.createElement('button');
  botaoDiagnostico.className = 'btn btn-info';
  botaoDiagnostico.innerHTML = '<span>üîç</span> Diagn√≥stico';
  botaoDiagnostico.onclick = diagnosticoRapido;
  botaoDiagnostico.style.marginLeft = '10px';
  
  headerControls.appendChild(botaoDiagnostico);
  console.log('‚úÖ Bot√£o de diagn√≥stico adicionado');
}

// Adicionar bot√£o ap√≥s carregamento
setTimeout(adicionarBotaoDiagnostico, 3000);

console.log('üõ†Ô∏è M√≥dulo de corre√ß√µes carregado com sucesso!');

</body>
</html>
