<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RONDOLOG - Sistema de Checklist</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-black: #000000;
            --primary-red: #ff0000;
            --red-light: #ff6b6b;
            --green: #00c853;
            --green-dark: #009624;
            --yellow: #ffc107;
            --yellow-dark: #ff8f00;
            --orange: #ff9800;
            --orange-dark: #f57c00;
            --gray-light: #f8f9fa;
            --gray-border: #e2e8f0;
            --gray-text: #718096;
            --gray-dark: #2d3748;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
        }

        .dark-mode {
            --bg-primary: #1a1d23;
            --bg-secondary: #252a33;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --border-color: #3a4556;
            
            --green: #48bb78;
            --green-dark: #38a169;
            --yellow: #ecc94b;
            --yellow-dark: #d69e2e;
            --orange: #ed8936;
            --orange-dark: #dd6b20;
            --red-light: #fc8181;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .container {
            max-width: 95%;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            border: 1px solid var(--border-color);
            min-height: 90vh;
            transition: all 0.3s ease;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-black) 0%, #2d2d2d 100%);
            color: white;
            padding: 25px 30px;
            position: relative;
            border-bottom: 4px solid var(--primary-red);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-titles h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .header-subtitle {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 400;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary-red);
            color: white;
        }

        .btn-primary:hover {
            background: #cc0000;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--green);
            color: white;
        }

        .btn-success:hover {
            background: var(--green-dark);
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--yellow);
            color: black;
        }

        .btn-warning:hover {
            background: var(--yellow-dark);
            transform: translateY(-2px);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--primary-red);
            color: white;
        }

        .btn-danger:hover {
            background: #cc0000;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid white;
            color: white;
        }

        .btn-outline:hover {
            background: white;
            color: var(--primary-black);
        }

        .btn-dark-mode {
            background: transparent;
            border: 2px solid white;
            color: white;
            padding: 10px 15px;
        }

        .btn-dark-mode:hover {
            background: white;
            color: var(--primary-black);
        }

        /* Dropdown */
        .export-dropdown {
            position: relative;
            display: inline-block;
            z-index: 1001;
        }

        .export-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-primary);
            min-width: 220px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-radius: 8px;
            z-index: 1000;
            margin-top: 5px;
            border: 1px solid var(--border-color);
        }

        .export-dropdown.active .export-menu {
            display: block;
        }

        .export-option {
            padding: 12px 16px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: background 0.2s;
            color: var(--text-primary);
        }

        .export-option:hover {
            background: var(--bg-secondary);
        }

        /* Status de Salvamento */
        .save-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--green);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        .save-status.saving {
            background: var(--yellow);
            color: black;
        }

        .save-status.error {
            background: var(--primary-red);
            color: white;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: var(--text-primary);
            font-size: 20px;
            border-bottom: 2px solid var(--primary-red);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--primary-red);
            outline: none;
        }

        .form-control.error {
            border-color: var(--primary-red);
        }

        .error-message {
            color: var(--primary-red);
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .btn-cancel {
            background: var(--gray-text);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-cancel:hover {
            background: var(--gray-dark);
        }

        /* Cards de Resumo */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px 30px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .summary-card {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-red);
            transition: all 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .summary-card.valid {
            border-left-color: var(--green);
        }

        .summary-card.expired {
            border-left-color: var(--primary-red);
        }

        .summary-card.warning {
            border-left-color: var(--yellow);
        }

        .summary-card.total {
            border-left-color: var(--gray-dark);
        }

        .card-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .card-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-subtitle {
            font-size: 10px;
            color: var(--gray-text);
            margin-top: 4px;
        }

        /* Filtros */
        .filters {
            padding: 20px 30px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-width: 150px;
            cursor: pointer;
        }

        .filter-input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-width: 150px;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            padding: 10px 20px;
            background: var(--green);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        /* Tabela */
        .table-container {
            overflow-x: auto;
            padding: 20px;
            max-height: 50vh;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-primary);
            min-width: 1000px;
        }

        thead th {
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 12px 8px;
            border-bottom: 3px solid var(--border-color);
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
        }

        thead th:hover {
            background: var(--border-color);
        }

        thead th.sorted-asc::after {
            content: " ‚Üë";
            font-weight: bold;
        }

        thead th.sorted-desc::after {
            content: " ‚Üì";
            font-weight: bold;
        }

        tbody td {
            padding: 12px 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
            color: var(--text-primary);
            transition: background 0.2s ease;
            vertical-align: middle;
        }

        tbody tr {
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background: var(--bg-secondary);
        }

        tbody tr.expiring-soon {
            background: #fff3cd !important;
            border-left: 3px solid var(--yellow);
        }

        tbody tr.expiring-soon:hover {
            background: #ffeaa7 !important;
        }

        tbody tr.expired {
            background: #f8d7da !important;
            border-left: 3px solid var(--primary-red);
        }

        tbody tr.expired:hover {
            background: #f1b0b7 !important;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            min-width: 80px;
        }

        .status-valid {
            background: var(--green);
            color: white;
        }

        .status-invalid {
            background: var(--primary-red);
            color: white;
        }

        .status-expired {
            background: var(--yellow);
            color: black;
        }

        .vehicle-plate {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            font-size: 14px;
            color: var(--text-primary);
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-edit {
            padding: 6px 12px;
            background: var(--yellow);
            color: black;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-edit:hover {
            background: var(--yellow-dark);
        }

        .btn-delete {
            padding: 6px 12px;
            background: var(--primary-red);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-delete:hover {
            background: #cc0000;
        }

        /* Footer */
        .footer {
            background: var(--bg-secondary);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 15px;
        }

        .footer-info {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-primary);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        /* Modo Escuro Espec√≠fico */
        .dark-mode tbody tr {
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .dark-mode tbody tr:hover {
            background: #2d3748 !important;
            transform: translateX(2px);
        }

        .dark-mode tbody tr.expiring-soon {
            background: #2d2a22 !important;
            border-left-color: #ecc94b;
        }

        .dark-mode tbody tr.expiring-soon:hover {
            background: #3d382a !important;
        }

        .dark-mode tbody tr.expired {
            background: #2d2526 !important;
            border-left-color: #fc8181;
        }

        .dark-mode tbody tr.expired:hover {
            background: #3d2c2e !important;
        }

        .dark-mode .status-badge {
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .dark-mode .status-valid {
            background: var(--green);
            color: #1a202c;
        }

        .dark-mode .status-invalid {
            background: #e53e3e;
            color: white;
        }

        .dark-mode .status-expired {
            background: var(--yellow);
            color: #1a202c;
        }

        .dark-mode thead th {
            background: #2d3748;
            color: var(--text-primary);
            border-bottom: 2px solid #4a5568;
        }

        .dark-mode .summary-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .dark-mode .filters {
            background: #252a33;
            border-bottom: 1px solid #3a4556;
        }

        .dark-mode .btn-edit {
            background: #ed8936;
            color: #1a202c;
        }

        .dark-mode .btn-edit:hover {
            background: #dd6b20;
        }

        .dark-mode .btn-delete {
            background: #e53e3e;
            color: white;
        }

        .dark-mode .btn-delete:hover {
            background: #c53030;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .controls {
                justify-content: center;
            }
            
            .summary-cards {
                grid-template-columns: 1fr 1fr;
                padding: 15px 20px;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-select, .filter-input {
                min-width: 100%;
            }
            
            .footer {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-titles">
                    <h1>RONDOLOG - SISTEMA DE GEST√ÉO DE FROTAS</h1>
                    <div class="header-subtitle">Importe, visualize e edite os dados dos ve√≠culos</div>
                </div>
                <div class="controls">
                    <button class="btn btn-dark-mode" id="btnDarkMode">
                        <span>üåô</span> Modo Escuro
                    </button>
                    <label for="fileInput" class="file-input-label">
                        <span>üìÅ</span> Importar Excel
                    </label>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls">
                    
                    <div class="export-dropdown" id="exportDropdown">
                        <button class="btn btn-warning" type="button" id="btnExport">
                            <span>üìä</span> Exportar
                        </button>
                        <div class="export-menu">
                            <button class="export-option" type="button" onclick="exportPDF('current')">
                                <span>üìã</span> PDF - Relat√≥rio Atual
                            </button>
                            <button class="export-option" type="button" onclick="exportPDF('critical')">
                                <span>üö®</span> PDF - Apenas Cr√≠ticos
                            </button>
                            <button class="export-option" type="button" onclick="exportPDF('summary')">
                                <span>üìà</span> PDF - Resumo Executivo
                            </button>
                            <button class="export-option" type="button" onclick="exportXLS('current')">
                                <span>üìä</span> Excel - Relat√≥rio Atual
                            </button>
                            <button class="export-option" type="button" onclick="exportXLS('all')">
                                <span>üíæ</span> Excel - Todos os Dados
                            </button>
                        </div>
                    </div>

                    <!-- üÜï BOT√ÉO: Limpar Duplicados -->
                    <button class="btn btn-danger" id="btnCleanDuplicates" type="button">
                        <span>üßπ</span> Limpar Duplicados
                    </button>
                    
                    <!-- üÜï BOT√ÉO: Padronizar Dados -->
                    <button class="btn btn-info" id="btnStandardizeData" type="button">
                        <span>‚öôÔ∏è</span> Padronizar Dados
                    </button>
                    
                    <button class="btn btn-success" id="btnAddNew" type="button">
                        <span>‚ûï</span> Novo Ve√≠culo
                    </button>

                    <div class="save-status" id="saveStatus">
                        <span>üíæ</span> Dados carregados
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cards de Resumo -->
        <div class="summary-cards" id="summaryCards">
            <div class="summary-card total">
                <div class="card-number" id="totalVehicles">0</div>
                <div class="card-label">Total de Ve√≠culos</div>
                <div class="card-subtitle">Carregados no sistema</div>
            </div>
            <div class="summary-card valid">
                <div class="card-number" id="validVehicles">0</div>
                <div class="card-label">Checklists V√°lidos</div>
                <div class="card-subtitle">Em conformidade</div>
            </div>
            <div class="summary-card warning">
                <div class="card-number" id="warningVehicles">0</div>
                <div class="card-label">Pr√≥ximos do Vencimento</div>
                <div class="card-subtitle">7 dias ou menos</div>
            </div>
            <div class="summary-card expired">
                <div class="card-number" id="expiredVehicles">0</div>
                <div class="card-label">Checklists Vencidos</div>
                <div class="card-subtitle">Fora da validade</div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters">
            <div class="filter-group">
                <div class="filter-label">Filtrar por Status</div>
                <select class="filter-select" id="statusFilter">
                    <option value="all">Todos os Status</option>
                    <option value="valid">V√°lidos</option>
                    <option value="invalid">Inv√°lidos</option>
                    <option value="expired">Vencidos</option>
                    <option value="expiring">Pr√≥ximos do Vencimento</option>
                </select>
            </div>
            <div class="filter-group">
                <div class="filter-label">Filtrar por Motorista</div>
                <select class="filter-select" id="driverFilter">
                    <option value="all">Todos os Motoristas</option>
                </select>
            </div>
            <div class="filter-group">
                <div class="filter-label">Data de Validade</div>
                <input type="date" class="filter-input" id="dateFilter">
            </div>
            <div class="filter-group">
                <div class="filter-label">Busca Inteligente</div>
                <input type="text" class="filter-input" id="searchInput" placeholder="Placa, motorista, dispositivo...">
            </div>
        </div>

        <!-- Tabela -->
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th data-sort="placa">VE√çCULO</th>
                        <th data-sort="status">STATUS</th>
                        <th data-sort="dataRealizacao">DATA REALIZA√á√ÉO</th>
                        <th data-sort="validade">VALIDADE</th>
                        <th data-sort="motorista">MOTORISTA</th>
                        <th data-sort="operador">OPERADOR</th>
                        <th data-sort="dispositivos">DISPOSITIVOS PENDENTES</th>
                        <th>A√á√ïES</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            Importe um arquivo Excel ou adicione um novo ve√≠culo
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-info">
                <div>RONDOLOG - SISTEMA DE GEST√ÉO DE FROTAS</div>
                <div id="lastSaveInfo">√öltimo salvamento: Nunca</div>
            </div>
            <div class="stats">
                <div class="stat-item">
                    <span id="totalCount">0</span> registros carregados
                </div>
                <div class="stat-item">
                    <span id="filteredCount">0</span> filtrados
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o/Adi√ß√£o -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <h3 id="modalTitle">Adicionar Novo Ve√≠culo</h3>
            <form id="editForm">
                <div class="form-group">
                    <label>Placa do Ve√≠culo *</label>
                    <input type="text" class="form-control" id="editPlaca" required aria-label="Placa do ve√≠culo">
                    <div class="error-message" id="placaError">Placa √© obrigat√≥ria</div>
                </div>
                <div class="form-group">
                    <label>Status do Checklist *</label>
                    <select class="form-control" id="editStatus" required aria-label="Status do checklist">
                        <option value="Checklist v√°lido">V√°lido</option>
                        <option value="Checklist inv√°lido">Inv√°lido</option>
                        <option value="Checklist vencido">Vencido</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Data de Realiza√ß√£o *</label>
                    <input type="date" class="form-control" id="editDataRealizacao" required aria-label="Data de realiza√ß√£o">
                    <div class="error-message" id="dataRealizacaoError">Data de realiza√ß√£o √© obrigat√≥ria</div>
                </div>
                <div class="form-group">
                    <label>Data de Validade *</label>
                    <input type="date" class="form-control" id="editValidade" required aria-label="Data de validade">
                    <div class="error-message" id="validadeError">Data de validade √© obrigat√≥ria e deve ser posterior √† data de realiza√ß√£o</div>
                </div>
                <div class="form-group">
                    <label>Motorista *</label>
                    <input type="text" class="form-control" id="editMotorista" required aria-label="Nome do motorista">
                    <div class="error-message" id="motoristaError">Motorista √© obrigat√≥rio</div>
                </div>
                <div class="form-group">
                    <label>Operador *</label>
                    <input type="text" class="form-control" id="editOperador" required aria-label="Nome do operador">
                    <div class="error-message" id="operadorError">Operador √© obrigat√≥rio</div>
                </div>
                <div class="form-group">
                    <label>Dispositivos Pendentes</label>
                    <textarea class="form-control" id="editDispositivos" rows="3" placeholder="Lista de dispositivos com problemas..." aria-label="Dispositivos pendentes de manuten√ß√£o"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" id="btnCancelModal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar Ve√≠culo</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        window.vehicleData = [];
        let currentSort = { column: null, direction: 'asc' };
        let currentEditIndex = -1;
        let isAddingNew = false;
        let autoSaveInterval;
        let lastSaveTime = null;

        // Elementos DOM
        const btnDarkMode = document.getElementById('btnDarkMode');
        const fileInput = document.getElementById('fileInput');
        const btnAddNew = document.getElementById('btnAddNew');
        const btnExport = document.getElementById('btnExport');
        const btnCleanDuplicates = document.getElementById('btnCleanDuplicates');
        const btnStandardizeData = document.getElementById('btnStandardizeData');
        const statusFilter = document.getElementById('statusFilter');
        const driverFilter = document.getElementById('driverFilter');
        const dateFilter = document.getElementById('dateFilter');
        const searchInput = document.getElementById('searchInput');
        const tableBody = document.getElementById('tableBody');
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const modalTitle = document.getElementById('modalTitle');
        const btnCancelModal = document.getElementById('btnCancelModal');
        const saveStatus = document.getElementById('saveStatus');
        const lastSaveInfo = document.getElementById('lastSaveInfo');
        const totalVehicles = document.getElementById('totalVehicles');
        const validVehicles = document.getElementById('validVehicles');
        const warningVehicles = document.getElementById('warningVehicles');
        const expiredVehicles = document.getElementById('expiredVehicles');
        const totalCount = document.getElementById('totalCount');
        const filteredCount = document.getElementById('filteredCount');
        const exportDropdown = document.getElementById('exportDropdown');

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            loadFromLocalStorage();
            setupEventListeners();
            setupSorting();
            setupExportDropdown();
            startAutoSave();
            updateSaveStatus();
        });

        // üÜï FUN√á√ÉO: Padroniza√ß√£o Inteligente de Dados
        function standardizeData() {
            if (window.vehicleData.length === 0) {
                alert('N√£o h√° dados para padronizar!');
                return;
            }

            const originalCount = window.vehicleData.length;
            let changesMade = 0;

            window.vehicleData = window.vehicleData.map(vehicle => {
                const standardized = { ...vehicle };
                
                // 1. Corrigir status inconsistentes (vencido com validade futura)
                if (standardized.status.includes('vencido') && !isExpired(standardized.validade)) {
                    standardized.status = 'Checklist v√°lido';
                    changesMade++;
                    console.log(`Corrigido status: ${vehicle.placa} de "vencido" para "v√°lido"`);
                }

                // 2. Padronizar motoristas gen√©ricos
                const genericDrivers = ['Condutor', '-', '--', '00', 'condutor', 'cONDUTOR'];
                if (genericDrivers.includes(standardized.motorista)) {
                    standardized.motorista = 'Motorista N√£o Identificado';
                    changesMade++;
                }

                // 3. Padronizar operadores gen√©ricos
                if (!standardized.operador || standardized.operador === '-' || standardized.operador === '--') {
                    standardized.operador = 'Operador N√£o Identificado';
                    changesMade++;
                }

                // 4. Padronizar dispositivos pendentes
                if (standardized.dispositivos) {
                    const originalDevices = standardized.dispositivos;
                    
                    // Converter para mai√∫sculas
                    standardized.dispositivos = standardized.dispositivos.toUpperCase();
                    
                    // Padronizar termos
                    standardized.dispositivos = standardized.dispositivos
                        .replace(/SENSOR DE PORTA DE CARONA/gi, 'SENSOR_PORTA_CARONA')
                        .replace(/SENSOR DE PORTA DE MOTORISTA/gi, 'SENSOR_PORTA_MOTORISTA')
                        .replace(/SENSOR DE BAU TRASEIRO/gi, 'SENSOR_BAU_TRASEIRO')
                        .replace(/TRAVA DE BAU TRASEIRA/gi, 'TRAVA_BAU_TRASEIRA')
                        .replace(/SENSOR DE DESENGATE/gi, 'SENSOR_DESENGATE')
                        .replace(/BOTAO DE PANICO/gi, 'BOTAO_PANICO')
                        .replace(/GPS/gi, 'GPS');
                    
                    if (originalDevices !== standardized.dispositivos) {
                        changesMade++;
                    }
                }

                // 5. Validar e corrigir datas inconsistentes
                if (standardized.dataRealizacao && standardized.validade) {
                    const realizacao = new Date(standardized.dataRealizacao);
                    const validade = new Date(standardized.validade);
                    
                    if (validade <= realizacao) {
                        // Se validade √© anterior √† realiza√ß√£o, ajustar para 30 dias depois
                        const newValidade = new Date(realizacao);
                        newValidade.setDate(newValidade.getDate() + 30);
                        standardized.validade = newValidade.toISOString().split('T')[0];
                        changesMade++;
                        console.log(`Corrigida validade: ${vehicle.placa} para ${standardized.validade}`);
                    }
                }

                return standardized;
            });

            // 6. Remover ve√≠culos sem placa
            const beforeRemove = window.vehicleData.length;
            window.vehicleData = window.vehicleData.filter(vehicle => 
                vehicle.placa && vehicle.placa.trim() !== ''
            );
            const removedCount = beforeRemove - window.vehicleData.length;
            changesMade += removedCount;

            // Atualizar interface
            renderTable();
            updateDriverFilter();
            updateSummaryCards();
            saveToLocalStorage();
            
            alert(`Padroniza√ß√£o conclu√≠da!\n\nRegistros processados: ${originalCount}\nAltera√ß√µes realizadas: ${changesMade}\nRegistros sem placa removidos: ${removedCount}`);
        }

        // üÜï FUN√á√ÉO: Limpar Duplicados Inteligente
        function cleanDuplicates() {
            if (window.vehicleData.length === 0) {
                alert('N√£o h√° dados para limpar!');
                return;
            }

            const originalCount = window.vehicleData.length;
            
            // Agrupar por placa
            const groupedByPlaca = {};
            
            window.vehicleData.forEach(vehicle => {
                if (!groupedByPlaca[vehicle.placa]) {
                    groupedByPlaca[vehicle.placa] = [];
                }
                groupedByPlaca[vehicle.placa].push(vehicle);
            });

            // Para cada placa, manter apenas o registro mais recente
            const cleanedData = [];
            let duplicatesRemoved = 0;

            Object.keys(groupedByPlaca).forEach(placa => {
                const vehicles = groupedByPlaca[placa];
                
                if (vehicles.length > 1) {
                    // Ordenar por data de realiza√ß√£o (mais recente primeiro)
                    vehicles.sort((a, b) => {
                        const dateA = new Date(a.dataRealizacao);
                        const dateB = new Date(b.dataRealizacao);
                        return dateB - dateA;
                    });
                    
                    // Manter apenas o mais recente
                    cleanedData.push(vehicles[0]);
                    duplicatesRemoved += vehicles.length - 1;
                    
                    console.log(`Placa ${placa}: ${vehicles.length} registros -> mantido o mais recente de ${vehicles[0].dataRealizacao}`);
                } else {
                    cleanedData.push(vehicles[0]);
                }
            });

            window.vehicleData = cleanedData;
            
            // Atualizar interface
            renderTable();
            updateDriverFilter();
            updateSummaryCards();
            saveToLocalStorage();
            
            alert(`Limpeza conclu√≠da!\n\nRegistros antes: ${originalCount}\nRegistros depois: ${window.vehicleData.length}\nDuplicados removidos: ${duplicatesRemoved}`);
        }

        // Configura√ß√£o do dropdown de exporta√ß√£o
        function setupExportDropdown() {
            btnExport.addEventListener('click', function(e) {
                e.stopPropagation();
                exportDropdown.classList.toggle('active');
            });

            exportDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });

            document.addEventListener('click', function() {
                exportDropdown.classList.remove('active');
            });

            const exportOptions = document.querySelectorAll('.export-option');
            exportOptions.forEach(option => {
                option.addEventListener('click', function() {
                    exportDropdown.classList.remove('active');
                });
            });
        }

        // Fun√ß√µes de Modal
        function openAddModal() {
            isAddingNew = true;
            currentEditIndex = -1;
            modalTitle.textContent = 'Adicionar Novo Ve√≠culo';
            clearEditForm();
            editModal.style.display = 'flex';
        }

        function openEditModal(index) {
            isAddingNew = false;
            currentEditIndex = index;
            const vehicle = window.vehicleData[index];

            modalTitle.textContent = 'Editar Ve√≠culo';
            document.getElementById('editPlaca').value = vehicle.placa;
            document.getElementById('editStatus').value = vehicle.status;
            document.getElementById('editDataRealizacao').value = formatDateForInput(vehicle.dataRealizacao);
            document.getElementById('editValidade').value = formatDateForInput(vehicle.validade);
            document.getElementById('editMotorista').value = vehicle.motorista;
            document.getElementById('editOperador').value = vehicle.operador;
            document.getElementById('editDispositivos').value = vehicle.dispositivos || '';

            editModal.style.display = 'flex';
        }

        function clearEditForm() {
            document.getElementById('editPlaca').value = '';
            document.getElementById('editStatus').value = 'Checklist v√°lido';
            document.getElementById('editDataRealizacao').value = '';
            document.getElementById('editValidade').value = '';
            document.getElementById('editMotorista').value = '';
            document.getElementById('editOperador').value = '';
            document.getElementById('editDispositivos').value = '';
            
            // Limpar erros
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.form-control').forEach(el => {
                el.classList.remove('error');
            });
        }

        function closeEditModal() {
            editModal.style.display = 'none';
        }

        // Valida√ß√£o de datas
        function validateDates(dataRealizacao, validade) {
            if (!dataRealizacao || !validade) {
                return false;
            }
            
            const realizacao = new Date(dataRealizacao);
            const validadeDate = new Date(validade);
            
            // Verificar se a data de validade √© posterior √† data de realiza√ß√£o
            if (validadeDate <= realizacao) {
                document.getElementById('validadeError').style.display = 'block';
                document.getElementById('editValidade').classList.add('error');
                return false;
            }
            
            document.getElementById('validadeError').style.display = 'none';
            document.getElementById('editValidade').classList.remove('error');
            return true;
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            
            // Validar campos obrigat√≥rios
            const placa = document.getElementById('editPlaca').value;
            const dataRealizacao = document.getElementById('editDataRealizacao').value;
            const validade = document.getElementById('editValidade').value;
            const motorista = document.getElementById('editMotorista').value;
            const operador = document.getElementById('editOperador').value;
            
            let isValid = true;
            
            if (!placa) {
                document.getElementById('placaError').style.display = 'block';
                document.getElementById('editPlaca').classList.add('error');
                isValid = false;
            } else {
                document.getElementById('placaError').style.display = 'none';
                document.getElementById('editPlaca').classList.remove('error');
            }
            
            if (!dataRealizacao) {
                document.getElementById('dataRealizacaoError').style.display = 'block';
                document.getElementById('editDataRealizacao').classList.add('error');
                isValid = false;
            } else {
                document.getElementById('dataRealizacaoError').style.display = 'none';
                document.getElementById('editDataRealizacao').classList.remove('error');
            }
            
            if (!validade) {
                document.getElementById('validadeError').style.display = 'block';
                document.getElementById('editValidade').classList.add('error');
                isValid = false;
            } else {
                document.getElementById('validadeError').style.display = 'none';
                document.getElementById('editValidade').classList.remove('error');
            }
            
            if (!motorista) {
                document.getElementById('motoristaError').style.display = 'block';
                document.getElementById('editMotorista').classList.add('error');
                isValid = false;
            } else {
                document.getElementById('motoristaError').style.display = 'none';
                document.getElementById('editMotorista').classList.remove('error');
            }
            
            if (!operador) {
                document.getElementById('operadorError').style.display = 'block';
                document.getElementById('editOperador').classList.add('error');
                isValid = false;
            } else {
                document.getElementById('operadorError').style.display = 'none';
                document.getElementById('editOperador').classList.remove('error');
            }
            
            // Validar l√≥gica das datas
            if (!validateDates(dataRealizacao, validade)) {
                isValid = false;
            }
            
            if (!isValid) {
                return;
            }
            
            const newVehicle = {
                placa: placa,
                status: document.getElementById('editStatus').value,
                dataRealizacao: dataRealizacao,
                validade: validade,
                motorista: motorista,
                operador: operador,
                dispositivos: document.getElementById('editDispositivos').value
            };

            if (isAddingNew) {
                window.vehicleData.push(newVehicle);
            } else {
                window.vehicleData[currentEditIndex] = newVehicle;
            }

            renderTable();
            filterData();
            updateDriverFilter();
            updateSummaryCards();
            saveToLocalStorage();
            closeEditModal();
            
            alert(isAddingNew ? 'Ve√≠culo adicionado com sucesso!' : 'Dados atualizados com sucesso!');
        }

        // Fun√ß√£o de filtro
        function filterData() {
            const filteredData = getFilteredData();
            renderTable(filteredData);
        }

        function getFilteredData() {
            const statusValue = statusFilter.value;
            const driverValue = driverFilter.value;
            const dateValue = dateFilter.value;
            const searchValue = searchInput.value.trim().toLowerCase();

            return window.vehicleData.filter(vehicle => {
                // Filtro por status
                let statusMatch = true;
                if (statusValue !== 'all') {
                    switch(statusValue) {
                        case 'valid':
                            statusMatch = vehicle.status.includes('v√°lido');
                            break;
                        case 'invalid':
                            statusMatch = vehicle.status.includes('inv√°lido');
                            break;
                        case 'expired':
                            statusMatch = vehicle.status.includes('vencido') || isExpired(vehicle.validade);
                            break;
                        case 'expiring':
                            statusMatch = isExpiringSoon(vehicle.validade);
                            break;
                    }
                }

                // Filtro por motorista
                const driverMatch = driverValue === 'all' || vehicle.motorista === driverValue;
                
                // Filtro por data
                const dateMatch = !dateValue || vehicle.validade === dateValue;
                
                // Busca inteligente
                const searchMatch = !searchValue || 
                    vehicle.placa.toLowerCase().includes(searchValue) ||
                    vehicle.motorista.toLowerCase().includes(searchValue) ||
                    vehicle.operador.toLowerCase().includes(searchValue) ||
                    (vehicle.dispositivos && vehicle.dispositivos.toLowerCase().includes(searchValue)) ||
                    vehicle.status.toLowerCase().includes(searchValue);

                return statusMatch && driverMatch && dateMatch && searchMatch;
            });
        }

        function getCriticalData() {
            return window.vehicleData.filter(vehicle => 
                vehicle.status.includes('vencido') || 
                isExpiringSoon(vehicle.validade) ||
                (vehicle.dispositivos && vehicle.dispositivos !== '')
            );
        }

        // Fun√ß√µes de salvamento autom√°tico
        function startAutoSave() {
            autoSaveInterval = setInterval(() => {
                if (window.vehicleData.length > 0) {
                    saveToLocalStorage();
                }
            }, 30000);
        }

        function saveToLocalStorage() {
            try {
                showSaveStatus('saving');
                
                localStorage.setItem('rondolog_vehicle_data', JSON.stringify(window.vehicleData));
                
                const saveInfo = {
                    lastSave: new Date().toISOString(),
                    totalRecords: window.vehicleData.length,
                    version: '1.0'
                };
                localStorage.setItem('rondolog_save_info', JSON.stringify(saveInfo));
                
                lastSaveTime = new Date();
                updateSaveStatus();
                
                setTimeout(() => showSaveStatus('saved'), 1000);
                
            } catch (error) {
                console.error('Erro ao salvar:', error);
                showSaveStatus('error');
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('rondolog_vehicle_data');
                const saveInfo = localStorage.getItem('rondolog_save_info');
                
                if (savedData) {
                    window.vehicleData = JSON.parse(savedData);
                    
                    if (saveInfo) {
                        const info = JSON.parse(saveInfo);
                        lastSaveTime = new Date(info.lastSave);
                        updateSaveStatus();
                    }
                    
                    if (window.vehicleData.length > 0) {
                        updateDriverFilter();
                        renderTable();
                        updateSummaryCards();
                        showSaveStatus('loaded');
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar dados salvos:', error);
                showSaveStatus('error');
            }
        }

        function showSaveStatus(status) {
            const statusMap = {
                saving: { text: 'Salvando...', className: 'saving' },
                saved: { text: 'Salvo!', className: '' },
                loaded: { text: 'Dados carregados', className: '' },
                error: { text: 'Erro ao salvar', className: 'error' }
            };
            
            const currentStatus = statusMap[status];
            saveStatus.innerHTML = `<span>üíæ</span> ${currentStatus.text}`;
            saveStatus.className = `save-status ${currentStatus.className}`;
            
            if (status === 'saved' || status === 'loaded') {
                setTimeout(() => {
                    saveStatus.style.opacity = '0.7';
                }, 2000);
            }
        }

        function updateSaveStatus() {
            if (lastSaveTime) {
                const now = new Date();
                const diff = Math.floor((now - lastSaveTime) / 1000);
                
                let text = '';
                if (diff < 60) {
                    text = `Salvamento: ${diff} segundos atr√°s`;
                } else if (diff < 3600) {
                    text = `Salvamento: ${Math.floor(diff / 60)} minutos atr√°s`;
                } else {
                    text = `Salvamento: ${lastSaveTime.toLocaleString('pt-BR')}`;
                }
                
                lastSaveInfo.textContent = text;
            }
        }

        function setupEventListeners() {
            btnDarkMode.addEventListener('click', toggleDarkMode);
            fileInput.addEventListener('change', handleFileImport);
            btnAddNew.addEventListener('click', openAddModal);
            btnCleanDuplicates.addEventListener('click', cleanDuplicates);
            btnStandardizeData.addEventListener('click', standardizeData);
            
            statusFilter.addEventListener('change', filterData);
            driverFilter.addEventListener('change', filterData);
            dateFilter.addEventListener('change', filterData);
            searchInput.addEventListener('input', filterData);
            
            btnCancelModal.addEventListener('click', closeEditModal);
            editForm.addEventListener('submit', handleFormSubmit);
            
            // Valida√ß√£o em tempo real das datas
            document.getElementById('editDataRealizacao').addEventListener('change', function() {
                const validade = document.getElementById('editValidade').value;
                if (validade) {
                    validateDates(this.value, validade);
                }
            });
            
            document.getElementById('editValidade').addEventListener('change', function() {
                const dataRealizacao = document.getElementById('editDataRealizacao').value;
                if (dataRealizacao) {
                    validateDates(dataRealizacao, this.value);
                }
            });
            
            window.addEventListener('click', function(e) {
                if (e.target === editModal) {
                    closeEditModal();
                }
            });

            window.addEventListener('beforeunload', () => {
                if (window.vehicleData.length > 0) {
                    saveToLocalStorage();
                }
            });
        }

        // Fun√ß√£o de exporta√ß√£o Excel
        function exportXLS(type) {
            let dataToExport = [];
            let filename = '';

            switch(type) {
                case 'current':
                    dataToExport = getFilteredData();
                    filename = `relatorio_atual_${new Date().toISOString().split('T')[0]}.xlsx`;
                    break;
                case 'all':
                    dataToExport = window.vehicleData;
                    filename = `todos_dados_${new Date().toISOString().split('T')[0]}.xlsx`;
                    break;
            }

            if (dataToExport.length === 0) {
                alert('Nenhum dado para exportar!');
                return;
            }

            const excelData = dataToExport.map(vehicle => ({
                'VE√çCULO': vehicle.placa,
                'STATUS': vehicle.status,
                'DATA REALIZA√á√ÉO': formatDate(vehicle.dataRealizacao),
                'VALIDADE': formatDate(vehicle.validade),
                'MOTORISTA': vehicle.motorista,
                'OPERADOR': vehicle.operador,
                'DISPOSITIVOS PENDENTES': vehicle.dispositivos || ''
            }));

            const worksheet = XLSX.utils.json_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Checklist');

            const colWidths = [
                { wch: 12 }, { wch: 18 }, { wch: 16 }, 
                { wch: 12 }, { wch: 20 }, { wch: 15 }, { wch: 30 }
            ];
            worksheet['!cols'] = colWidths;

            XLSX.writeFile(workbook, filename);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            btnDarkMode.innerHTML = document.body.classList.contains('dark-mode') 
                ? '<span>‚òÄÔ∏è</span> Modo Claro' 
                : '<span>üåô</span> Modo Escuro';
        }

        function handleFileImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                window.vehicleData = [];
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row && row.length >= 7 && row[0]) {
                        const newVehicle = {
                            placa: row[0] || '',
                            status: row[1] || '',
                            dataRealizacao: parseExcelDate(row[2]),
                            validade: parseExcelDate(row[3]),
                            motorista: row[4] || '',
                            operador: row[5] || '',
                            dispositivos: row[6] || ''
                        };
                        
                        // Validar datas ao importar
                        if (newVehicle.dataRealizacao && newVehicle.validade) {
                            const realizacao = new Date(newVehicle.dataRealizacao);
                            const validade = new Date(newVehicle.validade);
                            
                            if (validade > realizacao) {
                                window.vehicleData.push(newVehicle);
                            } else {
                                console.warn(`Ve√≠culo ${newVehicle.placa} ignorado: datas inconsistentes`);
                            }
                        } else {
                            window.vehicleData.push(newVehicle);
                        }
                    }
                }

                updateDriverFilter();
                renderTable();
                updateSummaryCards();
                saveToLocalStorage();
                alert(`Importa√ß√£o conclu√≠da! ${window.vehicleData.length} ve√≠culos carregados.`);
            };
            reader.readAsArrayBuffer(file);
        }

        function parseExcelDate(dateValue) {
            if (!dateValue) return '';
            if (typeof dateValue === 'string') return dateValue;
            if (typeof dateValue === 'number') {
                const date = new Date((dateValue - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            return dateValue;
        }

        function updateSummaryCards() {
            const total = window.vehicleData.length;
            const valid = window.vehicleData.filter(v => v.status.includes('v√°lido')).length;
            const expired = window.vehicleData.filter(v => v.status.includes('vencido') || isExpired(v.validade)).length;
            
            const today = new Date();
            const warning = window.vehicleData.filter(v => {
                return isExpiringSoon(v.validade);
            }).length;

            totalVehicles.textContent = total;
            validVehicles.textContent = valid;
            warningVehicles.textContent = warning;
            expiredVehicles.textContent = expired;
        }

        function setupSorting() {
            const headers = document.querySelectorAll('thead th[data-sort]');
            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.getAttribute('data-sort');
                    
                    headers.forEach(h => {
                        if (h !== header) {
                            h.classList.remove('sorted-asc', 'sorted-desc');
                        }
                    });

                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'asc';
                    }

                    header.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                    sortData(column, currentSort.direction);
                    renderTable();
                });
            });
        }

        function sortData(column, direction) {
            window.vehicleData.sort((a, b) => {
                let aValue = a[column];
                let bValue = b[column];

                if (column === 'dataRealizacao' || column === 'validade') {
                    aValue = aValue ? new Date(aValue) : new Date(0);
                    bValue = bValue ? new Date(bValue) : new Date(0);
                }

                if (typeof aValue === 'string') {
                    aValue = aValue.toLowerCase();
                    bValue = bValue.toLowerCase();
                }

                if (aValue < bValue) return direction === 'asc' ? -1 : 1;
                if (aValue > bValue) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function isExpiringSoon(validade) {
            if (!validade || validade === 'No embarque') return false;
            const today = new Date();
            const validadeDate = new Date(validade);
            const diffTime = validadeDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= 7 && diffDays > 0;
        }

        function isExpired(validade) {
            if (!validade || validade === 'No embarque') return false;
            const today = new Date();
            const validadeDate = new Date(validade);
            return validadeDate < today;
        }

        function renderTable(filteredData = null) {
            const dataToRender = filteredData || window.vehicleData;
            
            if (dataToRender.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-secondary);">Nenhum dado encontrado</td></tr>';
                return;
            }

            tableBody.innerHTML = dataToRender.map((vehicle, index) => {
                const statusClass = getStatusClass(vehicle.status, vehicle.validade);
                let rowClass = '';
                
                if (isExpired(vehicle.validade)) {
                    rowClass = 'expired';
                } else if (isExpiringSoon(vehicle.validade)) {
                    rowClass = 'expiring-soon';
                }

                // Encontrar o √≠ndice real no array original
                const originalIndex = window.vehicleData.findIndex(v => 
                    v.placa === vehicle.placa && 
                    v.motorista === vehicle.motorista &&
                    v.validade === vehicle.validade
                );

                return `
                    <tr class="${rowClass}">
                        <td><span class="vehicle-plate">${vehicle.placa}</span></td>
                        <td><span class="status-badge ${statusClass}">${vehicle.status}</span></td>
                        <td>${formatDate(vehicle.dataRealizacao)}</td>
                        <td>${formatDate(vehicle.validade)}</td>
                        <td>${vehicle.motorista}</td>
                        <td>${vehicle.operador}</td>
                        <td>${vehicle.dispositivos || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-edit" onclick="openEditModal(${originalIndex})" aria-label="Editar ve√≠culo ${vehicle.placa}">Editar</button>
                                <button class="btn-delete" onclick="openDeleteModal(${originalIndex})" aria-label="Excluir ve√≠culo ${vehicle.placa}">Excluir</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            totalCount.textContent = window.vehicleData.length;
            filteredCount.textContent = dataToRender.length;
        }

        function getStatusClass(status, validade) {
            if (isExpired(validade)) return 'status-expired';
            if (status.includes('v√°lido')) return 'status-valid';
            if (status.includes('inv√°lido')) return 'status-invalid';
            if (status.includes('vencido')) return 'status-expired';
            return 'status-valid';
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            if (dateString === 'No embarque') return dateString;
            try {
                const date = new Date(dateString);
                return isNaN(date.getTime()) ? dateString : date.toLocaleDateString('pt-BR');
            } catch {
                return dateString;
            }
        }

        function formatDateForInput(dateString) {
            if (!dateString || dateString === 'No embarque') return '';
            try {
                const date = new Date(dateString);
                return isNaN(date.getTime()) ? '' : date.toISOString().split('T')[0];
            } catch {
                return '';
            }
        }

        function updateDriverFilter() {
            const drivers = [...new Set(window.vehicleData.map(item => item.motorista).filter(Boolean))];
            driverFilter.innerHTML = '<option value="all">Todos os Motoristas</option>';
            drivers.forEach(driver => {
                driverFilter.innerHTML += `<option value="${driver}">${driver}</option>`;
            });
        }

        function openDeleteModal(index) {
            if (confirm(`Excluir ve√≠culo ${window.vehicleData[index].placa}?`)) {
                window.vehicleData.splice(index, 1);
                renderTable();
                updateSummaryCards();
                filterData();
                saveToLocalStorage();
            }
        }

        // Fun√ß√µes de exporta√ß√£o PDF
        function exportPDF(type) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.setTextColor(40, 40, 40);
            doc.text('RONDOLOG - RELAT√ìRIO DE CHECKLIST', 105, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, 22, { align: 'center' });
            
            let dataToExport = [];
            let title = '';

            switch(type) {
                case 'current':
                    dataToExport = getFilteredData();
                    title = 'RELAT√ìRIO ATUAL (COM FILTROS APLICADOS)';
                    break;
                case 'critical':
                    dataToExport = getCriticalData();
                    title = 'RELAT√ìRIO DE SITUA√á√ïES CR√çTICAS';
                    break;
                case 'summary':
                    generateSummaryPDF(doc);
                    return;
            }

            if (dataToExport.length === 0) {
                doc.text('Nenhum dado para exportar', 20, 40);
            } else {
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text(title, 20, 35);
                
                const tableData = dataToExport.map(vehicle => [
                    vehicle.placa,
                    vehicle.status,
                    formatDate(vehicle.dataRealizacao),
                    formatDate(vehicle.validade),
                    vehicle.motorista,
                    vehicle.operador,
                    vehicle.dispositivos || '-'
                ]);

                doc.autoTable({
                    startY: 45,
                    head: [['VE√çCULO', 'STATUS', 'DATA REALIZA√á√ÉO', 'VALIDADE', 'MOTORISTA', 'OPERADOR', 'DISPOSITIVOS']],
                    body: tableData,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [0, 0, 0] },
                    columnStyles: {
                        0: { cellWidth: 25 },
                        1: { cellWidth: 25 },
                        2: { cellWidth: 25 },
                        3: { cellWidth: 25 },
                        4: { cellWidth: 25 },
                        5: { cellWidth: 25 },
                        6: { cellWidth: 40 }
                    }
                });
            }

            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text(`P√°gina ${i} de ${pageCount} - RONDOLOG Sistema de Gest√£o`, 105, 285, { align: 'center' });
            }

            doc.save(`relatorio_checklist_${type}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function generateSummaryPDF(doc) {
            const total = window.vehicleData.length;
            const valid = window.vehicleData.filter(v => v.status.includes('v√°lido')).length;
            const expired = window.vehicleData.filter(v => v.status.includes('vencido') || isExpired(v.validade)).length;
            const warning = window.vehicleData.filter(v => isExpiringSoon(v.validade)).length;
            
            const percentValid = total > 0 ? ((valid / total) * 100).toFixed(1) : 0;
            const percentExpired = total > 0 ? ((expired / total) * 100).toFixed(1) : 0;

            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('RESUMO EXECUTIVO - SITUA√á√ÉO DA FROTA', 20, 35);

            doc.setFontSize(10);
            doc.text(`Total de Ve√≠culos: ${total}`, 20, 50);
            doc.text(`Checklists V√°lidos: ${valid} (${percentValid}%)`, 20, 60);
            doc.text(`Pr√≥ximos do Vencimento: ${warning}`, 20, 70);
            doc.text(`Checklists Vencidos: ${expired} (${percentExpired}%)`, 20, 80);

            const criticalVehicles = getCriticalData();
            if (criticalVehicles.length > 0) {
                doc.setFontSize(14);
                doc.text('ALERTAS PRIORIT√ÅRIOS:', 20, 100);
                
                let yPosition = 110;
                criticalVehicles.slice(0, 10).forEach((vehicle, index) => {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`${vehicle.placa} - ${vehicle.motorista}`, 25, yPosition);
                    
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    
                    let statusText = '';
                    if (vehicle.status.includes('vencido') || isExpired(vehicle.validade)) {
                        statusText = 'VENCIDO';
                        doc.setTextColor(255, 0, 0);
                    } else if (isExpiringSoon(vehicle.validade)) {
                        statusText = 'VENCE EM BREVE';
                        doc.setTextColor(255, 165, 0);
                    } else if (vehicle.dispositivos) {
                        statusText = 'COM PROBLEMAS';
                        doc.setTextColor(255, 0, 0);
                    }
                    
                    doc.text(statusText, 80, yPosition);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Validade: ${formatDate(vehicle.validade)}`, 120, yPosition);
                    
                    if (vehicle.dispositivos) {
                        yPosition += 5;
                        doc.text(`Problemas: ${vehicle.dispositivos}`, 25, yPosition);
                    }
                    
                    yPosition += 10;
                });
            }

            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text(`P√°gina ${i} de ${pageCount} - RONDOLOG Sistema de Gest√£o`, 105, 285, { align: 'center' });
            }

            doc.save(`resumo_executivo_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // Fun√ß√µes globais
        window.openEditModal = openEditModal;
        window.openDeleteModal = openDeleteModal;
        window.exportPDF = exportPDF;
        window.exportXLS = exportXLS;
        window.filterData = filterData;
        window.cleanDuplicates = cleanDuplicates;
        window.standardizeData = standardizeData;
    </script>
</body>
</html>
